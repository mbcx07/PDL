<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Perfil de Dinámicas Laborales (PDL)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --imss:#006657; --imss2:#134E39; --soft:#e6f2ef;
      --gold:#BC955C; --bg:#f5f7f6; --text:#222; --muted:#6b6f6d; --danger:#c62828;
      --shadow:0 2px 8px rgba(0,0,0,.08); --r:12px;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;}
    body{margin:0;background:var(--bg);color:var(--text);}
    header{background:#fff;box-shadow:var(--shadow);padding:.8rem 1.2rem;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:10;}
    header h1{margin:0;font-size:1.05rem;font-weight:900;color:var(--imss2);}
    header nav a{margin-left:1rem;text-decoration:none;font-size:.92rem;color:var(--imss);cursor:pointer;font-weight:700;}
    header nav a:hover{text-decoration:underline;}
    main{max-width:1100px;margin:1.4rem auto 2.6rem;padding:0 1rem;}
    .card{background:#fff;border-radius:var(--r);box-shadow:var(--shadow);padding:1.25rem 1.35rem;margin-bottom:1.25rem;}
    h2{margin:0 0 .55rem;font-size:1.22rem;color:var(--imss2);}
    h3{margin:1rem 0 .4rem;font-size:1.05rem;color:var(--imss2);}
    .subtitle{margin:.2rem 0 .95rem;color:var(--muted);font-size:.92rem;}
    .pill{display:inline-block;padding:.15rem .6rem;border-radius:999px;font-size:.75rem;background:var(--soft);color:var(--imss2);margin-left:.4rem;font-weight:800;}
    .badge{display:inline-block;padding:.18rem .55rem;border-radius:999px;background:var(--gold);color:#fff;font-size:.78rem;font-weight:900;}
    .hidden{display:none!important;}
    .text-muted{color:var(--muted);font-size:.86rem;}
    .error{color:var(--danger);font-size:.82rem;margin-top:.25rem;font-weight:700;}
    .ok{border:1px solid #cfe7df;background:#f4fffb;color:#0f5132;border-radius:12px;padding:.65rem .8rem;margin:.65rem 0;}
    .warn{border:1px solid #f0d3b2;background:#fff7ee;color:#7a4a12;border-radius:12px;padding:.65rem .8rem;margin:.65rem 0;}

    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:.85rem 1rem;}
    label{display:block;font-weight:800;font-size:.8rem;margin-bottom:.2rem;color:#2b2e2d;}
    input,select,textarea{width:100%;padding:.5rem .6rem;border-radius:8px;border:1px solid #cfd4d1;font-size:.94rem;background:#fff;}
    input:focus,select:focus,textarea:focus{outline:2px solid var(--soft);border-color:var(--imss);}

    .btn-row{margin-top:1rem;display:flex;flex-wrap:wrap;gap:.6rem;}
    button{border:none;border-radius:10px;padding:.55rem .98rem;font-size:.93rem;cursor:pointer;font-weight:800;}
    .btn-primary{background:var(--imss);color:#fff;}
    .btn-secondary{background:#e0e4e2;color:#333;}
    .btn-danger{background:var(--danger);color:#fff;}
    .btn-success{background:var(--imss2);color:#fff;}
    .btn-link{background:transparent;color:var(--imss);padding-left:0;}
    .btn-disabled{background:#cfd4d1!important;color:#888!important;cursor:default!important;opacity:.8;}

    /* Test UI */
    .block-header{display:flex;justify-content:space-between;align-items:center;gap:.6rem;flex-wrap:wrap;color:var(--muted);font-size:.9rem;margin-bottom:.55rem;}
    .progress-wrap{display:flex;align-items:center;gap:.5rem;min-width:200px;}
    .bar{background:#dde3df;border-radius:999px;height:8px;flex:1;overflow:hidden;}
    .bar>div{height:100%;width:0%;background:var(--imss);transition:width .2s ease;}
    .pct{min-width:40px;text-align:right;font-size:.84rem;font-weight:800;}
    .test-title{text-align:center;font-weight:1000;font-size:1.14rem;margin:.55rem 0 .25rem;color:#123d2f;}
    .test-sub{text-align:center;color:var(--muted);font-size:.88rem;margin:0 0 .95rem;}

    .table-like{border:1px solid #e0e4e2;border-radius:14px;overflow:hidden;}
    .t-head,.t-row{display:grid;grid-template-columns:minmax(0,1.6fr) 92px 92px;align-items:center;padding:.62rem .9rem;}
    .t-head{background:var(--soft);color:var(--imss2);font-weight:1000;font-size:.82rem;}
    .t-row{border-top:1px solid #edf1ee;font-size:.95rem;background:#fff;}
    .t-row:nth-child(even){background:#fafcfb;}
    .cell-center{display:flex;justify-content:center;}

    .radio{
      appearance:none;-webkit-appearance:none;width:22px;height:22px;border-radius:50%;
      border:2px solid #cfd4d1;background:#fff;cursor:pointer;position:relative;
    }
    .radio::after{content:"";position:absolute;inset:4px;border-radius:50%;background:transparent;}
    .radio.plus:checked{border-color:var(--imss);background:var(--imss);}
    .radio.plus:checked::after{background:#fff;}
    .radio.minus:checked{border-color:var(--danger);background:var(--danger);}
    .radio.minus:checked::after{background:#fff;}

    .footer{margin-top:1rem;display:flex;justify-content:space-between;align-items:center;gap:.7rem;flex-wrap:wrap;}

    /* Admin */
    .tabs{display:flex;flex-wrap:wrap;gap:.35rem;margin-bottom:.7rem;}
    .tabs button{font-size:.84rem;padding:.45rem .8rem;}
    .tabs button.active{background:var(--imss);color:#fff;}
    table{width:100%;border-collapse:collapse;font-size:.82rem;}
    th,td{border:1px solid #dde2df;padding:.38rem .48rem;vertical-align:top;}
    th{background:var(--soft);color:var(--imss2);font-weight:1000;}
    tbody tr:nth-child(even){background:#fafcfb;}
    .scroll{max-height:420px;overflow:auto;border-radius:12px;border:1px solid #dde2df;}

    /* Modal */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:100;}
    .modal{background:#fff;border-radius:14px;box-shadow:0 10px 28px rgba(0,0,0,.28);padding:1.1rem 1.2rem;max-width:520px;width:100%;}
    .modal h3{margin:0 0 .35rem;}
    .modal .actions{display:flex;justify-content:flex-end;gap:.55rem;margin-top:.9rem;}

    /* Charts */
    .charts{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem;margin-top:.8rem;}
    .chart-card{background:#fafcfb;border:1px solid #e0e4e2;border-radius:14px;padding:.8rem .9rem;}
    .chart-title{font-weight:1000;color:var(--imss2);font-size:.9rem;margin-bottom:.35rem;}

    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
    .longtext{white-space:pre-wrap; line-height:1.45;}
    @media (max-width:680px){ .t-head,.t-row{grid-template-columns:minmax(0,1.5fr) 78px 78px;padding-inline:.65rem;} }
  </style>
</head>
<body>
<header>
  <h1>Perfil de Dinámicas Laborales (PDL)</h1>
  <nav>
    <a onclick="showSection('worker')">Inicio</a>
    <a onclick="showSection('worker')">Aplicar test</a>
    <a onclick="requestAdminAccess()">Administrador</a>
  </nav>
</header>

<main>
  <!-- Worker -->
  <section id="section-worker" class="card">
    <h2>Datos del trabajador <span class="pill">Paso 1 de 3</span></h2>
    <p class="subtitle">Capture los datos antes de iniciar el <strong>Test PDL</strong>.</p>

    <div class="form-grid">
      <div>
        <label for="unidad">Unidad *</label>
        <select id="unidad"></select>
        <div id="unidad-error" class="error hidden">Seleccione una unidad.</div>
      </div>
      <div>
        <label for="matricula">Matrícula *</label>
        <input id="matricula" type="text" />
        <div id="matricula-error" class="error hidden">Capture la matrícula.</div>
      </div>
      <div>
        <label for="nombre">Nombre completo *</label>
        <input id="nombre" type="text" />
        <div id="nombre-error" class="error hidden">Capture el nombre completo.</div>
      </div>
      <div>
        <label for="categoria">Categoría *</label>
        <select id="categoria"></select>
        <div id="categoria-error" class="error hidden">Seleccione una categoría.</div>
      </div>
      <div>
        <label for="puesto">Puesto que desempeña en el servicio *</label>
        <input id="puesto" type="text" />
        <div id="puesto-error" class="error hidden">Capture el puesto.</div>
      </div>
      <div>
        <label for="fechaNacimiento">Fecha de nacimiento *</label>
        <input id="fechaNacimiento" type="date" />
        <div id="fechaNacimiento-error" class="error hidden">Capture la fecha de nacimiento.</div>
      </div>
      <div>
        <label for="edad">Edad (años)</label>
        <input id="edad" type="text" readonly />
      </div>
      <div>
        <label for="lugarNacimiento">Lugar de nacimiento *</label>
        <input id="lugarNacimiento" type="text" />
        <div id="lugarNacimiento-error" class="error hidden">Capture el lugar de nacimiento.</div>
      </div>
    </div>

    <div class="btn-row">
      <button class="btn-primary" type="button" onclick="startTest()">Iniciar test PDL</button>
      <button class="btn-link" type="button" onclick="requestAdminAccess()">Acceso administrador</button>
    </div>

    <p class="text-muted">
      Nota: la interpretación se genera automáticamente al finalizar y queda guardada junto con el registro (local + nube).
    </p>
  </section>

  <!-- Test -->
  <section id="section-test" class="card hidden">
    <div class="block-header">
      <div id="block-label">Bloque 1 de 24</div>
      <div class="progress-wrap">
        <div class="bar"><div id="bar-fill"></div></div>
        <div id="bar-pct" class="pct">0%</div>
      </div>
    </div>

    <div class="test-title">Seleccione la palabra que MÁS (+) y MENOS (-) lo describe</div>
    <div class="test-sub">En cada bloque seleccione una como <strong>MÁS</strong> y otra como <strong>MENOS</strong>.</div>

    <div id="group"></div>
    <div id="test-error" class="error hidden" style="margin-top:.55rem;"></div>

    <div class="footer">
      <div class="text-muted">Debe elegir una opción en ambas columnas para continuar.</div>
      <div class="btn-row" style="margin:0;">
        <button id="btn-prev" class="btn-secondary" type="button" onclick="prevGroup()">Anterior</button>
        <button id="btn-next" class="btn-primary" type="button" onclick="nextGroup()">Siguiente</button>
        <button id="btn-finish" class="btn-success" type="button" onclick="finishTest()">Finalizar test</button>
      </div>
    </div>
  </section>

  <!-- Results -->
  <section id="section-results" class="card hidden">
    <h2>Resultados del PDL <span class="pill">Paso 3 de 3</span></h2>
    <div id="validity"></div>

    <div id="res-personal"></div>
    <div id="res-raw"></div>
    <div id="res-g"></div>

    <h3>Gráficas (G 0–100)</h3>
    <p class="text-muted">
      <strong>M</strong> (Motivación), <strong>L</strong> (Bajo presión) y <strong>T</strong> (Conducta diaria = M − L).
    </p>

    <div class="charts">
      <div class="chart-card">
        <div class="chart-title">Gráfica M – Motivación</div>
        <svg id="svgM" viewBox="0 0 260 235" width="100%" height="235"></svg>
      </div>
      <div class="chart-card">
        <div class="chart-title">Gráfica L – Bajo presión</div>
        <svg id="svgL" viewBox="0 0 260 235" width="100%" height="235"></svg>
      </div>
      <div class="chart-card">
        <div class="chart-title">Gráfica T – Conducta diaria</div>
        <svg id="svgT" viewBox="0 0 260 235" width="100%" height="235"></svg>
      </div>
    </div>

    <div id="analysis"></div>
    <div id="training"></div>

    <div class="btn-row">
      <button class="btn-primary" type="button" onclick="resetForNewTest()">Aplicar a otro trabajador</button>
      <button class="btn-secondary" type="button" onclick="requestAdminAccess()">Ir a administrador</button>
    </div>
  </section>

  <!-- Admin -->
  <section id="section-admin" class="card hidden">
    <h2>Panel de administración</h2>
    <p class="subtitle">Unidades, categorías y resultados (confidencial).</p>

    <div class="tabs">
      <button id="tab-u" class="btn-secondary active" type="button" onclick="setTab('u')">Unidades</button>
      <button id="tab-c" class="btn-secondary" type="button" onclick="setTab('c')">Categorías</button>
      <button id="tab-r" class="btn-secondary" type="button" onclick="setTab('r')">Resultados</button>
    </div>

    <div id="panel-u">
      <h3>Unidades</h3>
      <div class="btn-row" style="margin-top:0;">
        <input id="newUnit" type="text" placeholder="Nombre de unidad" style="max-width:360px;" />
        <button class="btn-primary" type="button" onclick="addUnit()">Agregar</button>
      </div>
      <div class="scroll" style="margin-top:.6rem;">
        <table>
          <thead><tr><th>Unidad</th><th style="width:90px;">Acciones</th></tr></thead>
          <tbody id="tbUnits"></tbody>
        </table>
      </div>
    </div>

    <div id="panel-c" class="hidden">
      <h3>Categorías</h3>
      <div class="btn-row" style="margin-top:0;">
        <input id="newCat" type="text" placeholder="Nombre de categoría" style="max-width:360px;" />
        <button class="btn-primary" type="button" onclick="addCat()">Agregar</button>
      </div>
      <div class="scroll" style="margin-top:.6rem;">
        <table>
          <thead><tr><th>Categoría</th><th style="width:90px;">Acciones</th></tr></thead>
          <tbody id="tbCats"></tbody>
        </table>
      </div>
    </div>

    <div id="panel-r" class="hidden">
      <h3>Resultados</h3>
      <div class="btn-row" style="margin-top:0;">
        <button class="btn-success" type="button" onclick="downloadCSV()">Descargar CSV</button>
        <button class="btn-secondary" type="button" onclick="reloadResults()">Recargar</button>
        <button class="btn-secondary" type="button" onclick="syncFromCloud()">Sincronizar nube</button>
      </div>

      <div class="scroll" style="margin-top:.6rem;">
        <table>
          <thead>
          <tr>
            <th>Fecha registro</th>
            <th>Unidad</th>
            <th>Matrícula</th>
            <th>Nombre</th>
            <th>Categoría</th>
            <th>F. nac.</th>
            <th>Edad</th>
            <th>Lugar nac.</th>
            <th>Puesto</th>
            <th>T Perfil</th>
            <th>ΣT</th>
            <th>Validez</th>
            <th>Acciones</th>
          </tr>
          </thead>
          <tbody id="tbRes"></tbody>
        </table>
      </div>
      <p class="text-muted" style="margin-top:.55rem;">“Ver” abre el análisis y capacitación. “Eliminar” borra local y en Firestore (si existe).</p>
    </div>

    <div class="btn-row">
      <button class="btn-secondary" type="button" onclick="showSection('worker')">Volver</button>
      <button class="btn-link" type="button" onclick="logoutAdmin()">Cerrar sesión admin</button>
    </div>
  </section>

  <!-- Modal admin login -->
  <div id="overlay" class="overlay hidden">
    <div class="modal">
      <h3>Acceso a administrador</h3>
      <p class="text-muted">Contraseña para ver resultados confidenciales.</p>
      <label>Contraseña</label>
      <input id="adminPass" type="password" />
      <div id="passErr" class="error hidden">Contraseña incorrecta.</div>
      <div class="actions">
        <button class="btn-secondary" type="button" onclick="closeLogin()">Cancelar</button>
        <button class="btn-primary" type="button" onclick="login()">Ingresar</button>
      </div>
    </div>
  </div>

  <!-- Modal “Ver reporte” -->
  <div id="overlayView" class="overlay hidden">
    <div class="modal" style="max-width:760px;">
      <h3>Detalle del resultado</h3>
      <div id="viewMeta" class="text-muted"></div>
      <h3 style="margin-top:.8rem;">Análisis</h3>
      <div id="viewAnalysis" class="longtext"></div>
      <h3 style="margin-top:.8rem;">Capacitación sugerida</h3>
      <div id="viewTraining" class="longtext"></div>
      <div class="actions">
        <button class="btn-secondary" type="button" onclick="closeView()">Cerrar</button>
      </div>
    </div>
  </div>

</main>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/12.6.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore-compat.js"></script>

<script>
/* ===================== CONFIG ===================== */
const ADMIN_PASSWORD = "PDL2025";

const firebaseConfig = {
  apiKey: "AIzaSyDJniFUuRh3mfjP40cAm2gJ2P3TGOyKqog",
  authDomain: "perfil-de-dinamicas-laborales.firebaseapp.com",
  projectId: "perfil-de-dinamicas-laborales",
  storageBucket: "perfil-de-dinamicas-laborales.firebasestorage.app",
  messagingSenderId: "231363532636",
  appId: "1:231363532636:web:b610e5501cea73dce69399",
  measurementId: "G-R1X0PZ3WYY"
};

let fs = null;
let adminLogged = false;

try{
  firebase.initializeApp(firebaseConfig);
  fs = firebase.firestore();
  console.log("Firestore listo.");
}catch(e){
  console.warn("Firestore no disponible. Se usará solo localStorage.", e);
}

const KEYS = {
  units: "PDL_units",
  cats: "PDL_categories",
  results: "PDL_results"
};

const $ = id => document.getElementById(id);
const read = (k, d) => JSON.parse(localStorage.getItem(k) || JSON.stringify(d));
const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));
const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
const nowISO = ()=>new Date().toISOString();

/* ===================== TEST DATA (genérico DISC) ===================== */
const BLOCKS = [
  [["Decidido","D"],["Sociable","I"],["Paciente","S"],["Preciso","C"]],
  [["Competitivo","D"],["Entusiasta","I"],["Constante","S"],["Cuidadoso","C"]],
  [["Directo","D"],["Expresivo","I"],["Colaborador","S"],["Analítico","C"]],
  [["Firme","D"],["Persuasivo","I"],["Leal","S"],["Metódico","C"]],
  [["Audaz","D"],["Optimista","I"],["Sereno","S"],["Exacto","C"]],
  [["Resuelto","D"],["Inspirador","I"],["Apoyador","S"],["Ordenado","C"]],
  [["Dominante","D"],["Comunicativo","I"],["Tolerante","S"],["Disciplinado","C"]],
  [["Iniciador","D"],["Motivador","I"],["Confiable","S"],["Formal","C"]],
  [["Independiente","D"],["Amable","I"],["Estable","S"],["Precavido","C"]],
  [["Rápido","D"],["Popular","I"],["Persistente","S"],["Riguroso","C"]],
  [["Seguro","D"],["Influyente","I"],["Empático","S"],["Estructurado","C"]],
  [["Determinado","D"],["Convincente","I"],["Constante","S"],["Controlado","C"]],
  [["Arriesgado","D"],["Animado","I"],["Paciente","S"],["Minucioso","C"]],
  [["Competidor","D"],["Alegre","I"],["Servicial","S"],["Exacto","C"]],
  [["Autoritario","D"],["Cordial","I"],["Conservador","S"],["Cuidadoso","C"]],
  [["Práctico","D"],["Conversador","I"],["Reservado","S"],["Perfeccionista","C"]],
  [["Enérgico","D"],["Optimista","I"],["Tranquilo","S"],["Sistemático","C"]],
  [["Decisor","D"],["Inspirador","I"],["Leal","S"],["Formal","C"]],
  [["Orientado a resultados","D"],["Relacionador","I"],["Estable","S"],["Normativo","C"]],
  [["Valiente","D"],["Espontáneo","I"],["Comprensivo","S"],["Detallista","C"]],
  [["Competente","D"],["Asertivo","I"],["Persistente","S"],["Meticuloso","C"]],
  [["Ejecutor","D"],["Social","I"],["Paciente","S"],["Exacto","C"]],
  [["Firme","D"],["Comunicador","I"],["Solidario","S"],["Cuidadoso","C"]],
  [["Decisivo","D"],["Motivador","I"],["Constante","S"],["Analítico","C"]],
];

let idx = 0;
let answers = Array(BLOCKS.length).fill(null);

/* ===================== INIT ===================== */
(function init(){
  ensureBase();
  loadSelects();

  $("fechaNacimiento").addEventListener("change",()=>{
    const f=new Date($("fechaNacimiento").value);
    if(!isNaN(f)){
      const diff=Date.now()-f.getTime();
      $("edad").value=Math.abs(new Date(diff).getUTCFullYear()-1970);
    } else {
      $("edad").value="";
    }
  });

  document.addEventListener("keydown",(e)=>{
    if(e.key==="Escape"){
      if(!$("overlay").classList.contains("hidden")) closeLogin();
      if(!$("overlayView").classList.contains("hidden")) closeView();
    }
  });

  syncConfigFromCloud().catch(()=>{});
})();

function ensureBase(){
  if(!read(KEYS.units,null) || read(KEYS.units,[]).length===0)
    save(KEYS.units,["Unidad 1"]);
  if(!read(KEYS.cats,null) || read(KEYS.cats,[]).length===0)
    save(KEYS.cats,["Categoría A"]);
  if(!read(KEYS.results,null))
    save(KEYS.results,[]);
}

function loadSelects(){
  const u=$("unidad"), c=$("categoria");
  u.innerHTML=""; c.innerHTML="";
  read(KEYS.units,[]).forEach(v=>u.add(new Option(v,v)));
  read(KEYS.cats,[]).forEach(v=>c.add(new Option(v,v)));
}

/* ===================== NAV ===================== */
function showSection(id){
  ["worker","test","results","admin"].forEach(s=>{
    const el = $("section-"+s);
    if(el) el.classList.toggle("hidden", s!==id);
  });
}

/* ===================== START TEST ===================== */
function startTest(){
  let ok=true;
  ["unidad","matricula","nombre","categoria","puesto","fechaNacimiento","lugarNacimiento"]
  .forEach(id=>{
    if(!$(id).value){ ok=false; $(id+"-error")?.classList.remove("hidden"); }
    else $(id+"-error")?.classList.add("hidden");
  });
  if(!ok) return;

  idx=0;
  answers=Array(BLOCKS.length).fill(null);

  renderGroup();
  showSection("test");
}

function renderGroup(){
  $("block-label").textContent=`Bloque ${idx+1} de ${BLOCKS.length}`;
  const pct=Math.round((idx/BLOCKS.length)*100);
  $("bar-fill").style.width=pct+"%";
  $("bar-pct").textContent=pct+"%";

  const g=BLOCKS[idx];
  let html=`<div class="table-like">
    <div class="t-head"><div>Palabra / adjetivo</div><div class="cell-center">MÁS (+)</div><div class="cell-center">MENOS (-)</div></div>`;

  g.forEach((w,i)=>{
    html+=`
    <div class="t-row">
      <div>${escapeHtml(w[0])}</div>
      <div class="cell-center">
        <input type="radio" class="radio plus" name="p${idx}" onclick="pick(${i},'M')">
      </div>
      <div class="cell-center">
        <input type="radio" class="radio minus" name="m${idx}" onclick="pick(${i},'L')">
      </div>
    </div>`;
  });

  html+="</div>";
  $("group").innerHTML=html;

  if(answers[idx]){
    document.querySelectorAll(`input[name=p${idx}]`)[answers[idx].M].checked=true;
    document.querySelectorAll(`input[name=m${idx}]`)[answers[idx].L].checked=true;
  }

  $("btn-prev").classList.toggle("hidden",idx===0);
  $("btn-next").classList.toggle("hidden",idx===BLOCKS.length-1);
  $("btn-finish").classList.toggle("hidden",idx!==BLOCKS.length-1);

  if(idx===BLOCKS.length-1){
    $("btn-next").classList.add("btn-disabled");
  }else{
    $("btn-next").classList.remove("btn-disabled");
  }
}

function pick(i,t){
  answers[idx]=answers[idx]||{};
  answers[idx][t]=i;

  if(answers[idx].M===answers[idx].L){
    $("test-error").textContent="No puede elegir la misma palabra como MÁS y MENOS.";
    $("test-error").classList.remove("hidden");
    answers[idx][t]=null;
    renderGroup();
    return;
  }
  $("test-error").classList.add("hidden");
}

function nextGroup(){
  if(!answers[idx]||answers[idx].M==null||answers[idx].L==null){
    $("test-error").textContent="Seleccione una opción en ambas columnas.";
    $("test-error").classList.remove("hidden"); return;
  }
  idx++; renderGroup();
}
function prevGroup(){ idx--; renderGroup(); }

/* ===================== CALIFICACIÓN (M, L, T) ===================== */
function computeRawCounts(){
  const M={D:0,I:0,S:0,C:0}, L={D:0,I:0,S:0,C:0};
  answers.forEach((a,i)=>{
    const g=BLOCKS[i];
    M[g[a.M][1]]++;
    L[g[a.L][1]]++;
  });
  const T={D:M.D-L.D,I:M.I-L.I,S:M.S-L.S,C:M.C-L.C};
  return {M,L,T};
}

function countToR(count){ return Math.round((count * 28) / 24); }
function tToR(tval){ return Math.round(((tval + 24) * 28) / 48); }

function multiplierForA(A){
  if(A>=12 && A<=13) return 8;
  if(A>=13.5 && A<=15) return 7;
  if(A>=15.5 && A<=17) return 6;
  if(A>=18 && A<=18.5) return 5.5;
  if(A>=19 && A<=21.5) return 5;
  if(A>=22 && A<=23) return 4.5;
  if(A>=23.5 && A<=26.5) return 4;
  if(A>=27 && A<=28) return 3.5;
  if(A<12) return 8;
  return 3.5;
}

function computeG(graphKey, rawCounts){
  let R = {D:0,I:0,S:0,C:0};

  if(graphKey==="T"){
    ["D","I","S","C"].forEach(k=> R[k]=tToR(rawCounts[k] ?? 0));
  }else{
    ["D","I","S","C"].forEach(k=> R[k]=countToR(rawCounts[k] ?? 0));
  }

  const A = (R.D + R.I + R.S + R.C) / 4;
  const mult = multiplierForA(A);

  const G = {};
  ["D","I","S","C"].forEach(k=>{
    const Df = (R[k] - A);
    const F = Df * mult;
    const g = F + 50;
    G[k] = Math.round(clamp(g, 0, 100));
  });

  return {R, A: Number(A.toFixed(2)), mult, G};
}

function drawDiamondG(svgId, valuesG, fill, stroke){
  const svg = document.getElementById(svgId);
  if(!svg) return;
  svg.innerHTML = "";

  const cx=130, cy=110, radius=80;
  const dims=["D","I","S","C"];

  function pt(dim, factor){
    if(dim==="D") return {x:cx, y:cy-radius*factor};
    if(dim==="I") return {x:cx+radius*factor, y:cy};
    if(dim==="S") return {x:cx, y:cy+radius*factor};
    return {x:cx-radius*factor, y:cy};
  }

  [0.25,0.5,0.75,1].forEach((lvl,i)=>{
    const p = dims.map(d=>pt(d,lvl));
    const dPath = `M ${p[0].x} ${p[0].y} L ${p[1].x} ${p[1].y} L ${p[2].x} ${p[2].y} L ${p[3].x} ${p[3].y} Z`;
    const path = document.createElementNS("http://www.w3.org/2000/svg","path");
    path.setAttribute("d", dPath);
    path.setAttribute("fill","none");
    path.setAttribute("stroke", i===1 ? "#b9c4bf" : "#dde3df");
    path.setAttribute("stroke-width", i===1 ? "1.4" : "1");
    svg.appendChild(path);
  });

  dims.forEach(dim=>{
    const end = pt(dim,1);
    const axis = document.createElementNS("http://www.w3.org/2000/svg","line");
    axis.setAttribute("x1",cx); axis.setAttribute("y1",cy);
    axis.setAttribute("x2",end.x); axis.setAttribute("y2",end.y);
    axis.setAttribute("stroke","#c0c7c3");
    svg.appendChild(axis);

    const lab = pt(dim,1.18);
    const t = document.createElementNS("http://www.w3.org/2000/svg","text");
    t.setAttribute("x",lab.x); t.setAttribute("y",lab.y);
    t.setAttribute("text-anchor","middle");
    t.setAttribute("alignment-baseline","middle");
    t.setAttribute("fill","#134E39");
    t.setAttribute("font-weight","1000");
    t.textContent = dim;
    svg.appendChild(t);
  });

  const pts = dims.map(dim=>{
    const g = clamp(valuesG[dim] ?? 50, 0, 100);
    return pt(dim, g/100);
  });

  const polyD = `M ${pts[0].x} ${pts[0].y} L ${pts[1].x} ${pts[1].y} L ${pts[2].x} ${pts[2].y} L ${pts[3].x} ${pts[3].y} Z`;
  const poly = document.createElementNS("http://www.w3.org/2000/svg","path");
  poly.setAttribute("d", polyD);
  poly.setAttribute("fill", fill);
  poly.setAttribute("stroke", stroke);
  poly.setAttribute("stroke-width","2");
  svg.appendChild(poly);

  pts.forEach(p=>{
    const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
    c.setAttribute("cx",p.x); c.setAttribute("cy",p.y);
    c.setAttribute("r","3.2");
    c.setAttribute("fill", stroke);
    svg.appendChild(c);
  });

  const tick = document.createElementNS("http://www.w3.org/2000/svg","text");
  tick.setAttribute("x",cx); tick.setAttribute("y",cy+radius+28);
  tick.setAttribute("text-anchor","middle");
  tick.setAttribute("fill","#777");
  tick.setAttribute("font-size","12");
  tick.textContent = `G: D=${valuesG.D} I=${valuesG.I} S=${valuesG.S} C=${valuesG.C}`;
  svg.appendChild(tick);
}

/* ===================== INTERPRETACIÓN EXTENSA ===================== */
function band(g){
  if(g>=75) return {name:"muy alto", code:"VH"};
  if(g>=65) return {name:"alto", code:"H"};
  if(g>=36) return {name:"medio", code:"M"};
  if(g>=26) return {name:"bajo", code:"L"};
  return {name:"muy bajo", code:"VL"};
}
function topDim(G){
  const dims=["D","I","S","C"];
  let t="D"; let m=G.D;
  dims.forEach(d=>{ if(G[d]>m){ m=G[d]; t=d; }});
  return t;
}
function secondDim(G, top){
  const dims=["D","I","S","C"].filter(d=>d!==top);
  let t=dims[0]; let m=G[t];
  dims.forEach(d=>{ if(G[d]>m){ m=G[d]; t=d; }});
  return t;
}

function longReport(valid, GM, GL, GT, sumT){
  const names = {D:"Dominancia", I:"Influencia", S:"Constancia", C:"Apego"};
  const dimDesc = {
    D:{
      core:"orientación a resultados, decisión, ritmo alto, manejo directo del conflicto",
      strengths:["toma decisiones con rapidez","asume responsabilidad","impulsa el avance de tareas","actúa con seguridad ante urgencias"],
      risks:["impaciencia con procesos lentos","comunicación percibida como dura","tendencia a controlar en exceso","menor tolerancia a errores ajenos"],
      comm:"prefiere mensajes breves, directos y con objetivo; responde bien a metas claras y límites definidos",
      motiv:"retos, autonomía, objetivos medibles, reconocimiento por logro y eficacia",
      stress:"bajo presión puede acelerar, confrontar o imponer; requiere pausa táctica y priorización"
    },
    I:{
      core:"comunicación, influencia social, energía interpersonal, persuasión",
      strengths:["conecta con el equipo","facilita coordinación y clima","vende ideas y moviliza","aporta entusiasmo"],
      risks:["dispersión por exceso de estímulos","subestimar riesgos por optimismo","seguimiento irregular si no hay estructura","evitar conversaciones difíciles"],
      comm:"prefiere interacción, acuerdos por consenso y mensajes positivos; necesita claridad del “qué sigue”",
      motiv:"participación, visibilidad, reconocimiento social, variedad y espacios para proponer",
      stress:"bajo presión puede hablar de más, prometer sin cerrar o buscar aprobación; requiere checklist y cierre"
    },
    S:{
      core:"estabilidad, paciencia, constancia, cooperación y ritmo sostenido",
      strengths:["confiable en rutinas","sostiene continuidad del servicio","apoya y acompaña","minimiza conflictos con tacto"],
      risks:["resistencia al cambio brusco","dificultad para confrontar","posponer decisiones","incomodidad con urgencias sostenidas"],
      comm:"prefiere instrucciones claras, ritmo predecible y apoyo; valora acuerdos estables y tiempos razonables",
      motiv:"seguridad, claridad de rol, relaciones armónicas, procesos estables y reconocimiento por constancia",
      stress:"bajo presión puede cerrarse o ceder; requiere contención, priorizar y pasos pequeños"
    },
    C:{
      core:"apego a normas, precisión, análisis, calidad y control",
      strengths:["reduce errores","documenta y ordena","detecta riesgos","mantiene estándares"],
      risks:["perfeccionismo","análisis excesivo ante ambigüedad","rigidez con cambios","estrés cuando falta información"],
      comm:"prefiere datos, evidencia y criterios; necesita claridad de estándares y de “qué es suficiente”",
      motiv:"calidad, reglas claras, trabajo técnico, control del error, autonomía para analizar",
      stress:"bajo presión puede volverse más rígido o crítico; requiere priorización y umbrales"
    }
  };

  if(!valid){
    const analysis = `PRUEBA INVÁLIDA (ΣT=${sumT}).\n
Interpretación: La sumatoria de T está fuera del rango esperado. En este escenario no se recomienda concluir un perfil conductual.\n
Recomendación operativa:\n- Reaplicar en un momento sin interrupciones.\n- Confirmar que el evaluado comprendió “MÁS” y “MENOS”.\n- Evitar que responda con prisa o por “imagen ideal”.`;
    const training = `Capacitación sugerida: No aplica mientras la prueba sea inválida.\n
Acción: Reaplicar y, si persiste invalidez, considerar entrevista breve para identificar dificultad con vocabulario o condiciones de aplicación.`;
    return {profile:"INVÁLIDA", analysis, training};
  }

  const top = topDim(GT);
  const sec = secondDim(GT, top);

  const bD=band(GT.D), bI=band(GT.I), bS=band(GT.S), bC=band(GT.C);

  const comboKey = `${top}${sec}`;
  const comboTextMap = {
    "DI":"Estilo de impacto: orientado a logro con capacidad de influir. Puede liderar y movilizar, cuidando no atropellar acuerdos.",
    "DC":"Estilo de ejecución: orientado a resultados con alta exigencia de calidad. Excelente para control y mejora, cuidando rigidez.",
    "DS":"Estilo de empuje estable: logra metas sosteniendo continuidad. Puede requerir apoyo en confrontación y priorización rápida.",
    "ID":"Estilo persuasivo-competitivo: impulsa iniciativas con energía social. Requiere estructura para cumplir y controlar impulsividad.",
    "IC":"Estilo comunicador-analítico: explica, convence y cuida detalle. Riesgo: análisis + social = demora en cierres si no hay límites.",
    "IS":"Estilo integrador: mantiene buen clima y estabilidad. Riesgo: evitar conflictos y posponer decisiones difíciles.",
    "SD":"Estilo resolutivo sereno: responde con calma y decide cuando es necesario. Riesgo: tensión interna ante urgencias sostenidas.",
    "SI":"Estilo colaborativo social: crea armonía, facilita cooperación. Riesgo: decir sí a todo y saturarse.",
    "SC":"Estilo metódico estable: consistencia con calidad. Riesgo: resistencia a cambios rápidos y estrés por interrupciones.",
    "CD":"Estilo exigente resolutivo: decide con criterio y estándares. Riesgo: intolerancia a errores y comunicación dura.",
    "CI":"Estilo técnico-influyente: combina precisión con persuasión. Riesgo: sobre-explicar y querer controlar narrativa.",
    "CS":"Estilo cuidadoso constante: orden y continuidad. Riesgo: rigidez y lentitud si no se definen prioridades."
  };
  const comboText = comboTextMap[comboKey] || "Estilo mixto: combina rasgos del perfil principal con un secundario que matiza su conducta diaria.";

  // Diferencias M vs L
  function delta(dim){ return (GM[dim]??50) - (GL[dim]??50); }
  const deltas = {D:delta("D"), I:delta("I"), S:delta("S"), C:delta("C")};

  const pressureNotes = [];
  ["D","I","S","C"].forEach(dim=>{
    const d = deltas[dim];
    if(d>=12) pressureNotes.push(`En ${dim}, la Motivación está por encima de Bajo presión (+${d}). Tiende a “bajar” ese rasgo cuando hay tensión (se modera / se contiene).`);
    else if(d<=-12) pressureNotes.push(`En ${dim}, Bajo presión está por encima de Motivación (${d}). Ese rasgo puede “subir” con tensión (se intensifica).`);
  });
  if(!pressureNotes.length) pressureNotes.push("Las diferencias M vs L no muestran cambios extremos; la respuesta bajo presión tiende a ser consistente con lo que expresa.");

  const lines = [];
  lines.push(`PERFIL PDL (conducta diaria T): ${names[top]} (${top}).`);
  lines.push(`Segundo rasgo: ${names[sec]} (${sec}).`);
  lines.push("");
  lines.push("1) LECTURA GLOBAL");
  lines.push(`- T representa el patrón cotidiano. Aquí destaca: ${dimDesc[top].core}.`);
  lines.push(`- Matiz secundario: ${dimDesc[sec].core}.`);
  lines.push(`- Síntesis de combinación: ${comboText}`);
  lines.push("");
  lines.push("2) FORTALEZAS PROBABLES");
  dimDesc[top].strengths.forEach(s=>lines.push(`- ${s}.`));
  lines.push("Fortalezas del rasgo secundario:");
  dimDesc[sec].strengths.slice(0,3).forEach(s=>lines.push(`- ${s}.`));
  lines.push("");
  lines.push("3) ÁREAS DE RIESGO / VULNERABILIDADES");
  dimDesc[top].risks.forEach(r=>lines.push(`- ${r}.`));
  lines.push("Riesgos del rasgo secundario:");
  dimDesc[sec].risks.slice(0,3).forEach(r=>lines.push(`- ${r}.`));
  lines.push("");
  lines.push("4) COMUNICACIÓN Y TRABAJO EN EQUIPO");
  lines.push(`- Cómo comunicarse mejor con esta persona: ${dimDesc[top].comm}.`);
  lines.push(`- En equipo, suele contribuir desde: ${names[top]} y ${names[sec]}. Conviene definir roles, acuerdos y expectativas.`);
  lines.push("");
  lines.push("5) MOTIVADORES (lo que suele activar desempeño)");
  lines.push(`- ${dimDesc[top].motiv}.`);
  lines.push(`- Adicional: ${dimDesc[sec].motiv}.`);
  lines.push("");
  lines.push("6) RESPUESTA BAJO PRESIÓN (comparación M vs L)");
  pressureNotes.forEach(p=>lines.push(`- ${p}`));
  lines.push(`- Señal práctica: cuando la presión sube, observar calidad de comunicación, seguimiento de tareas y manejo emocional.`);
  lines.push("");
  lines.push("7) NIVEL POR DIMENSIÓN (T, escala G)");
  lines.push(`- D: ${GT.D} (${bD.name}) | I: ${GT.I} (${bI.name}) | S: ${GT.S} (${bS.name}) | C: ${GT.C} (${bC.name})`);
  lines.push("Interpretación breve por nivel:");
  lines.push(`- D ${bD.name}: ${bD.code==="VH"||bD.code==="H" ? "toma la iniciativa y acelera decisiones" : bD.code==="M" ? "equilibra decisión con análisis" : "prefiere evitar confrontación y avanzar con cautela"}.`);
  lines.push(`- I ${bI.name}: ${bI.code==="VH"||bI.code==="H" ? "influyente y expresivo" : bI.code==="M" ? "comunicación funcional" : "comunicación reservada y prudente"}.`);
  lines.push(`- S ${bS.name}: ${bS.code==="VH"||bS.code==="H" ? "muy constante y paciente" : bS.code==="M" ? "balance entre cambio y estabilidad" : "busca cambio/ritmo o muestra baja tolerancia a rutina"}.`);
  lines.push(`- C ${bC.name}: ${bC.code==="VH"||bC.code==="H" ? "muy apegado a normas y detalle" : bC.code==="M" ? "calidad adecuada sin rigidez" : "flexible, puede omitir detalle si no se controla"}.`);
  lines.push("");
  lines.push("8) RECOMENDACIONES OPERATIVAS PARA JEFATURA");
  lines.push("- Definir metas y criterios: qué es “éxito”, qué es “suficiente”, plazos y prioridades.");
  lines.push("- Establecer canal de comunicación: frecuencia de seguimiento, formato de reporte y responsables.");
  lines.push("- Retroalimentación: concreta, con ejemplos y acuerdos de mejora (qué, cuándo, cómo se medirá).");
  lines.push("- Considerar que el resultado apoya decisiones; combinar con desempeño real y contexto del puesto.");
  lines.push("");
  const analysis = lines.join("\n");

  // Capacitación (más extensa y accionable)
  const tlines = [];
  tlines.push("PLAN DE CAPACITACIÓN SUGERIDO (orientativo y ajustable al puesto)");
  tlines.push("");
  tlines.push("A) OBJETIVOS DEL PLAN");
  tlines.push("- Fortalecer habilidades clave del perfil predominante sin caer en excesos (equilibrio).");
  tlines.push("- Reducir riesgos típicos bajo presión mediante herramientas prácticas.");
  tlines.push("- Mejorar coordinación con equipo y calidad del servicio mediante hábitos y estándares.");
  tlines.push("");

  const topTrain = {
    D:[
      "Módulo 1: Comunicación efectiva bajo presión (mensajes breves, escucha activa, retroalimentación sin confrontación).",
      "Módulo 2: Liderazgo colaborativo (delegación, acuerdos claros, seguimiento por indicadores).",
      "Módulo 3: Priorización y toma de decisiones con evidencia (matriz urgencia-impacto, control de sesgos).",
      "Módulo 4: Autogestión emocional (pausa táctica, control de impulsividad, manejo de frustración)."
    ],
    I:[
      "Módulo 1: Gestión del tiempo y enfoque (priorización, cierre de compromisos, control de pendientes).",
      "Módulo 2: Comunicación estructurada (reportes breves, formatos de entrega/pase de información).",
      "Módulo 3: Asertividad y límites (negociación, decir no, conversaciones difíciles).",
      "Módulo 4: Seguimiento y disciplina operativa (checklists, evidencias, control de calidad)."
    ],
    S:[
      "Módulo 1: Adaptación al cambio (micro-hábitos, flexibilidad, manejo de transición).",
      "Módulo 2: Asertividad y confrontación constructiva (pedir apoyo, expresar desacuerdo, acuerdos).",
      "Módulo 3: Resiliencia y autocuidado (prevención de desgaste, regulación emocional, pausas activas).",
      "Módulo 4: Mejora continua (propuestas pequeñas, estandarización, participación en indicadores)."
    ],
    C:[
      "Módulo 1: Priorización y rapidez con seguridad (umbrales, diferenciar crítico vs perfecto).",
      "Módulo 2: Comunicación técnica efectiva (traducir datos a acciones, reportes claros).",
      "Módulo 3: Flexibilidad operativa (planes B, tolerancia a ambigüedad, decisiones con info incompleta).",
      "Módulo 4: Manejo de estrés por control de error (rumiación, técnicas de control y enfoque)."
    ]
  };

  tlines.push(`B) RUTA PRINCIPAL (según T predominante: ${names[top]} - ${top})`);
  topTrain[top].forEach(m=>tlines.push(`- ${m}`));
  tlines.push("");

  tlines.push(`C) RUTA COMPLEMENTARIA (según rasgo secundario: ${names[sec]} - ${sec})`);
  topTrain[sec].slice(0,2).forEach(m=>tlines.push(`- ${m}`));
  tlines.push("");

  tlines.push("D) HÁBITOS SEMANALES (muy prácticos)");
  tlines.push("- 1 checklist diario de prioridades (máximo 3 tareas críticas).");
  tlines.push("- 1 retroalimentación breve por semana con evidencia (qué pasó / impacto / acuerdo).");
  tlines.push("- 1 práctica de autocontrol: respiración 1 minuto antes de respuesta bajo tensión.");
  tlines.push("- 1 revisión semanal de errores/éxitos: lección aprendida y acción correctiva.");
  tlines.push("");

  tlines.push("E) INDICADORES DE MEJORA (sugeridos)");
  tlines.push("- Cumplimiento de tiempos (entregas), calidad (errores), coordinación (re-trabajo), clima (conflictos).");
  tlines.push("- Seguimiento: 4–6 semanas con ajustes según supervisión.");
  const training = tlines.join("\n");

  return {profile:`${names[top]} (${top})`, analysis, training};
}

/* ===================== FINISH TEST ===================== */
async function finishTest(){
  if(!answers[idx]||answers[idx].M==null||answers[idx].L==null){
    $("test-error").textContent="Seleccione una opción en ambas columnas.";
    $("test-error").classList.remove("hidden"); return;
  }

  const counts = computeRawCounts();
  const sumT = counts.T.D + counts.T.I + counts.T.S + counts.T.C;
  const valid = (sumT>=-3 && sumT<=3);

  const GM = computeG("M", counts.M);
  const GL = computeG("L", counts.L);
  const GT = computeG("T", counts.T);

  showSection("results");

  $("validity").innerHTML = valid
    ? `<div class="ok"><strong>Prueba válida.</strong> ΣT=${sumT}</div>`
    : `<div class="warn"><strong>Prueba inválida.</strong> ΣT=${sumT}</div>`;

  $("res-personal").innerHTML = `
    <h3>Datos del trabajador</h3>
    <div class="text-muted">
      <div><strong>Unidad:</strong> ${escapeHtml($("unidad").value)}</div>
      <div><strong>Matrícula:</strong> ${escapeHtml($("matricula").value)}</div>
      <div><strong>Nombre:</strong> ${escapeHtml($("nombre").value)}</div>
      <div><strong>Categoría:</strong> ${escapeHtml($("categoria").value)}</div>
      <div><strong>Puesto:</strong> ${escapeHtml($("puesto").value)}</div>
      <div><strong>Fecha de nacimiento:</strong> ${escapeHtml($("fechaNacimiento").value)}</div>
      <div><strong>Edad:</strong> ${escapeHtml($("edad").value)}</div>
      <div><strong>Lugar de nacimiento:</strong> ${escapeHtml($("lugarNacimiento").value)}</div>
    </div>
  `;

  $("res-raw").innerHTML=`
    <h3>Conteos (M, L, T)</h3>
    <p class="mono">M: D ${counts.M.D}, I ${counts.M.I}, S ${counts.M.S}, C ${counts.M.C}</p>
    <p class="mono">L: D ${counts.L.D}, I ${counts.L.I}, S ${counts.L.S}, C ${counts.L.C}</p>
    <p class="mono">T: D ${counts.T.D}, I ${counts.T.I}, S ${counts.T.S}, C ${counts.T.C}</p>
  `;

  $("res-g").innerHTML = `
    <h3>Escala G (0–100)</h3>
    <div class="text-muted">Cálculo automático con tabla de múltiplos y fórmula estándar.</div>
    <p class="mono">M: A=${GM.A} mult=${GM.mult} | G(D) ${GM.G.D}, G(I) ${GM.G.I}, G(S) ${GM.G.S}, G(C) ${GM.G.C}</p>
    <p class="mono">L: A=${GL.A} mult=${GL.mult} | G(D) ${GL.G.D}, G(I) ${GL.G.I}, G(S) ${GL.G.S}, G(C) ${GL.G.C}</p>
    <p class="mono">T: A=${GT.A} mult=${GT.mult} | G(D) ${GT.G.D}, G(I) ${GT.G.I}, G(S) ${GT.G.S}, G(C) ${GT.G.C}</p>
  `;

  drawDiamondG("svgM", GM.G, "rgba(0,102,87,0.22)", "#006657");
  drawDiamondG("svgL", GL.G, "rgba(188,149,92,0.22)", "#BC955C");
  drawDiamondG("svgT", GT.G, "rgba(198,40,40,0.18)", "#c62828");

  // Interpretación extensa y capacitación extensa
  const rep = longReport(valid, GM.G, GL.G, GT.G, sumT);
  $("analysis").innerHTML = `<h3>Análisis (extenso)</h3><div class="longtext">${escapeHtml(rep.analysis)}</div>`;
  $("training").innerHTML = `<h3>Capacitación sugerida (extensa)</h3><div class="longtext">${escapeHtml(rep.training)}</div>`;

  // Guardar resultado (incluye interpretación + capacitación + fecha nac.)
  const record = {
    date: nowISO(),
    unidad: $("unidad").value,
    matricula: $("matricula").value,
    nombre: $("nombre").value,
    categoria: $("categoria").value,
    puesto: $("puesto").value,
    fechaNacimiento: $("fechaNacimiento").value,
    edad: $("edad").value,
    lugarNacimiento: $("lugarNacimiento").value,
    counts,
    GM, GL, GT,
    sumT,
    valid,
    perfil: rep.profile,
    interpretacion: rep.analysis,
    capacitacion: rep.training
  };

  const arr = read(KEYS.results, []);
  arr.push(record);
  save(KEYS.results, arr);

  await saveResultToCloud(record);
}

/* ===================== RESET ===================== */
function resetForNewTest(){ showSection("worker"); }

/* ===================== ADMIN LOGIN ===================== */
function requestAdminAccess(){
  if(adminLogged){ showSection("admin"); loadAdmin(); return; }
  $("adminPass").value="";
  $("passErr").classList.add("hidden");
  $("overlay").classList.remove("hidden");
}
function closeLogin(){ $("overlay").classList.add("hidden"); }
function login(){
  if($("adminPass").value===ADMIN_PASSWORD){
    adminLogged = true;
    closeLogin();
    showSection("admin");
    loadAdmin();
  }else $("passErr").classList.remove("hidden");
}
function logoutAdmin(){ adminLogged = false; showSection("worker"); }

/* ===================== ADMIN TABS ===================== */
function setTab(t){
  ["u","c","r"].forEach(x=>{
    $("panel-"+x).classList.toggle("hidden", x!==t);
    $("tab-"+x).classList.toggle("active", x===t);
  });
  if(t==="r") renderResults();
}

/* ===================== ADMIN UNITS/CATS ===================== */
function loadAdmin(){
  loadSelects();
  renderUnits();
  renderCats();
  renderResults();
}

function renderUnits(){
  const tb = $("tbUnits");
  tb.innerHTML = "";
  const units = read(KEYS.units, []);
  units.forEach((u,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${escapeHtml(u)}</td>
      <td><button class="btn-danger" type="button" onclick="delUnit(${i})">Borrar</button></td>`;
    tb.appendChild(tr);
  });
}

function renderCats(){
  const tb = $("tbCats");
  tb.innerHTML = "";
  const cats = read(KEYS.cats, []);
  cats.forEach((c,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${escapeHtml(c)}</td>
      <td><button class="btn-danger" type="button" onclick="delCat(${i})">Borrar</button></td>`;
    tb.appendChild(tr);
  });
}

async function addUnit(){
  const val = $("newUnit").value.trim();
  if(!val) return;
  const arr = read(KEYS.units, []);
  arr.push(val);
  save(KEYS.units, arr);
  $("newUnit").value="";
  renderUnits(); loadSelects();
  await saveConfigToCloud();
}

async function delUnit(i){
  const arr = read(KEYS.units, []);
  arr.splice(i,1);
  save(KEYS.units, arr);
  renderUnits(); loadSelects();
  await saveConfigToCloud();
}

async function addCat(){
  const val = $("newCat").value.trim();
  if(!val) return;
  const arr = read(KEYS.cats, []);
  arr.push(val);
  save(KEYS.cats, arr);
  $("newCat").value="";
  renderCats(); loadSelects();
  await saveConfigToCloud();
}

async function delCat(i){
  const arr = read(KEYS.cats, []);
  arr.splice(i,1);
  save(KEYS.cats, arr);
  renderCats(); loadSelects();
  await saveConfigToCloud();
}

/* ===================== ADMIN RESULTS + VIEW + DELETE ===================== */
function renderResults(){
  const tb = $("tbRes");
  tb.innerHTML = "";
  const res = read(KEYS.results, []);
  res.slice().reverse().forEach((r,revIdx)=>{
    const realIdx = res.length - 1 - revIdx;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(r.date||"")}</td>
      <td>${escapeHtml(r.unidad||"")}</td>
      <td>${escapeHtml(r.matricula||"")}</td>
      <td>${escapeHtml(r.nombre||"")}</td>
      <td>${escapeHtml(r.categoria||"")}</td>
      <td>${escapeHtml(r.fechaNacimiento||"")}</td>
      <td>${escapeHtml(r.edad||"")}</td>
      <td>${escapeHtml(r.lugarNacimiento||"")}</td>
      <td>${escapeHtml(r.puesto||"")}</td>
      <td>${escapeHtml(r.perfil||"")}</td>
      <td>${r.sumT ?? ""}</td>
      <td>${r.valid ? "Válida" : "Inválida"}</td>
      <td style="white-space:nowrap;">
        <button class="btn-secondary" type="button" onclick="viewResult(${realIdx})">Ver</button>
        <button class="btn-danger" type="button" onclick="deleteResult(${realIdx})">Eliminar</button>
      </td>
    `;
    tb.appendChild(tr);
  });
}
function reloadResults(){ renderResults(); }

function viewResult(i){
  const res = read(KEYS.results, []);
  const r = res[i];
  if(!r){ alert("No encontrado."); return; }
  $("viewMeta").textContent =
    `Fecha: ${r.date||""} | ${r.nombre||""} | ${r.matricula||""} | ${r.unidad||""} | Perfil: ${r.perfil||""}`;
  $("viewAnalysis").textContent = r.interpretacion || "(Sin interpretación guardada)";
  $("viewTraining").textContent = r.capacitacion || "(Sin capacitación guardada)";
  $("overlayView").classList.remove("hidden");
}
function closeView(){ $("overlayView").classList.add("hidden"); }

async function deleteResult(i){
  if(!confirm("¿Eliminar este resultado?")) return;
  const res = read(KEYS.results, []);
  const rec = res[i];
  res.splice(i,1);
  save(KEYS.results, res);
  renderResults();

  if(fs && rec && rec._id){
    try{ await fs.collection("pdl_resultados").doc(rec._id).delete(); }
    catch(e){ console.error("No se pudo borrar en Firestore:", e); }
  }
}

/* ===================== CSV (UTF-8 BOM) + incluye interpretación/capacitación ===================== */
function downloadCSV(){
  const data = read(KEYS.results, []);
  if(!data.length){ alert("No hay resultados."); return; }

  const header = [
    "FechaRegistro","Unidad","Matricula","Nombre","Categoria","Puesto",
    "FechaNacimiento","Edad","LugarNacimiento",
    "Perfil","sumT","Validez",
    "M_G_D","M_G_I","M_G_S","M_G_C",
    "L_G_D","L_G_I","L_G_S","L_G_C",
    "T_G_D","T_G_I","T_G_S","T_G_C",
    "Interpretacion","Capacitacion"
  ];

  const lines = [header.join(",")];

  data.forEach(r=>{
    const row = [
      r.date||"", r.unidad||"", r.matricula||"", r.nombre||"", r.categoria||"", r.puesto||"",
      r.fechaNacimiento||"", r.edad||"", r.lugarNacimiento||"",
      r.perfil||"", r.sumT??"", (r.valid ? "Válida":"Inválida"),
      r.GM?.G?.D??"", r.GM?.G?.I??"", r.GM?.G?.S??"", r.GM?.G?.C??"",
      r.GL?.G?.D??"", r.GL?.G?.I??"", r.GL?.G?.S??"", r.GL?.G?.C??"",
      r.GT?.G?.D??"", r.GT?.G?.I??"", r.GT?.G?.S??"", r.GT?.G?.C??"",
      (r.interpretacion||"").replace(/\r?\n/g," | "),
      (r.capacitacion||"").replace(/\r?\n/g," | ")
    ];

    const esc = row.map(v=>{
      const s = String(v??"");
      if(/[",\n\r]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
      return s;
    });
    lines.push(esc.join(","));
  });

  const csv = lines.join("\r\n");
  const blob = new Blob(["\ufeff"+csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "resultados_PDL.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* ===================== FIRESTORE: GUARDADO/SYNC ===================== */
async function saveConfigToCloud(){
  if(!fs) return;
  try{
    await fs.collection("config").doc("unidades").set({items: read(KEYS.units,[])});
    await fs.collection("config").doc("categorias").set({items: read(KEYS.cats,[])});
  }catch(e){
    console.error("No se pudo guardar config:", e);
  }
}

async function syncConfigFromCloud(){
  if(!fs) return;
  try{
    const u = await fs.collection("config").doc("unidades").get();
    const c = await fs.collection("config").doc("categorias").get();
    if(u.exists && Array.isArray(u.data().items)) save(KEYS.units, u.data().items);
    if(c.exists && Array.isArray(c.data().items)) save(KEYS.cats, c.data().items);
    loadSelects();
  }catch(e){
    console.warn("No se pudo cargar config nube:", e);
  }
}

async function saveResultToCloud(record){
  if(!fs) return;
  try{
    const ref = await fs.collection("pdl_resultados").add(record);
    const arr = read(KEYS.results, []);
    arr[arr.length-1]._id = ref.id;
    save(KEYS.results, arr);
  }catch(e){
    console.error("No se pudo guardar resultado en Firestore:", e);
  }
}

async function syncFromCloud(){
  if(!fs){ alert("Firestore no disponible."); return; }
  try{
    const snap = await fs.collection("pdl_resultados").orderBy("date","desc").get();
    const list = [];
    snap.forEach(doc=> list.push({_id:doc.id, ...doc.data()}));
    save(KEYS.results, list.slice().reverse());
    renderResults();
    alert("Sincronización completada.");
  }catch(e){
    console.error(e);
    alert("No se pudo sincronizar. Revisa permisos/reglas.");
  }
}

/* ===================== HELPERS ===================== */
function escapeHtml(str){
  return String(str??"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
</script>
</body>
</html>
<!-- FIN -->
