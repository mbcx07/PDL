<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Perfil de Dinámicas Laborales (PDL)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      --imss:#006657; --imss2:#134E39; --soft:#e6f2ef;
      --gold:#BC955C; --bg:#f5f7f6; --text:#222; --muted:#6b6f6d; --danger:#c62828;
      --shadow:0 2px 8px rgba(0,0,0,.08); --r:12px;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;}
    body{margin:0;background:var(--bg);color:var(--text);}
    header{background:#fff;box-shadow:var(--shadow);padding:.8rem 1.2rem;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:10;}
    header h1{margin:0;font-size:1.05rem;font-weight:900;color:var(--imss2);}
    header nav a{margin-left:1rem;text-decoration:none;font-size:.92rem;color:var(--imss);cursor:pointer;font-weight:700;}
    header nav a:hover{text-decoration:underline;}
    main{max-width:1100px;margin:1.4rem auto 2.6rem;padding:0 1rem;}
    .card{background:#fff;border-radius:var(--r);box-shadow:var(--shadow);padding:1.25rem 1.35rem;margin-bottom:1.25rem;}
    h2{margin:0 0 .55rem;font-size:1.22rem;color:var(--imss2);}
    h3{margin:1rem 0 .4rem;font-size:1.05rem;color:var(--imss2);}
    .subtitle{margin:.2rem 0 .95rem;color:var(--muted);font-size:.92rem;}
    .pill{display:inline-block;padding:.15rem .6rem;border-radius:999px;font-size:.75rem;background:var(--soft);color:var(--imss2);margin-left:.4rem;font-weight:800;}
    .badge{display:inline-block;padding:.18rem .55rem;border-radius:999px;background:var(--gold);color:#fff;font-size:.78rem;font-weight:900;}
    .hidden{display:none!important;}
    .text-muted{color:var(--muted);font-size:.86rem;}
    .error{color:var(--danger);font-size:.82rem;margin-top:.25rem;font-weight:700;}
    .ok{border:1px solid #cfe7df;background:#f4fffb;color:#0f5132;border-radius:12px;padding:.65rem .8rem;margin:.65rem 0;}
    .warn{border:1px solid #f0d3b2;background:#fff7ee;color:#7a4a12;border-radius:12px;padding:.65rem .8rem;margin:.65rem 0;}

    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:.85rem 1rem;}
    label{display:block;font-weight:800;font-size:.8rem;margin-bottom:.2rem;color:#2b2e2d;}
    input,select,textarea{width:100%;padding:.5rem .6rem;border-radius:8px;border:1px solid #cfd4d1;font-size:.94rem;background:#fff;}
    input:focus,select:focus,textarea:focus{outline:2px solid var(--soft);border-color:var(--imss);}

    .btn-row{margin-top:1rem;display:flex;flex-wrap:wrap;gap:.6rem;}
    button{border:none;border-radius:10px;padding:.55rem .98rem;font-size:.93rem;cursor:pointer;font-weight:800;}
    .btn-primary{background:var(--imss);color:#fff;}
    .btn-secondary{background:#e0e4e2;color:#333;}
    .btn-danger{background:var(--danger);color:#fff;}
    .btn-success{background:var(--imss2);color:#fff;}
    .btn-link{background:transparent;color:var(--imss);padding-left:0;}
    .btn-disabled{background:#cfd4d1!important;color:#888!important;cursor:default!important;opacity:.8;}

    /* Test UI */
    .block-header{display:flex;justify-content:space-between;align-items:center;gap:.6rem;flex-wrap:wrap;color:var(--muted);font-size:.9rem;margin-bottom:.55rem;}
    .progress-wrap{display:flex;align-items:center;gap:.5rem;min-width:200px;}
    .bar{background:#dde3df;border-radius:999px;height:8px;flex:1;overflow:hidden;}
    .bar>div{height:100%;width:0%;background:var(--imss);transition:width .2s ease;}
    .pct{min-width:40px;text-align:right;font-size:.84rem;font-weight:800;}
    .test-title{text-align:center;font-weight:1000;font-size:1.14rem;margin:.55rem 0 .25rem;color:#123d2f;}
    .test-sub{text-align:center;color:var(--muted);font-size:.88rem;margin:0 0 .95rem;}

    .table-like{border:1px solid #e0e4e2;border-radius:14px;overflow:hidden;}
    .t-head,.t-row{display:grid;grid-template-columns:minmax(0,1.6fr) 92px 92px;align-items:center;padding:.62rem .9rem;}
    .t-head{background:var(--soft);color:var(--imss2);font-weight:1000;font-size:.82rem;}
    .t-row{border-top:1px solid #edf1ee;font-size:.95rem;background:#fff;}
    .t-row:nth-child(even){background:#fafcfb;}
    .cell-center{display:flex;justify-content:center;}

    .radio{
      appearance:none;-webkit-appearance:none;width:22px;height:22px;border-radius:50%;
      border:2px solid #cfd4d1;background:#fff;cursor:pointer;position:relative;
    }
    .radio::after{content:"";position:absolute;inset:4px;border-radius:50%;background:transparent;}
    .radio.plus:checked{border-color:var(--imss);background:var(--imss);}
    .radio.plus:checked::after{background:#fff;}
    .radio.minus:checked{border-color:var(--danger);background:var(--danger);}
    .radio.minus:checked::after{background:#fff;}

    .footer{margin-top:1rem;display:flex;justify-content:space-between;align-items:center;gap:.7rem;flex-wrap:wrap;}

    /* Admin */
    .tabs{display:flex;flex-wrap:wrap;gap:.35rem;margin-bottom:.7rem;}
    .tabs button{font-size:.84rem;padding:.45rem .8rem;}
    .tabs button.active{background:var(--imss);color:#fff;}
    table{width:100%;border-collapse:collapse;font-size:.82rem;}
    th,td{border:1px solid #dde2df;padding:.38rem .48rem;vertical-align:top;}
    th{background:var(--soft);color:var(--imss2);font-weight:1000;}
    tbody tr:nth-child(even){background:#fafcfb;}
    .scroll{max-height:420px;overflow:auto;border-radius:12px;border:1px solid #dde2df;}

    /* Modal */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:100;}
    .modal{background:#fff;border-radius:14px;box-shadow:0 10px 28px rgba(0,0,0,.28);padding:1.1rem 1.2rem;max-width:440px;width:100%;}
    .modal h3{margin:0 0 .35rem;}
    .modal .actions{display:flex;justify-content:flex-end;gap:.55rem;margin-top:.9rem;}

    /* Charts */
    .charts{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem;margin-top:.8rem;}
    .chart-card{background:#fafcfb;border:1px solid #e0e4e2;border-radius:14px;padding:.8rem .9rem;}
    .chart-title{font-weight:1000;color:var(--imss2);font-size:.9rem;margin-bottom:.35rem;}

    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
    @media (max-width:680px){ .t-head,.t-row{grid-template-columns:minmax(0,1.5fr) 78px 78px;padding-inline:.65rem;} }
  </style>
</head>
<body>
<header>
  <h1>Perfil de Dinámicas Laborales (PDL)</h1>
  <nav>
    <a onclick="showSection('worker')">Inicio</a>
    <a onclick="showSection('worker')">Aplicar test</a>
    <a onclick="requestAdminAccess()">Administrador</a>
  </nav>
</header>

<main>
  <!-- Worker -->
  <section id="section-worker" class="card">
    <h2>Datos del trabajador <span class="pill">Paso 1 de 3</span></h2>
    <p class="subtitle">Capture los datos antes de iniciar el <strong>Test PDL</strong>.</p>

    <div class="form-grid">
      <div>
        <label for="unidad">Unidad *</label>
        <select id="unidad"></select>
        <div id="unidad-error" class="error hidden">Seleccione una unidad.</div>
      </div>
      <div>
        <label for="matricula">Matrícula *</label>
        <input id="matricula" type="text" />
        <div id="matricula-error" class="error hidden">Capture la matrícula.</div>
      </div>
      <div>
        <label for="nombre">Nombre completo *</label>
        <input id="nombre" type="text" />
        <div id="nombre-error" class="error hidden">Capture el nombre completo.</div>
      </div>
      <div>
        <label for="categoria">Categoría *</label>
        <select id="categoria"></select>
        <div id="categoria-error" class="error hidden">Seleccione una categoría.</div>
      </div>
      <div>
        <label for="puesto">Puesto que desempeña en el servicio *</label>
        <input id="puesto" type="text" />
        <div id="puesto-error" class="error hidden">Capture el puesto.</div>
      </div>
      <div>
        <label for="fechaNacimiento">Fecha de nacimiento *</label>
        <input id="fechaNacimiento" type="date" />
        <div id="fechaNacimiento-error" class="error hidden">Capture la fecha de nacimiento.</div>
      </div>
      <div>
        <label for="edad">Edad (años)</label>
        <input id="edad" type="text" readonly />
      </div>
      <div>
        <label for="lugarNacimiento">Lugar de nacimiento *</label>
        <input id="lugarNacimiento" type="text" />
        <div id="lugarNacimiento-error" class="error hidden">Capture el lugar de nacimiento.</div>
      </div>
    </div>

    <div class="btn-row">
      <button class="btn-primary" type="button" onclick="startTest()">Iniciar test PDL</button>
      <button class="btn-link" type="button" onclick="requestAdminAccess()">Acceso administrador</button>
    </div>

    <p class="text-muted">
      Nota técnica: el sistema calcula automáticamente <strong>A</strong> (promedio = sumatoria/4) y selecciona el <strong>múltiplo</strong> según tabla.
    </p>
  </section>

  <!-- Test -->
  <section id="section-test" class="card hidden">
    <div class="block-header">
      <div id="block-label">Bloque 1 de 24</div>
      <div class="progress-wrap">
        <div class="bar"><div id="bar-fill"></div></div>
        <div id="bar-pct" class="pct">0%</div>
      </div>
    </div>

    <div class="test-title">Seleccione la palabra que MÁS (+) y MENOS (-) lo describe</div>
    <div class="test-sub">En cada bloque seleccione una como <strong>MÁS</strong> y otra como <strong>MENOS</strong>.</div>

    <div id="group"></div>
    <div id="test-error" class="error hidden" style="margin-top:.55rem;"></div>

    <div class="footer">
      <div class="text-muted">Debe elegir una opción en ambas columnas para continuar.</div>
      <div class="btn-row" style="margin:0;">
        <button id="btn-prev" class="btn-secondary" type="button" onclick="prevGroup()">Anterior</button>
        <button id="btn-next" class="btn-primary" type="button" onclick="nextGroup()">Siguiente</button>
        <button id="btn-finish" class="btn-success" type="button" onclick="finishTest()">Finalizar test</button>
      </div>
    </div>
  </section>

  <!-- Results -->
  <section id="section-results" class="card hidden">
    <h2>Resultados del PDL <span class="pill">Paso 3 de 3</span></h2>
    <div id="validity"></div>

    <div id="res-personal"></div>
    <div id="res-raw"></div>
    <div id="res-g"></div>

    <h3>Gráficas (G 0–100)</h3>
    <p class="text-muted">
      <strong>M</strong> (Motivación), <strong>L</strong> (Bajo presión) y <strong>T</strong> (Conducta diaria = M − L).
    </p>

    <div class="charts">
      <div class="chart-card">
        <div class="chart-title">Gráfica M – Motivación</div>
        <svg id="svgM" viewBox="0 0 260 235" width="100%" height="235"></svg>
      </div>
      <div class="chart-card">
        <div class="chart-title">Gráfica L – Bajo presión</div>
        <svg id="svgL" viewBox="0 0 260 235" width="100%" height="235"></svg>
      </div>
      <div class="chart-card">
        <div class="chart-title">Gráfica T – Conducta diaria</div>
        <svg id="svgT" viewBox="0 0 260 235" width="100%" height="235"></svg>
      </div>
    </div>

    <div id="analysis"></div>
    <div id="training"></div>

    <div class="btn-row">
      <button class="btn-primary" type="button" onclick="resetForNewTest()">Aplicar a otro trabajador</button>
      <button class="btn-secondary" type="button" onclick="requestAdminAccess()">Ir a administrador</button>
    </div>
  </section>

  <!-- Admin -->
  <section id="section-admin" class="card hidden">
    <h2>Panel de administración</h2>
    <p class="subtitle">Unidades, categorías y resultados (confidencial).</p>

    <div class="tabs">
      <button id="tab-u" class="btn-secondary active" type="button" onclick="setTab('u')">Unidades</button>
      <button id="tab-c" class="btn-secondary" type="button" onclick="setTab('c')">Categorías</button>
      <button id="tab-r" class="btn-secondary" type="button" onclick="setTab('r')">Resultados</button>
      <button id="tab-a" class="btn-secondary" type="button" onclick="setTab('a')">Ayuda técnica</button>
    </div>

    <div id="panel-u">
      <h3>Unidades</h3>
      <div class="btn-row" style="margin-top:0;">
        <input id="newUnit" type="text" placeholder="Nombre de unidad" style="max-width:360px;" />
        <button class="btn-primary" type="button" onclick="addUnit()">Agregar</button>
      </div>
      <div class="scroll" style="margin-top:.6rem;">
        <table>
          <thead><tr><th>Unidad</th><th style="width:90px;">Acciones</th></tr></thead>
          <tbody id="tbUnits"></tbody>
        </table>
      </div>
    </div>

    <div id="panel-c" class="hidden">
      <h3>Categorías</h3>
      <div class="btn-row" style="margin-top:0;">
        <input id="newCat" type="text" placeholder="Nombre de categoría" style="max-width:360px;" />
        <button class="btn-primary" type="button" onclick="addCat()">Agregar</button>
      </div>
      <div class="scroll" style="margin-top:.6rem;">
        <table>
          <thead><tr><th>Categoría</th><th style="width:90px;">Acciones</th></tr></thead>
          <tbody id="tbCats"></tbody>
        </table>
      </div>
    </div>

    <div id="panel-r" class="hidden">
      <h3>Resultados</h3>
      <div class="btn-row" style="margin-top:0;">
        <button class="btn-success" type="button" onclick="downloadCSV()">Descargar CSV</button>
        <button class="btn-secondary" type="button" onclick="reloadResults()">Recargar</button>
        <button class="btn-secondary" type="button" onclick="syncFromCloud()">Sincronizar nube</button>
      </div>
      <div class="scroll" style="margin-top:.6rem;">
        <table>
          <thead>
            <tr>
              <th>Fecha</th><th>Unidad</th><th>Matrícula</th><th>Nombre</th><th>Categoría</th>
              <th>Edad</th><th>Puesto</th><th>Lugar</th>
              <th>M G(D)</th><th>M G(I)</th><th>M G(S)</th><th>M G(C)</th>
              <th>L G(D)</th><th>L G(I)</th><th>L G(S)</th><th>L G(C)</th>
              <th>T G(D)</th><th>T G(I)</th><th>T G(S)</th><th>T G(C)</th>
              <th>ΣT</th><th>Validez</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tbRes"></tbody>
        </table>
      </div>
      <p class="text-muted" style="margin-top:.55rem;">Eliminar borra local y, si existe, también en Firestore.</p>
    </div>

    <div id="panel-a" class="hidden">
      <h3>Ayuda técnica</h3>
      <div class="ok">
        <div><strong>Cálculo aplicado (automático):</strong></div>
        <div class="mono">A = (D + I + S + C) / 4</div>
        <div class="mono">DIF = R − A</div>
        <div class="mono">F = DIF × múltiplo</div>
        <div class="mono">G = F + 50</div>
        <div class="text-muted" style="margin-top:.35rem;">
          La tabla de múltiplos y la definición de R/A/D/F/G están en el manual. :contentReference[oaicite:3]{index=3}
        </div>
      </div>
      <div class="warn">
        Para aplicar la tabla de múltiplos (rango 12–28), el sistema convierte los conteos (0–24) a escala 0–28:
        <div class="mono" style="margin-top:.35rem;">R = round(conteo × 28/24)</div>
      </div>
    </div>

    <div class="btn-row">
      <button class="btn-secondary" type="button" onclick="showSection('worker')">Volver</button>
      <button class="btn-link" type="button" onclick="logoutAdmin()">Cerrar sesión admin</button>
    </div>
  </section>

  <!-- Modal admin -->
  <div id="overlay" class="overlay hidden">
    <div class="modal">
      <h3>Acceso a administrador</h3>
      <p class="text-muted">Contraseña para ver resultados confidenciales.</p>
      <label>Contraseña</label>
      <input id="adminPass" type="password" />
      <div id="passErr" class="error hidden">Contraseña incorrecta.</div>
      <div class="actions">
        <button class="btn-secondary" type="button" onclick="closeLogin()">Cancelar</button>
        <button class="btn-primary" type="button" onclick="login()">Ingresar</button>
      </div>
    </div>
  </div>
</main>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/12.6.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore-compat.js"></script>

<script>
/* ===================== CONFIG ===================== */
const ADMIN_PASSWORD = "PDL2025";

const firebaseConfig = {
  apiKey: "AIzaSyDJniFUuRh3mfjP40cAm2gJ2P3TGOyKqog",
  authDomain: "perfil-de-dinamicas-laborales.firebaseapp.com",
  projectId: "perfil-de-dinamicas-laborales",
  storageBucket: "perfil-de-dinamicas-laborales.firebasestorage.app",
  messagingSenderId: "231363532636",
  appId: "1:231363532636:web:b610e5501cea73dce69399",
  measurementId: "G-R1X0PZ3WYY"
};

let fs = null;
let adminLogged = false;

try{
  firebase.initializeApp(firebaseConfig);
  fs = firebase.firestore();
  console.log("Firestore listo.");
}catch(e){
  console.warn("Firestore no disponible. Se usará solo localStorage.", e);
}

const KEYS = {
  units: "PDL_units",
  cats: "PDL_categories",
  results: "PDL_results"
};

const $ = id => document.getElementById(id);
const read = (k, d) => JSON.parse(localStorage.getItem(k) || JSON.stringify(d));
const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));
const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
const nowISO = ()=>new Date().toISOString();

/* ===================== TEST DATA (genérico DISC) ===================== */
const BLOCKS = [
  [["Decidido","D"],["Sociable","I"],["Paciente","S"],["Preciso","C"]],
  [["Competitivo","D"],["Entusiasta","I"],["Constante","S"],["Cuidadoso","C"]],
  [["Directo","D"],["Expresivo","I"],["Colaborador","S"],["Analítico","C"]],
  [["Firme","D"],["Persuasivo","I"],["Leal","S"],["Metódico","C"]],
  [["Audaz","D"],["Optimista","I"],["Sereno","S"],["Exacto","C"]],
  [["Resuelto","D"],["Inspirador","I"],["Apoyador","S"],["Ordenado","C"]],
  [["Dominante","D"],["Comunicativo","I"],["Tolerante","S"],["Disciplinado","C"]],
  [["Iniciador","D"],["Motivador","I"],["Confiable","S"],["Formal","C"]],
  [["Independiente","D"],["Amable","I"],["Estable","S"],["Precavido","C"]],
  [["Rápido","D"],["Popular","I"],["Persistente","S"],["Riguroso","C"]],
  [["Seguro","D"],["Influyente","I"],["Empático","S"],["Estructurado","C"]],
  [["Determinado","D"],["Convincente","I"],["Constante","S"],["Controlado","C"]],
  [["Arriesgado","D"],["Animado","I"],["Paciente","S"],["Minucioso","C"]],
  [["Competidor","D"],["Alegre","I"],["Servicial","S"],["Exacto","C"]],
  [["Autoritario","D"],["Cordial","I"],["Conservador","S"],["Cuidadoso","C"]],
  [["Práctico","D"],["Conversador","I"],["Reservado","S"],["Perfeccionista","C"]],
  [["Enérgico","D"],["Optimista","I"],["Tranquilo","S"],["Sistemático","C"]],
  [["Decisor","D"],["Inspirador","I"],["Leal","S"],["Formal","C"]],
  [["Orientado a resultados","D"],["Relacionador","I"],["Estable","S"],["Normativo","C"]],
  [["Valiente","D"],["Espontáneo","I"],["Comprensivo","S"],["Detallista","C"]],
  [["Competente","D"],["Asertivo","I"],["Persistente","S"],["Meticuloso","C"]],
  [["Ejecutor","D"],["Social","I"],["Paciente","S"],["Exacto","C"]],
  [["Firme","D"],["Comunicador","I"],["Solidario","S"],["Cuidadoso","C"]],
  [["Decisivo","D"],["Motivador","I"],["Constante","S"],["Analítico","C"]],
];

let idx = 0;
let answers = Array(BLOCKS.length).fill(null);

/* ===================== INIT ===================== */
(function init(){
  ensureBase();
  loadSelects();

  $("fechaNacimiento").addEventListener("change",()=>{
    const f=new Date($("fechaNacimiento").value);
    if(!isNaN(f)){
      const diff=Date.now()-f.getTime();
      $("edad").value=Math.abs(new Date(diff).getUTCFullYear()-1970);
    }
  });

  document.addEventListener("keydown",(e)=>{
    if(e.key==="Escape" && !$("overlay").classList.contains("hidden")) closeLogin();
  });

  // (opcional) intenta traer config nube al arrancar
  syncConfigFromCloud().catch(()=>{});
})();

function ensureBase(){
  if(!read(KEYS.units,null) || read(KEYS.units,[]).length===0)
    save(KEYS.units,["Unidad 1"]);
  if(!read(KEYS.cats,null) || read(KEYS.cats,[]).length===0)
    save(KEYS.cats,["Categoría A"]);
  if(!read(KEYS.results,null))
    save(KEYS.results,[]);
}

function loadSelects(){
  const u=$("unidad"), c=$("categoria");
  u.innerHTML=""; c.innerHTML="";
  read(KEYS.units,[]).forEach(v=>u.add(new Option(v,v)));
  read(KEYS.cats,[]).forEach(v=>c.add(new Option(v,v)));
}

/* ===================== NAV ===================== */
function showSection(id){
  ["worker","test","results","admin"].forEach(s=>{
    const el = $("section-"+s);
    if(el) el.classList.toggle("hidden", s!==id);
  });
}

/* ===================== START TEST ===================== */
function startTest(){
  let ok=true;
  ["unidad","matricula","nombre","categoria","puesto","fechaNacimiento","lugarNacimiento"]
  .forEach(id=>{
    if(!$(id).value){ ok=false; $(id+"-error")?.classList.remove("hidden"); }
    else $(id+"-error")?.classList.add("hidden");
  });
  if(!ok) return;

  idx=0;
  answers=Array(BLOCKS.length).fill(null);

  renderGroup();
  showSection("test");
}

function renderGroup(){
  $("block-label").textContent=`Bloque ${idx+1} de ${BLOCKS.length}`;
  const pct=Math.round((idx/BLOCKS.length)*100);
  $("bar-fill").style.width=pct+"%";
  $("bar-pct").textContent=pct+"%";

  const g=BLOCKS[idx];
  let html=`<div class="table-like">
    <div class="t-head"><div>Palabra / adjetivo</div><div class="cell-center">MÁS (+)</div><div class="cell-center">MENOS (-)</div></div>`;

  g.forEach((w,i)=>{
    html+=`
    <div class="t-row">
      <div>${escapeHtml(w[0])}</div>
      <div class="cell-center">
        <input type="radio" class="radio plus" name="p${idx}" onclick="pick(${i},'M')">
      </div>
      <div class="cell-center">
        <input type="radio" class="radio minus" name="m${idx}" onclick="pick(${i},'L')">
      </div>
    </div>`;
  });

  html+="</div>";
  $("group").innerHTML=html;

  if(answers[idx]){
    document.querySelectorAll(`input[name=p${idx}]`)[answers[idx].M].checked=true;
    document.querySelectorAll(`input[name=m${idx}]`)[answers[idx].L].checked=true;
  }

  $("btn-prev").classList.toggle("hidden",idx===0);
  $("btn-next").classList.toggle("hidden",idx===BLOCKS.length-1);
  $("btn-finish").classList.toggle("hidden",idx!==BLOCKS.length-1);

  // UX: al final, botón siguiente “apagado”
  if(idx===BLOCKS.length-1){
    $("btn-next").classList.add("btn-disabled");
  }else{
    $("btn-next").classList.remove("btn-disabled");
  }
}

function pick(i,t){
  answers[idx]=answers[idx]||{};
  answers[idx][t]=i;

  if(answers[idx].M===answers[idx].L){
    $("test-error").textContent="No puede elegir la misma palabra como MÁS y MENOS.";
    $("test-error").classList.remove("hidden");
    answers[idx][t]=null;
    renderGroup();
    return;
  }
  $("test-error").classList.add("hidden");
}

function nextGroup(){
  if(!answers[idx]||answers[idx].M==null||answers[idx].L==null){
    $("test-error").textContent="Seleccione una opción en ambas columnas.";
    $("test-error").classList.remove("hidden"); return;
  }
  idx++; renderGroup();
}
function prevGroup(){ idx--; renderGroup(); }

/* ===================== CALIFICACIÓN (M, L, T) ===================== */
function computeRawCounts(){
  const M={D:0,I:0,S:0,C:0}, L={D:0,I:0,S:0,C:0};
  answers.forEach((a,i)=>{
    const g=BLOCKS[i];
    M[g[a.M][1]]++;
    L[g[a.L][1]]++;
  });
  const T={D:M.D-L.D,I:M.I-L.I,S:M.S-L.S,C:M.C-L.C};
  return {M,L,T};
}

/* ===================== CONVERSIÓN A R (0–28) =====================
   Para poder usar la tabla de múltiplos (12–28), convertimos conteos 0–24 a 0–28.
   Esto permite que A caiga en el rango esperado del manual. */
function countToR(count){
  return Math.round((count * 28) / 24);
}
function tToR(tval){
  // T puede ser -24..+24. Lo llevamos a 0..28 centrado:
  // primero a 0..48 con +24, luego escala a 0..28
  return Math.round(((tval + 24) * 28) / 48);
}

/* ===================== MÚLTIPLO SEGÚN TABLA MANUAL ===================== */
function multiplierForA(A){
  // Tabla del manual (DE - HASTA -> MULTIPLIQUE POR) :contentReference[oaicite:4]{index=4}
  if(A>=12 && A<=13) return 8;
  if(A>=13.5 && A<=15) return 7;
  if(A>=15.5 && A<=17) return 6;
  if(A>=18 && A<=18.5) return 5.5;
  if(A>=19 && A<=21.5) return 5;
  if(A>=22 && A<=23) return 4.5;
  if(A>=23.5 && A<=26.5) return 4;
  if(A>=27 && A<=28) return 3.5;
  // fuera de rango: aproximación segura
  if(A<12) return 8;
  return 3.5;
}

/* ===================== CÁLCULO G (manual) =====================
   R=resultado, A=promedio(sum/4), D=R-A, F=D*multiplo, G=F+50 :contentReference[oaicite:5]{index=5} */
function computeG(graphKey, rawCounts){
  // rawCounts puede ser conteo (M/L) o T (diferencias)
  let R = {D:0,I:0,S:0,C:0};

  if(graphKey==="T"){
    ["D","I","S","C"].forEach(k=> R[k]=tToR(rawCounts[k] ?? 0));
  }else{
    ["D","I","S","C"].forEach(k=> R[k]=countToR(rawCounts[k] ?? 0));
  }

  const A = (R.D + R.I + R.S + R.C) / 4;
  const mult = multiplierForA(A);

  const G = {};
  ["D","I","S","C"].forEach(k=>{
    const Df = (R[k] - A);
    const F = Df * mult;
    const g = F + 50;
    G[k] = Math.round(clamp(g, 0, 100));
  });

  return {R, A: Number(A.toFixed(2)), mult, G};
}

/* ===================== GRÁFICA ROMBO G ===================== */
function drawDiamondG(svgId, valuesG, fill, stroke){
  const svg = document.getElementById(svgId);
  if(!svg) return;
  svg.innerHTML = "";

  const cx=130, cy=110, radius=80;
  const dims=["D","I","S","C"];

  function pt(dim, factor){
    if(dim==="D") return {x:cx, y:cy-radius*factor};
    if(dim==="I") return {x:cx+radius*factor, y:cy};
    if(dim==="S") return {x:cx, y:cy+radius*factor};
    return {x:cx-radius*factor, y:cy}; // C
  }

  [0.25,0.5,0.75,1].forEach((lvl,i)=>{
    const p = dims.map(d=>pt(d,lvl));
    const dPath = `M ${p[0].x} ${p[0].y} L ${p[1].x} ${p[1].y} L ${p[2].x} ${p[2].y} L ${p[3].x} ${p[3].y} Z`;
    const path = document.createElementNS("http://www.w3.org/2000/svg","path");
    path.setAttribute("d", dPath);
    path.setAttribute("fill","none");
    path.setAttribute("stroke", i===1 ? "#b9c4bf" : "#dde3df");
    path.setAttribute("stroke-width", i===1 ? "1.4" : "1");
    svg.appendChild(path);
  });

  dims.forEach(dim=>{
    const end = pt(dim,1);
    const axis = document.createElementNS("http://www.w3.org/2000/svg","line");
    axis.setAttribute("x1",cx); axis.setAttribute("y1",cy);
    axis.setAttribute("x2",end.x); axis.setAttribute("y2",end.y);
    axis.setAttribute("stroke","#c0c7c3");
    svg.appendChild(axis);

    const lab = pt(dim,1.18);
    const t = document.createElementNS("http://www.w3.org/2000/svg","text");
    t.setAttribute("x",lab.x); t.setAttribute("y",lab.y);
    t.setAttribute("text-anchor","middle");
    t.setAttribute("alignment-baseline","middle");
    t.setAttribute("fill","#134E39");
    t.setAttribute("font-weight","1000");
    t.textContent = dim;
    svg.appendChild(t);
  });

  const pts = dims.map(dim=>{
    const g = clamp(valuesG[dim] ?? 50, 0, 100);
    return pt(dim, g/100);
  });

  const polyD = `M ${pts[0].x} ${pts[0].y} L ${pts[1].x} ${pts[1].y} L ${pts[2].x} ${pts[2].y} L ${pts[3].x} ${pts[3].y} Z`;
  const poly = document.createElementNS("http://www.w3.org/2000/svg","path");
  poly.setAttribute("d", polyD);
  poly.setAttribute("fill", fill);
  poly.setAttribute("stroke", stroke);
  poly.setAttribute("stroke-width","2");
  svg.appendChild(poly);

  pts.forEach(p=>{
    const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
    c.setAttribute("cx",p.x); c.setAttribute("cy",p.y);
    c.setAttribute("r","3.2");
    c.setAttribute("fill", stroke);
    svg.appendChild(c);
  });

  const tick = document.createElementNS("http://www.w3.org/2000/svg","text");
  tick.setAttribute("x",cx); tick.setAttribute("y",cy+radius+28);
  tick.setAttribute("text-anchor","middle");
  tick.setAttribute("fill","#777");
  tick.setAttribute("font-size","12");
  tick.textContent = `G: D=${valuesG.D} I=${valuesG.I} S=${valuesG.S} C=${valuesG.C}`;
  svg.appendChild(tick);
}

/* ===================== REPORTE PROFUNDO (ANÁLISIS + CAPACITACIÓN) ===================== */
function deepReport(valid, GM, GL, GT, sumT){
  if(!valid){
    return {
      analysis: `<div class="warn"><strong>Prueba inválida.</strong> ΣT=${sumT}. El manual indica que si la sumatoria de T no está entre -3 y +3, no deben considerarse válidos los resultados. Recomienda reaplicar asegurando comprensión de instrucciones y palabras.</div>`,
      training: `<p class="text-muted">No se recomienda plan de capacitación con un perfil inválido. Reaplicar el test en mejores condiciones.</p>`
    };
  }

  const names = {D:"Dominancia", I:"Influencia", S:"Constancia", C:"Apego"};
  const dims = ["D","I","S","C"];
  let top="D", topVal=GT.D;
  dims.forEach(d=>{ if(GT[d]>topVal){ top=d; topVal=GT[d]; } });

  function band(g){
    if(g>=70) return "alto";
    if(g<=30) return "bajo";
    return "medio";
  }

  const analysis = `
    <h3>Análisis del perfil</h3>
    <p><span class="badge">Predominante en T: ${names[top]} (${top})</span></p>

    <div class="ok">
      <div><strong>Lectura rápida:</strong></div>
      <ul class="text-muted">
        <li><strong>M (Motivación):</strong> lo que busca expresar o le gustaría mostrar.</li>
        <li><strong>L (Bajo presión):</strong> reacción probable ante tensión/exigencia.</li>
        <li><strong>T (Conducta diaria):</strong> patrón cotidiano (M − L) convertido a G.</li>
      </ul>
      <div class="mono">G(T): D ${GT.D} | I ${GT.I} | S ${GT.S} | C ${GT.C}</div>
    </div>

    <p><strong>Interpretación por dimensiones (T):</strong></p>
    <ul class="text-muted">
      <li><strong>D (${band(GT.D)}):</strong> ritmo, decisión, orientación a resultados, manejo del conflicto.</li>
      <li><strong>I (${band(GT.I)}):</strong> comunicación, influencia social, persuasión, energía interpersonal.</li>
      <li><strong>S (${band(GT.S)}):</strong> estabilidad, paciencia, constancia, tolerancia al cambio.</li>
      <li><strong>C (${band(GT.C)}):</strong> apego a normas, precisión, orden, control de calidad.</li>
    </ul>

    <p><strong>Lectura integrada:</strong></p>
    ${top==="D" ? `
      <p>Perfil orientado a metas y decisión. Se beneficia de objetivos claros, autonomía y retos. Bajo presión puede volverse más directo y exigir rapidez; conviene cuidar la forma de comunicar para evitar fricción.</p>
    `:""}
    ${top==="I" ? `
      <p>Perfil social e influyente. Suele coordinar, motivar y conectar equipos. Bajo presión puede buscar más interacción o negociación; conviene reforzar el seguimiento y la estructuración de tareas.</p>
    `:""}
    ${top==="S" ? `
      <p>Perfil estable y constante. Mantiene continuidad en servicio y es confiable en rutinas. Bajo presión puede buscar mantener orden y calma; conviene apoyar en adaptación al cambio y asertividad.</p>
    `:""}
    ${top==="C" ? `
      <p>Perfil apegado a normas y precisión. Reduce errores, cuida calidad y detalle. Bajo presión puede aumentar control o rigidez; conviene fortalecer priorización y tolerancia a la ambigüedad.</p>
    `:""}

    <p><strong>Indicadores útiles para supervisión:</strong></p>
    <ul class="text-muted">
      <li>Si L baja mucho respecto a M, puede indicar sensación de presión (cambio de conducta bajo tensión).</li>
      <li>Si los valores se concentran cerca de 50, podría ser perfil aplanado (baja diferenciación conductual).</li>
      <li>Use el resultado como apoyo: combine con observación del desempeño real y feedback de jefatura.</li>
    </ul>
  `;

  const training = `
    <h3>Capacitación sugerida (según perfil)</h3>
    ${top==="D" ? `
      <ul class="text-muted">
        <li><strong>Liderazgo y coordinación operativa:</strong> delegación, acuerdos, seguimiento por indicadores.</li>
        <li><strong>Comunicación bajo presión:</strong> escucha activa, retroalimentación sin confrontación, mensajes breves.</li>
        <li><strong>Toma de decisiones con evidencia:</strong> priorización y análisis rápido de riesgos.</li>
        <li><strong>Autocontrol:</strong> manejo de impulsividad e intolerancia a la lentitud.</li>
      </ul>
    `:""}
    ${top==="I" ? `
      <ul class="text-muted">
        <li><strong>Organización y enfoque:</strong> priorización, cierre de compromisos, control de pendientes.</li>
        <li><strong>Comunicación estructurada:</strong> reportes breves, formatos de pase/informe.</li>
        <li><strong>Asertividad:</strong> límites, negociación, manejo de conversaciones difíciles.</li>
        <li><strong>Seguimiento:</strong> evidencias de cumplimiento y hábitos de verificación.</li>
      </ul>
    `:""}
    ${top==="S" ? `
      <ul class="text-muted">
        <li><strong>Gestión del cambio:</strong> adaptación gradual, flexibilidad, aprendizaje continuo.</li>
        <li><strong>Comunicación asertiva:</strong> expresar necesidades, pedir apoyo, abordar conflictos.</li>
        <li><strong>Resiliencia y autocuidado:</strong> prevención de desgaste, pausas, regulación emocional.</li>
        <li><strong>Mejora continua:</strong> participación en propuestas pequeñas y estandarización.</li>
      </ul>
    `:""}
    ${top==="C" ? `
      <ul class="text-muted">
        <li><strong>Priorización y rapidez con seguridad:</strong> umbrales de calidad, decidir con información incompleta.</li>
        <li><strong>Comunicación técnica efectiva:</strong> traducir datos a acciones, reportes claros.</li>
        <li><strong>Flexibilidad operativa:</strong> plan B, adaptación a cambios sin perder control.</li>
        <li><strong>Manejo de estrés:</strong> reducir rumiación, técnicas de control del error.</li>
      </ul>
    `:""}
    <p class="text-muted">Sugerencia: complementar con plan de desarrollo del puesto y retroalimentación de supervisión.</p>
  `;

  return {analysis, training};
}

/* ===================== FINISH TEST ===================== */
async function finishTest(){
  // validar último bloque
  if(!answers[idx]||answers[idx].M==null||answers[idx].L==null){
    $("test-error").textContent="Seleccione una opción en ambas columnas.";
    $("test-error").classList.remove("hidden"); return;
  }

  const counts = computeRawCounts();
  const sumT = counts.T.D + counts.T.I + counts.T.S + counts.T.C;
  const valid = (sumT>=-3 && sumT<=3); // manual :contentReference[oaicite:6]{index=6}

  // calcula G por gráfica con fórmula manual :contentReference[oaicite:7]{index=7}
  const GM = computeG("M", counts.M);
  const GL = computeG("L", counts.L);
  const GT = computeG("T", counts.T);

  showSection("results");

  $("validity").innerHTML = valid
    ? `<div class="ok"><strong>Prueba válida.</strong> ΣT=${sumT}</div>`
    : `<div class="warn"><strong>Prueba inválida.</strong> ΣT=${sumT}</div>`;

  $("res-personal").innerHTML = `
    <h3>Datos del trabajador</h3>
    <div class="text-muted">
      <div><strong>Unidad:</strong> ${escapeHtml($("unidad").value)}</div>
      <div><strong>Matrícula:</strong> ${escapeHtml($("matricula").value)}</div>
      <div><strong>Nombre:</strong> ${escapeHtml($("nombre").value)}</div>
      <div><strong>Categoría:</strong> ${escapeHtml($("categoria").value)}</div>
      <div><strong>Puesto:</strong> ${escapeHtml($("puesto").value)}</div>
      <div><strong>Edad:</strong> ${escapeHtml($("edad").value)}</div>
      <div><strong>Lugar de nacimiento:</strong> ${escapeHtml($("lugarNacimiento").value)}</div>
    </div>
  `;

  $("res-raw").innerHTML=`
    <h3>Conteos (M, L, T)</h3>
    <p class="mono">M: D ${counts.M.D}, I ${counts.M.I}, S ${counts.M.S}, C ${counts.M.C}</p>
    <p class="mono">L: D ${counts.L.D}, I ${counts.L.I}, S ${counts.L.S}, C ${counts.L.C}</p>
    <p class="mono">T: D ${counts.T.D}, I ${counts.T.I}, S ${counts.T.S}, C ${counts.T.C}</p>
  `;

  $("res-g").innerHTML = `
    <h3>Escala G (0–100)</h3>
    <div class="text-muted">Cálculo automático con tabla de múltiplos y fórmula del manual.</div>
    <p class="mono">M: A=${GM.A} mult=${GM.mult} | G(D) ${GM.G.D}, G(I) ${GM.G.I}, G(S) ${GM.G.S}, G(C) ${GM.G.C}</p>
    <p class="mono">L: A=${GL.A} mult=${GL.mult} | G(D) ${GL.G.D}, G(I) ${GL.G.I}, G(S) ${GL.G.S}, G(C) ${GL.G.C}</p>
    <p class="mono">T: A=${GT.A} mult=${GT.mult} | G(D) ${GT.G.D}, G(I) ${GT.G.I}, G(S) ${GT.G.S}, G(C) ${GT.G.C}</p>
  `;

  drawDiamondG("svgM", GM.G, "rgba(0,102,87,0.22)", "#006657");
  drawDiamondG("svgL", GL.G, "rgba(188,149,92,0.22)", "#BC955C");
  drawDiamondG("svgT", GT.G, "rgba(198,40,40,0.18)", "#c62828");

  const rep = deepReport(valid, GM.G, GL.G, GT.G, sumT);
  $("analysis").innerHTML = rep.analysis;
  $("training").innerHTML = rep.training;

  // guardar resultado local + nube
  const record = {
    date: nowISO(),
    unidad: $("unidad").value,
    matricula: $("matricula").value,
    nombre: $("nombre").value,
    categoria: $("categoria").value,
    puesto: $("puesto").value,
    edad: $("edad").value,
    lugarNacimiento: $("lugarNacimiento").value,
    counts,
    GM, GL, GT,
    sumT,
    valid
  };

  const arr = read(KEYS.results, []);
  arr.push(record);
  save(KEYS.results, arr);

  await saveResultToCloud(record);
}

/* ===================== RESET ===================== */
function resetForNewTest(){
  showSection("worker");
}

/* ===================== ADMIN LOGIN ===================== */
function requestAdminAccess(){
  if(adminLogged){
    showSection("admin");
    loadAdmin();
    return;
  }
  $("adminPass").value="";
  $("passErr").classList.add("hidden");
  $("overlay").classList.remove("hidden");
}
function closeLogin(){ $("overlay").classList.add("hidden"); }
function login(){
  if($("adminPass").value===ADMIN_PASSWORD){
    adminLogged = true;
    closeLogin();
    showSection("admin");
    loadAdmin();
  }else{
    $("passErr").classList.remove("hidden");
  }
}
function logoutAdmin(){
  adminLogged = false;
  showSection("worker");
}

/* ===================== ADMIN TABS ===================== */
function setTab(t){
  ["u","c","r","a"].forEach(x=>{
    $("panel-"+x).classList.toggle("hidden", x!==t);
    $("tab-"+x).classList.toggle("active", x===t);
  });
  if(t==="r") renderResults();
}

/* ===================== ADMIN UNITS/CATS ===================== */
function loadAdmin(){
  loadSelects();
  renderUnits();
  renderCats();
  renderResults();
}

function renderUnits(){
  const tb = $("tbUnits");
  tb.innerHTML = "";
  const units = read(KEYS.units, []);
  units.forEach((u,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${escapeHtml(u)}</td>
      <td><button class="btn-danger" type="button" onclick="delUnit(${i})">Borrar</button></td>`;
    tb.appendChild(tr);
  });
}

function renderCats(){
  const tb = $("tbCats");
  tb.innerHTML = "";
  const cats = read(KEYS.cats, []);
  cats.forEach((c,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${escapeHtml(c)}</td>
      <td><button class="btn-danger" type="button" onclick="delCat(${i})">Borrar</button></td>`;
    tb.appendChild(tr);
  });
}

async function addUnit(){
  const val = $("newUnit").value.trim();
  if(!val) return;
  const arr = read(KEYS.units, []);
  arr.push(val);
  save(KEYS.units, arr);
  $("newUnit").value="";
  renderUnits(); loadSelects();
  await saveConfigToCloud();
}

async function delUnit(i){
  const arr = read(KEYS.units, []);
  arr.splice(i,1);
  save(KEYS.units, arr);
  renderUnits(); loadSelects();
  await saveConfigToCloud();
}

async function addCat(){
  const val = $("newCat").value.trim();
  if(!val) return;
  const arr = read(KEYS.cats, []);
  arr.push(val);
  save(KEYS.cats, arr);
  $("newCat").value="";
  renderCats(); loadSelects();
  await saveConfigToCloud();
}

async function delCat(i){
  const arr = read(KEYS.cats, []);
  arr.splice(i,1);
  save(KEYS.cats, arr);
  renderCats(); loadSelects();
  await saveConfigToCloud();
}

/* ===================== ADMIN RESULTS + DELETE ===================== */
function renderResults(){
  const tb = $("tbRes");
  tb.innerHTML = "";
  const res = read(KEYS.results, []);
  res.slice().reverse().forEach((r,revIdx)=>{
    const realIdx = res.length - 1 - revIdx;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(r.date||"")}</td>
      <td>${escapeHtml(r.unidad||"")}</td>
      <td>${escapeHtml(r.matricula||"")}</td>
      <td>${escapeHtml(r.nombre||"")}</td>
      <td>${escapeHtml(r.categoria||"")}</td>
      <td>${escapeHtml(r.edad||"")}</td>
      <td>${escapeHtml(r.puesto||"")}</td>
      <td>${escapeHtml(r.lugarNacimiento||"")}</td>

      <td>${r.GM?.G?.D ?? ""}</td><td>${r.GM?.G?.I ?? ""}</td><td>${r.GM?.G?.S ?? ""}</td><td>${r.GM?.G?.C ?? ""}</td>
      <td>${r.GL?.G?.D ?? ""}</td><td>${r.GL?.G?.I ?? ""}</td><td>${r.GL?.G?.S ?? ""}</td><td>${r.GL?.G?.C ?? ""}</td>
      <td>${r.GT?.G?.D ?? ""}</td><td>${r.GT?.G?.I ?? ""}</td><td>${r.GT?.G?.S ?? ""}</td><td>${r.GT?.G?.C ?? ""}</td>

      <td>${r.sumT ?? ""}</td>
      <td>${r.valid ? "Válida" : "Inválida"}</td>
      <td><button class="btn-danger" type="button" onclick="deleteResult(${realIdx})">Eliminar</button></td>
    `;
    tb.appendChild(tr);
  });
}
function reloadResults(){ renderResults(); }

async function deleteResult(i){
  if(!confirm("¿Eliminar este resultado?")) return;
  const res = read(KEYS.results, []);
  const rec = res[i];
  res.splice(i,1);
  save(KEYS.results, res);
  renderResults();

  if(fs && rec && rec._id){
    try{ await fs.collection("pdl_resultados").doc(rec._id).delete(); }
    catch(e){ console.error("No se pudo borrar en Firestore:", e); }
  }
}

/* ===================== CSV (UTF-8 BOM) ===================== */
function downloadCSV(){
  const data = read(KEYS.results, []);
  if(!data.length){ alert("No hay resultados."); return; }

  const header = [
    "Fecha","Unidad","Matricula","Nombre","Categoria","Puesto","Edad","LugarNacimiento",
    "M_G_D","M_G_I","M_G_S","M_G_C",
    "L_G_D","L_G_I","L_G_S","L_G_C",
    "T_G_D","T_G_I","T_G_S","T_G_C",
    "sumT","Validez"
  ];
  const lines = [header.join(",")];

  data.forEach(r=>{
    const row = [
      r.date||"", r.unidad||"", r.matricula||"", r.nombre||"", r.categoria||"",
      r.puesto||"", r.edad||"", r.lugarNacimiento||"",
      r.GM?.G?.D??"", r.GM?.G?.I??"", r.GM?.G?.S??"", r.GM?.G?.C??"",
      r.GL?.G?.D??"", r.GL?.G?.I??"", r.GL?.G?.S??"", r.GL?.G?.C??"",
      r.GT?.G?.D??"", r.GT?.G?.I??"", r.GT?.G?.S??"", r.GT?.G?.C??"",
      r.sumT??"", r.valid ? "Válida":"Inválida"
    ];

    const esc = row.map(v=>{
      const s = String(v??"");
      if(/[",\n\r]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
      return s;
    });
    lines.push(esc.join(","));
  });

  const csv = lines.join("\r\n");
  const blob = new Blob(["\ufeff"+csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "resultados_PDL.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* ===================== FIRESTORE: GUARDADO/SYNC ===================== */
async function saveConfigToCloud(){
  if(!fs) return;
  try{
    await fs.collection("config").doc("unidades").set({items: read(KEYS.units,[])});
    await fs.collection("config").doc("categorias").set({items: read(KEYS.cats,[])});
  }catch(e){
    console.error("No se pudo guardar config:", e);
  }
}

async function syncConfigFromCloud(){
  if(!fs) return;
  try{
    const u = await fs.collection("config").doc("unidades").get();
    const c = await fs.collection("config").doc("categorias").get();
    if(u.exists && Array.isArray(u.data().items)) save(KEYS.units, u.data().items);
    if(c.exists && Array.isArray(c.data().items)) save(KEYS.cats, c.data().items);
    loadSelects();
  }catch(e){
    console.warn("No se pudo cargar config nube:", e);
  }
}

async function saveResultToCloud(record){
  if(!fs) return;
  try{
    const ref = await fs.collection("pdl_resultados").add(record);
    // agrega id al último guardado localmente
    const arr = read(KEYS.results, []);
    arr[arr.length-1]._id = ref.id;
    save(KEYS.results, arr);
  }catch(e){
    console.error("No se pudo guardar resultado en Firestore:", e);
  }
}

async function syncFromCloud(){
  if(!fs){ alert("Firestore no disponible."); return; }
  try{
    const snap = await fs.collection("pdl_resultados").orderBy("date","desc").get();
    const list = [];
    snap.forEach(doc=> list.push({_id:doc.id, ...doc.data()}));
    // guardo en local en orden cronológico antiguo (para que el reverse en tabla funcione)
    save(KEYS.results, list.slice().reverse());
    renderResults();
    alert("Sincronización completada.");
  }catch(e){
    console.error(e);
    alert("No se pudo sincronizar. Revisa permisos/reglas.");
  }
}

/* ===================== HELPERS ===================== */
function escapeHtml(str){
  return String(str??"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
</script>
</body>
</html>
<!-- FIN -->
