  /* ===== Charts: radar/rombo con escala G ===== */
  function drawDiamondG(svgId, valuesG, opts={}){
    const svg=document.getElementById(svgId);
    if(!svg) return;
    svg.innerHTML="";

    const cx=130, cy=110, radius=80;
    const dims=["D","I","S","C"];
    const labelPosFactor=1.18;

    function pointFor(dim, factor){
      let x=cx,y=cy;
      if(dim==="D") y=cy-radius*factor;
      if(dim==="I") x=cx+radius*factor;
      if(dim==="S") y=cy+radius*factor;
      if(dim==="C") x=cx-radius*factor;
      return {x,y};
    }

    // rings at G: 25, 50, 75, 100 => factors 0.25,0.5,0.75,1.0
    const rings=[0.25,0.5,0.75,1.0];
    rings.forEach((lvl,idx)=>{
      const pts=dims.map(d=>pointFor(d,lvl));
      const dPath=pts.map((p,i)=>(i===0?"M":"L")+p.x+" "+p.y).join(" ")+" Z";
      const ring=document.createElementNS("http://www.w3.org/2000/svg","path");
      ring.setAttribute("d",dPath);
      ring.setAttribute("fill","none");
      ring.setAttribute("stroke", idx===1 ? "#b9c4bf" : "#dde3df"); // nivel 50 un poco más marcado
      ring.setAttribute("stroke-width", idx===1 ? "1.4" : "1");
      svg.appendChild(ring);
    });

    // centerline (G=50 ring already drawn; draw a faint cross)
    dims.forEach(dim=>{
      const end=pointFor(dim,1);
      const axis=document.createElementNS("http://www.w3.org/2000/svg","line");
      axis.setAttribute("x1",cx); axis.setAttribute("y1",cy);
      axis.setAttribute("x2",end.x); axis.setAttribute("y2",end.y);
      axis.setAttribute("stroke","#c0c7c3"); axis.setAttribute("stroke-width","1");
      svg.appendChild(axis);
    });

    // labels
    dims.forEach(dim=>{
      const p=pointFor(dim,labelPosFactor);
      const t=document.createElementNS("http://www.w3.org/2000/svg","text");
      t.setAttribute("x",p.x); t.setAttribute("y",p.y);
      t.setAttribute("text-anchor","middle"); t.setAttribute("alignment-baseline","middle");
      t.setAttribute("class","chart-axis-label");
      t.textContent=dim;
      svg.appendChild(t);
    });

    // center marker text
    const tick=document.createElementNS("http://www.w3.org/2000/svg","text");
    tick.setAttribute("x",cx); tick.setAttribute("y",cy+radius+30);
    tick.setAttribute("text-anchor","middle");
    tick.setAttribute("class","chart-tick-label");
    tick.textContent=`G: D=${valuesG.D} I=${valuesG.I} S=${valuesG.S} C=${valuesG.C}`;
    svg.appendChild(tick);

    // polygon
    const ptsVal=dims.map(dim=>{
      const g=clamp(valuesG[dim]??50,0,100);
      const factor=g/100;
      return pointFor(dim,factor);
    });
    const dVal=ptsVal.map((p,i)=>(i===0?"M":"L")+p.x+" "+p.y).join(" ")+" Z";
    const poly=document.createElementNS("http://www.w3.org/2000/svg","path");
    poly.setAttribute("d",dVal);
    poly.setAttribute("fill", opts.fill ?? "rgba(0,102,87,0.22)");
    poly.setAttribute("stroke", opts.stroke ?? "#006657");
    poly.setAttribute("stroke-width","2");
    svg.appendChild(poly);

    // small dots
    ptsVal.forEach(p=>{
      const c=document.createElementNS("http://www.w3.org/2000/svg","circle");
      c.setAttribute("cx",p.x); c.setAttribute("cy",p.y);
      c.setAttribute("r","3.2");
      c.setAttribute("fill", opts.stroke ?? "#006657");
      svg.appendChild(c);
    });
  }

  function updateChartsG(GM, GL, GT){
    drawDiamondG("chartM-svg", GM, {fill:"rgba(0,102,87,0.22)", stroke:"#006657"});
    drawDiamondG("chartL-svg", GL, {fill:"rgba(188,149,92,0.22)", stroke:"#BC955C"});
    drawDiamondG("chartT-svg", GT, {fill:"rgba(198,40,40,0.18)", stroke:"#c62828"});
  }

  /* ===== Interpretación y capacitación (solo si válido) =====
     Nota: El manual incluye reglas específicas. Aquí mantenemos texto amplio, pero la validez y la escala G están alineadas.
  */
  function interpretAndTrain(valid, GM, GL, GT){
    if(!valid){
      return {
        interp: `<div class="warning-box"><strong>Prueba inválida:</strong> La suma de T no está dentro del rango aceptado. Se recomienda repetir la aplicación en condiciones adecuadas.</div>`,
        train: `<div class="text-muted">No se emite plan de capacitación mientras la prueba sea inválida.</div>`
      };
    }
    // Perfil principal se toma por T (conducta diaria) en G
    const dims=["D","I","S","C"];
    let top="D", max=GT.D;
    dims.forEach(d=>{ if(GT[d]>max){max=GT[d]; top=d;} });
    const names={D:"Dominancia",I:"Influencia",S:"Estabilidad",C:"Cumplimiento"};
    const title=`<p><span class="badge">Perfil predominante (T): ${names[top]} (${top})</span></p>`;

    const interp = `
      ${title}
      <p><strong>Lectura general:</strong> La gráfica <strong>T</strong> representa la conducta diaria. Valores más altos sugieren mayor presencia del rasgo en el comportamiento cotidiano.</p>
      <p class="text-muted">
        <strong>M (Motivación)</strong> refleja lo que la persona busca o desea expresar; 
        <strong>L (Bajo presión)</strong> muestra cómo tiende a responder bajo tensión; 
        <strong>T (Conducta diaria)</strong> es el balance (M − L) llevado a escala G.
      </p>
      <p class="text-muted"><strong>G (0–100):</strong> D=${GT.D}, I=${GT.I}, S=${GT.S}, C=${GT.C}</p>
    `;

    const train = `
      <p><strong>Capacitación sugerida (orientativa):</strong></p>
      <ul class="text-muted">
        <li><strong>Si predomina D:</strong> liderazgo colaborativo, comunicación bajo presión, toma de decisiones con evidencia.</li>
        <li><strong>Si predomina I:</strong> gestión del tiempo, seguimiento de compromisos, asertividad y límites.</li>
        <li><strong>Si predomina S:</strong> adaptación al cambio, participación en mejora continua, comunicación asertiva.</li>
        <li><strong>Si predomina C:</strong> priorización, flexibilidad operativa, comunicación técnica para equipos mixtos.</li>
      </ul>
    `;
    return {interp, train};
  }

  /* ===== Finish test ===== */
  async function finishTest(){
    if(!captureCurrentGroupSelection()) return;
    if(!allGroupsAnswered()){
      alert("Faltan bloques por contestar.");
      return;
    }

    const mlt = computeMLT();
    const {G:GM, normas:nM} = toG("M", mlt.M);
    const {G:GL, normas:nL} = toG("L", mlt.L);
    const {G:GT, normas:nT} = toG("T", mlt.T);

    updateChartsG(GM,GL,GT);

    const {interp, train} = interpretAndTrain(mlt.valid, GM,GL,GT);

    renderResults(mlt, GM,GL,GT, (nM&&nL&&nT));
    document.getElementById("result-interpretation").innerHTML = `<h3>Análisis</h3>${interp}`;
    document.getElementById("result-training").innerHTML = `<h3>Capacitación</h3>${train}`;

    await saveResult(mlt, GM,GL,GT);
    showSection("results");
  }

  function renderResults(mlt, GM,GL,GT, normasOk){
    const w=currentWorkerData;

    document.getElementById("result-validity").innerHTML = mlt.valid
      ? `<div class="warning-box" style="border-color:#cfe7df;background:#f4fffb;color:#0f5132;"><strong>Prueba válida.</strong> ΣT = ${mlt.sumT} (rango aceptado).</div>`
      : `<div class="warning-box"><strong>Prueba inválida.</strong> ΣT = ${mlt.sumT}. Se recomienda repetir.</div>`;

    document.getElementById("result-personal").innerHTML = `
      <h3>Datos del trabajador</h3>
      <div class="form-grid" style="margin-top:.4rem;">
        <div><strong>Nombre:</strong> ${escapeHtml(w.nombre)}</div>
        <div><strong>Matrícula:</strong> ${escapeHtml(w.matricula)}</div>
        <div><strong>Unidad:</strong> ${escapeHtml(w.unidad)}</div>
        <div><strong>Categoría:</strong> ${escapeHtml(w.categoria)}</div>
        <div><strong>Puesto:</strong> ${escapeHtml(w.puesto)}</div>
        <div><strong>Edad:</strong> ${escapeHtml(w.edad)} años</div>
        <div><strong>Fecha nac.:</strong> ${escapeHtml(w.fechaNacimiento)}</div>
        <div><strong>Lugar nac.:</strong> ${escapeHtml(w.lugarNacimiento)}</div>
      </div>
    `;

    document.getElementById("result-raw").innerHTML = `
      <h3>Puntuaciones crudas</h3>
      <p class="text-muted"><strong>M</strong> (Motivación): D=${mlt.M.D}, I=${mlt.M.I}, S=${mlt.M.S}, C=${mlt.M.C}</p>
      <p class="text-muted"><strong>L</strong> (Bajo presión): D=${mlt.L.D}, I=${mlt.L.I}, S=${mlt.L.S}, C=${mlt.L.C}</p>
      <p class="text-muted"><strong>T</strong> (Conducta diaria = M − L): D=${mlt.T.D}, I=${mlt.T.I}, S=${mlt.T.S}, C=${mlt.T.C} &nbsp; | &nbsp; <strong>ΣT=${mlt.sumT}</strong></p>
    `;

    document.getElementById("result-g").innerHTML = `
      <h3>Escala G (0–100)</h3>
      ${normasOk ? "" : `<div class="warning-box"><strong>Normas no cargadas:</strong> La escala G se muestra en modo aproximado. Para alineación exacta, cargue tablas en Admin &gt; Normas.</div>`}
      <p class="text-muted"><strong>G(M)</strong>: D=${GM.D}, I=${GM.I}, S=${GM.S}, C=${GM.C}</p>
      <p class="text-muted"><strong>G(L)</strong>: D=${GL.D}, I=${GL.I}, S=${GL.S}, C=${GL.C}</p>
      <p class="text-muted"><strong>G(T)</strong>: D=${GT.D}, I=${GT.I}, S=${GT.S}, C=${GT.C}</p>
    `;
  }

  function resetForNewTest(){
    currentWorkerData=null;
    ["unidad","matricula","nombre","categoria","puesto","fechaNacimiento","edad","lugarNacimiento"].forEach(id=>{
      const el=document.getElementById(id);
      if(!el) return;
      if(el.tagName==="SELECT") el.value=""; else el.value="";
    });
    testAnswers=TEST_GROUPS.map(()=>({most:null,least:null}));
    currentGroupIndex=0;
    showSection("worker");
  }

  /* ===== Save / load results + delete + CSV (UTF-8 BOM) ===== */
  async function saveResult(mlt, GM,GL,GT){
    const now=new Date();
    const fecha=now.toISOString().slice(0,10)+" "+now.toTimeString().slice(0,8);
    const fechaEpoch=now.getTime();

    const record={
      fecha, fechaEpoch,
      ...currentWorkerData,
      M: mlt.M, L: mlt.L, T: mlt.T, sumT: mlt.sumT, valid: mlt.valid,
      GM, GL, GT,
      normasCargadas: normasLoaded(getNormas())
    };

    if(db){
      try{
        const docRef=await addDoc(collection(db,"pdl_resultados"), record);
        record._id=docRef.id;
      }catch(e){
        console.error("Error guardando Firestore:", e);
      }
    }

    const local=readLocal(STORAGE_KEYS.resultados,[]);
    local.push(record);
    writeLocal(STORAGE_KEYS.resultados, local);
    await loadResults();
  }

  async function loadResults(){
    let fromFS=[];
    if(db){
      try{
        const qSnap=query(collection(db,"pdl_resultados"), orderBy("fechaEpoch","desc"));
        const snap=await getDocs(qSnap);
        fromFS=snap.docs.map(d=>({ ...d.data(), _id:d.id }));
      }catch(e){ console.error("Error leyendo Firestore:", e); }
    }
    resultadosCache = fromFS.length ? fromFS : readLocal(STORAGE_KEYS.resultados,[]);
    refreshResultadosTable();
  }

  function refreshResultadosTable(){
    const tbody=document.getElementById("tablaResultados");
    if(!tbody) return;
    tbody.innerHTML="";
    resultadosCache.forEach((r,idx)=>{
      const validTxt = r.valid ? "Válida" : "Inválida";
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${escapeHtml(r.fecha||"")}</td>
        <td>${escapeHtml(r.unidad||"")}</td>
        <td>${escapeHtml(r.matricula||"")}</td>
        <td>${escapeHtml(r.nombre||"")}</td>
        <td>${escapeHtml(r.categoria||"")}</td>
        <td>${escapeHtml(r.puesto||"")}</td>
        <td>${escapeHtml(r.edad||"")}</td>
        <td>${escapeHtml(r.lugarNacimiento||"")}</td>

        <td>${r.M?.D ?? ""}</td><td>${r.M?.I ?? ""}</td><td>${r.M?.S ?? ""}</td><td>${r.M?.C ?? ""}</td>
        <td>${r.L?.D ?? ""}</td><td>${r.L?.I ?? ""}</td><td>${r.L?.S ?? ""}</td><td>${r.L?.C ?? ""}</td>
        <td>${r.T?.D ?? ""}</td><td>${r.T?.I ?? ""}</td><td>${r.T?.S ?? ""}</td><td>${r.T?.C ?? ""}</td>

        <td>${r.sumT ?? ""}</td>
        <td>${validTxt}</td>

        <td>${r.GM?.D ?? ""}</td><td>${r.GM?.I ?? ""}</td><td>${r.GM?.S ?? ""}</td><td>${r.GM?.C ?? ""}</td>
        <td>${r.GL?.D ?? ""}</td><td>${r.GL?.I ?? ""}</td><td>${r.GL?.S ?? ""}</td><td>${r.GL?.C ?? ""}</td>
        <td>${r.GT?.D ?? ""}</td><td>${r.GT?.I ?? ""}</td><td>${r.GT?.S ?? ""}</td><td>${r.GT?.C ?? ""}</td>

        <td><button class="btn-danger" type="button" onclick="deleteResultado(${idx})">Eliminar</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function deleteResultado(index){
    if(index<0||index>=resultadosCache.length) return;
    const registro=resultadosCache[index];
    if(!confirm("¿Eliminar este resultado de forma permanente?")) return;

    if(db && registro._id){
      try{ await deleteDoc(doc(db,"pdl_resultados", registro._id)); }
      catch(e){ console.error("Error eliminando Firestore:", e); }
    }

    resultadosCache.splice(index,1);
    writeLocal(STORAGE_KEYS.resultados, resultadosCache);
    refreshResultadosTable();
  }

  function downloadCSV(){
    const data = resultadosCache.length ? resultadosCache : readLocal(STORAGE_KEYS.resultados,[]);
    if(!data.length){ alert("No hay resultados para descargar."); return; }

    const sep=",";
    const header=[
      "Fecha","Unidad","Matricula","Nombre","Categoria","Puesto","Edad","LugarNacimiento",
      "M_D","M_I","M_S","M_C",
      "L_D","L_I","L_S","L_C",
      "T_D","T_I","T_S","T_C",
      "sumT","validez",
      "G_M_D","G_M_I","G_M_S","G_M_C",
      "G_L_D","G_L_I","G_L_S","G_L_C",
      "G_T_D","G_T_I","G_T_S","G_T_C",
      "NormasCargadas"
    ];

    const lines=[header.join(sep)];
    data.forEach(r=>{
      const row=[
        r.fecha||"",r.unidad||"",r.matricula||"",r.nombre||"",r.categoria||"",r.puesto||"",
        r.edad||"",r.lugarNacimiento||"",
        r.M?.D??"",r.M?.I??"",r.M?.S??"",r.M?.C??"",
        r.L?.D??"",r.L?.I??"",r.L?.S??"",r.L?.C??"",
        r.T?.D??"",r.T?.I??"",r.T?.S??"",r.T?.C??"",
        r.sumT??"", r.valid ? "Válida" : "Inválida",
        r.GM?.D??"",r.GM?.I??"",r.GM?.S??"",r.GM?.C??"",
        r.GL?.D??"",r.GL?.I??"",r.GL?.S??"",r.GL?.C??"",
        r.GT?.D??"",r.GT?.I??"",r.GT?.S??"",r.GT?.C??"",
        r.normasCargadas ? "Sí" : "No"
      ];

      const esc=row.map(v=>{
        const val=(v==null)?"":String(v);
        if(val.includes('"')||val.includes(",")||val.includes("\n")||val.includes("\r")) return '"'+val.replace(/"/g,'""')+'"';
        return val;
      });
      lines.push(esc.join(sep));
    });

    const csvContent=lines.join("\r\n");
    const blob=new Blob(["\ufeff"+csvContent],{type:"text/csv;charset=utf-8;"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url; a.download="resultados_PDL.csv";
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  /* ===== Init ===== */
  function initPDLApp(){
    ensureDefaultConfigLocal();
    populateWorkerSelects();
    initBirthDateListener();
    loadNormasToEditor();
    showSection("worker");
    loadRemoteConfig();
    loadResults();
    // preparar botones iniciales
    updateNavButtons();
  }

  document.addEventListener("DOMContentLoaded", initPDLApp);

  /* ===== Expose to window (HTML handlers) ===== */
  window.showSection=showSection;
  window.requestAdminAccess=requestAdminAccess;
  window.closeAdminLogin=closeAdminLogin;
  window.submitAdminLogin=submitAdminLogin;
  window.startTest=startTest;
  window.nextGroup=nextGroup;
  window.prevGroup=prevGroup;
  window.finishTest=finishTest;
  window.resetForNewTest=resetForNewTest;

  window.setAdminTab=setAdminTab;
  window.addUnidad=addUnidad;
  window.deleteUnidad=deleteUnidad;
  window.addCategoria=addCategoria;
  window.deleteCategoria=deleteCategoria;

  window.saveNormas=saveNormas;
  window.loadNormasToEditor=loadNormasToEditor;
  window.resetNormasToDefault=resetNormasToDefault;

  window.loadResults=loadResults;
  window.deleteResultado=deleteResultado;
  window.downloadCSV=downloadCSV;
</script>
</body>
</html>
<!-- FIN -->
