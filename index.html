<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Perfil de Dinámicas Laborales (PDL)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --imss-green-main: #006657;
      --imss-green-dark: #134E39;
      --imss-green-soft: #e6f2ef;
      --accent-gold: #BC955C;
      --bg: #f5f7f6;
      --text: #222;
      --danger: #c62828;
      --muted: #777;
      --card-radius: 10px;
      --shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
    }
    header {
      background: #ffffff;
      box-shadow: var(--shadow);
      padding: 0.75rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--imss-green-dark);
    }
    header nav a {
      margin-left: 1rem;
      text-decoration: none;
      font-size: 0.88rem;
      color: var(--imss-green-main);
      cursor: pointer;
    }
    header nav a:hover { text-decoration: underline; }

    main {
      max-width: 1100px;
      margin: 1.5rem auto 2.5rem;
      padding: 0 1rem;
    }
    .card {
      background: #ffffff;
      border-radius: var(--card-radius);
      box-shadow: var(--shadow);
      padding: 1.4rem 1.5rem;
      margin-bottom: 1.25rem;
    }
    h2 {
      margin-top: 0;
      font-size: 1.3rem;
      color: var(--imss-green-dark);
    }
    h3 {
      font-size: 1.05rem;
      margin-top: 1rem;
    }
    .subtitle {
      font-size: 0.9rem;
      color: var(--muted);
      margin-bottom: 0.75rem;
    }
    .pill {
      display: inline-block;
      padding: 0.15rem 0.6rem;
      border-radius: 999px;
      font-size: 0.75rem;
      background: var(--imss-green-soft);
      color: var(--imss-green-dark);
      margin-left: 0.4rem;
      font-weight: 600;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: 0.8rem 1rem;
    }
    label {
      display: block;
      font-size: 0.8rem;
      margin-bottom: 0.2rem;
      font-weight: 600;
    }
    input, select {
      width: 100%;
      padding: 0.45rem 0.55rem;
      border-radius: 5px;
      border: 1px solid #cfd4d1;
      font-size: 0.9rem;
      background: #ffffff;
    }
    input:focus, select:focus {
      outline: 2px solid var(--imss-green-soft);
      border-color: var(--imss-green-main);
    }
    .btn-row {
      margin-top: 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
    }
    button {
      border-radius: 6px;
      border: none;
      padding: 0.45rem 0.95rem;
      font-size: 0.9rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }
    .btn-primary {
      background: var(--imss-green-main);
      color: #ffffff;
    }
    .btn-secondary {
      background: #e0e4e2;
      color: #333;
    }
    .btn-danger {
      background: var(--danger);
      color: #ffffff;
    }
    .btn-success {
      background: var(--imss-green-dark);
      color: #ffffff;
    }
    .btn-link {
      background: transparent;
      color: var(--imss-green-main);
      padding-left: 0;
    }
    .btn-disabled {
      background: #cfd4d1 !important;
      color: #888 !important;
      cursor: default !important;
      opacity: 0.7;
    }
    .error {
      color: var(--danger);
      font-size: 0.8rem;
      margin-top: 0.25rem;
    }
    .text-muted {
      font-size: 0.8rem;
      color: var(--muted);
    }
    .hidden { display: none !important; }

    /* Encabezado de bloque del test */
    .block-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
      color: var(--muted);
      flex-wrap: wrap;
      gap: 0.4rem;
    }
    .progress-wrapper {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      min-width: 150px;
    }
    .progress-bar-container {
      background: #dde3df;
      border-radius: 999px;
      height: 6px;
      flex: 1;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background: var(--imss-green-main);
      transition: width 0.2s ease;
    }
    .progress-percent {
      font-size: 0.8rem;
      color: var(--muted);
      min-width: 32px;
      text-align: right;
    }

    /* Tabla estilo test */
    .test-title {
      font-size: 1.1rem;
      font-weight: 700;
      text-align: center;
      margin: 0.6rem 0 0.4rem;
    }
    .test-subtitle-center {
      text-align: center;
      font-size: 0.86rem;
      color: var(--muted);
      margin-bottom: 0.8rem;
    }
    .table-like {
      width: 100%;
      border-radius: 10px;
      border: 1px solid #e0e4e2;
      overflow: hidden;
      background: #ffffff;
    }
    .table-header, .table-row {
      display: grid;
      grid-template-columns: minmax(0, 1.5fr) repeat(2, minmax(80px, 0.6fr));
      align-items: center;
      padding: 0.6rem 0.9rem;
    }
    .table-header {
      background: var(--imss-green-soft);
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--imss-green-dark);
    }
    .table-row {
      border-top: 1px solid #edf1ee;
      font-size: 0.9rem;
    }
    .table-row:nth-child(even) {
      background: #fafcfb;
    }
    .table-row-label { font-weight: 500; }
    .choice-cell { display: flex; justify-content: center; }

    /* Radios tipo check */
    .choice-radio {
      appearance: none;
      -webkit-appearance: none;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: 2px solid #cfd4d1;
      background: #ffffff;
      position: relative;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .choice-radio::after {
      content: "";
      position: absolute;
      inset: 4px;
      border-radius: 50%;
      background: transparent;
      transition: background 0.15s ease;
    }
    .choice-radio.choice-plus:checked {
      border-color: var(--imss-green-main);
      background: var(--imss-green-main);
    }
    .choice-radio.choice-plus:checked::after {
      background: #ffffff;
    }
    .choice-radio.choice-minus:checked {
      border-color: var(--danger);
      background: var(--danger);
    }
    .choice-radio.choice-minus:checked::after {
      background: #ffffff;
    }

    .test-footer {
      margin-top: 0.9rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    @media (max-width: 650px) {
      .table-header, .table-row {
        grid-template-columns: minmax(0, 1.6fr) repeat(2, 70px);
        padding-inline: 0.55rem;
      }
    }

    /* Admin */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.82rem;
    }
    th, td {
      border: 1px solid #dde2df;
      padding: 0.35rem 0.45rem;
      text-align: left;
    }
    th {
      background: var(--imss-green-soft);
      font-weight: 600;
      color: var(--imss-green-dark);
    }
    tbody tr:nth-child(even) { background: #fafcfb; }
    .admin-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
      margin-bottom: 0.7rem;
    }
    .admin-tabs button {
      font-size: 0.8rem;
      padding: 0.35rem 0.7rem;
    }
    .admin-tabs button.active {
      background: var(--imss-green-main);
      color: #ffffff;
    }
    .inline-form {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.7rem;
      align-items: center;
    }
    .badge {
      display: inline-block;
      padding: 0.16rem 0.5rem;
      border-radius: 999px;
      background: var(--accent-gold);
      color: #fff;
      font-size: 0.78rem;
      font-weight: 600;
    }
  </style>
</head>
<body>
<header>
  <h1>Perfil de Dinámicas Laborales (PDL)</h1>
  <nav>
    <a onclick="showSection('worker')">Inicio</a>
    <a onclick="showSection('worker')">Aplicar test</a>
    <a onclick="showAdminAccess()">Administrador</a>
  </nav>
</header>

<main>
  <!-- 1. CARÁTULA -->
  <section id="section-worker" class="card">
    <h2>Datos del trabajador <span class="pill">Paso 1 de 3</span></h2>
    <p class="subtitle">
      Capture los datos antes de iniciar el <strong>Test PDL – Perfil de Dinámicas Laborales</strong>.
    </p>

    <div class="form-grid">
      <div>
        <label for="unidad">Unidad *</label>
        <select id="unidad"></select>
        <div id="unidad-error" class="error hidden">Seleccione una unidad.</div>
      </div>
      <div>
        <label for="matricula">Matrícula *</label>
        <input id="matricula" type="text" />
        <div id="matricula-error" class="error hidden">Capture la matrícula.</div>
      </div>
      <div>
        <label for="nombre">Nombre completo *</label>
        <input id="nombre" type="text" />
        <div id="nombre-error" class="error hidden">Capture el nombre completo.</div>
      </div>
      <div>
        <label for="categoria">Categoría *</label>
        <select id="categoria"></select>
        <div id="categoria-error" class="error hidden">Seleccione una categoría.</div>
      </div>
      <div>
        <label for="puesto">Puesto que desempeña en el servicio *</label>
        <input id="puesto" type="text" />
        <div id="puesto-error" class="error hidden">Capture el puesto.</div>
      </div>
      <div>
        <label for="fechaNacimiento">Fecha de nacimiento *</label>
        <input id="fechaNacimiento" type="date" />
        <div id="fechaNacimiento-error" class="error hidden">Capture la fecha de nacimiento.</div>
      </div>
      <div>
        <label for="edad">Edad (años)</label>
        <input id="edad" type="text" readonly />
      </div>
      <div>
        <label for="lugarNacimiento">Lugar de nacimiento *</label>
        <input id="lugarNacimiento" type="text" />
        <div id="lugarNacimiento-error" class="error hidden">Capture el lugar de nacimiento.</div>
      </div>
    </div>

    <div class="btn-row">
      <button class="btn-primary" type="button" onclick="startTest()">Iniciar test PDL</button>
      <button class="btn-link" type="button" onclick="showAdminAccess()">Acceso administrador</button>
    </div>
    <p class="text-muted">
      La información se almacena localmente y, si configura Firebase, también en Firestore. Puede descargarse en CSV desde el panel de administración.
    </p>
  </section>

  <!-- 2. TEST PDL -->
  <section id="section-test" class="card hidden">
    <div class="block-header">
      <div id="block-label">Bloque 1 de 24</div>
      <div class="progress-wrapper">
        <div class="progress-bar-container">
          <div id="progress-bar" class="progress-bar"></div>
        </div>
        <span id="progress-percent" class="progress-percent">0%</span>
      </div>
    </div>

    <div class="test-title">Seleccione la palabra que MÁS (+) y MENOS (-) lo describe</div>
    <div class="test-subtitle-center">
      En cada bloque, elija <strong>una palabra como MÁS (+)</strong> y <strong>una palabra como MENOS (-)</strong>.
    </div>

    <div id="test-group-container"></div>
    <div id="test-error" class="error hidden" style="margin-top:0.5rem;"></div>

    <div class="test-footer">
      <div class="text-muted" style="font-size:0.78rem;">
        Debe seleccionar una opción en ambas columnas para continuar.
      </div>
      <div class="btn-row" style="margin-top:0;">
        <button id="btn-prev" class="btn-secondary" type="button" onclick="prevGroup()">Anterior</button>
        <button id="btn-next" class="btn-primary" type="button" onclick="nextGroup()">Siguiente</button>
        <button id="btn-finish" class="btn-success" type="button" onclick="finishTest()">Finalizar test</button>
      </div>
    </div>
  </section>

  <!-- 3. RESULTADOS -->
  <section id="section-results" class="card hidden">
    <h2>Resultados del PDL <span class="pill">Paso 3 de 3</span></h2>
    <div id="result-personal"></div>
    <div id="result-scores"></div>
    <div id="result-interpretation"></div>
    <div class="btn-row">
      <button class="btn-primary" type="button" onclick="resetForNewTest()">Aplicar a otro trabajador</button>
      <button class="btn-secondary" type="button" onclick="showAdminAccess()">Ir a administrador</button>
    </div>
  </section>

  <!-- 4. ACCESO ADMIN -->
  <section id="section-admin-access" class="card hidden">
    <h2>Acceso administrador</h2>
    <p class="subtitle">Ingrese la clave para administrar unidades, categorías y resultados.</p>
    <div class="form-grid">
      <div>
        <label for="adminPasswordInput">Clave de administrador</label>
        <input id="adminPasswordInput" type="password" />
        <div id="admin-access-error" class="error hidden">Clave incorrecta.</div>
      </div>
    </div>
    <div class="btn-row">
      <button class="btn-primary" type="button" onclick="tryAdminLogin()">Ingresar</button>
      <button class="btn-secondary" type="button" onclick="showSection('worker')">Volver al inicio</button>
    </div>
    <p class="text-muted">
      La clave se define en el código JavaScript del archivo.
    </p>
  </section>

  <!-- 5. PANEL ADMIN -->
  <section id="section-admin" class="card hidden">
    <h2>Panel de administración</h2>
    <p class="subtitle">
      Administre <strong>unidades</strong>, <strong>categorías</strong> y consulte/descargue los resultados del PDL.
    </p>

    <div class="admin-tabs">
      <button id="tab-unidades" class="btn-secondary active" type="button" onclick="setAdminTab('unidades')">Unidades</button>
      <button id="tab-categorias" class="btn-secondary" type="button" onclick="setAdminTab('categorias')">Categorías</button>
      <button id="tab-resultados" class="btn-secondary" type="button" onclick="setAdminTab('resultados')">Resultados</button>
    </div>

    <!-- Unidades -->
    <div id="admin-unidades">
      <h3>Gestión de unidades</h3>
      <div class="inline-form">
        <input id="nuevaUnidad" type="text" placeholder="Nombre de nueva unidad" />
        <button class="btn-primary" type="button" onclick="addUnidad()">Agregar</button>
      </div>
      <p class="text-muted">Estas unidades se muestran en el desplegable de la carátula.</p>
      <table>
        <thead>
        <tr><th>Unidad</th><th style="width:80px;">Acciones</th></tr>
        </thead>
        <tbody id="tablaUnidades"></tbody>
      </table>
    </div>

    <!-- Categorías -->
    <div id="admin-categorias" class="hidden">
      <h3>Gestión de categorías</h3>
      <div class="inline-form">
        <input id="nuevaCategoria" type="text" placeholder="Nombre de nueva categoría" />
        <button class="btn-primary" type="button" onclick="addCategoria()">Agregar</button>
      </div>
      <p class="text-muted">Estas categorías se muestran en el desplegable de la carátula.</p>
      <table>
        <thead>
        <tr><th>Categoría</th><th style="width:80px;">Acciones</th></tr>
        </thead>
        <tbody id="tablaCategorias"></tbody>
      </table>
    </div>

    <!-- Resultados -->
    <div id="admin-resultados" class="hidden">
      <h3>Resultados registrados</h3>
      <p class="text-muted">
        Los registros se guardan en este dispositivo y, si configuraste Firebase, también en Firestore.
        Puedes descargar el archivo en formato CSV para usarlo en Excel.
      </p>
      <div class="btn-row" style="margin-bottom:0.7rem;">
        <button class="btn-success" type="button" onclick="downloadCSV()">Descargar CSV</button>
        <button class="btn-secondary" type="button" onclick="clearAllResults()">Borrar resultados locales</button>
      </div>
      <div style="max-height:360px; overflow:auto; border-radius:8px; border:1px solid #dde2df;">
        <table>
          <thead>
          <tr>
            <th>Fecha</th><th>Unidad</th><th>Matrícula</th><th>Nombre</th><th>Categoría</th>
            <th>Puesto</th><th>Edad</th><th>Lugar nac.</th>
            <th>D</th><th>I</th><th>S</th><th>C</th><th>Perfil</th>
          </tr>
          </thead>
          <tbody id="tablaResultados"></tbody>
        </table>
      </div>
    </div>

    <div class="btn-row" style="margin-top:1rem;">
      <button class="btn-secondary" type="button" onclick="showSection('worker')">Volver al inicio</button>
    </div>
  </section>
</main>

<!-- JS principal como módulo para poder usar Firebase por CDN -->
<script type="module">
  /******************** IMPORTS FIREBASE (CDN) ********************/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
    query,
    orderBy
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";

  /******************** CONFIGURACIÓN FIREBASE (TU PROYECTO) ********************/
  const firebaseConfig = {
    apiKey: "AIzaSyDJniFUuRh3mfjP40cAm2gJ2P3TGOyKqog",
    authDomain: "perfil-de-dinamicas-laborales.firebaseapp.com",
    projectId: "perfil-de-dinamicas-laborales",
    storageBucket: "perfil-de-dinamicas-laborales.firebasestorage.app",
    messagingSenderId: "231363532636",
    appId: "1:231363532636:web:b610e5501cea73dce69399",
    measurementId: "G-R1X0PZ3WYY"
  };

  let db = null;
  try {
    const app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    getAnalytics(app); // opcional, solo para estadísticas
    console.log("Firebase inicializado correctamente.");
  } catch (err) {
    console.warn("Firebase NO inicializado. Se usará solo almacenamiento local.", err);
  }

  /******************** CONFIG APP ********************/
  const ADMIN_PASSWORD = "admin123"; // <-- cámbiala aquí

  const STORAGE_KEYS = {
    unidades: "pdl_unidades",
    categorias: "pdl_categorias",
    resultados: "pdl_resultados"  // copia local como respaldo
  };

  // 24 bloques de 4 adjetivos (versión propia inspirada en DISC)
  const TEST_GROUPS = [
    { words: [
      { text: "Gentil / Suave", dim: "S" },
      { text: "Persuasivo", dim: "I" },
      { text: "Humilde", dim: "S" },
      { text: "Original", dim: "D" }
    ]},
    { words: [
      { text: "Enérgico", dim: "D" },
      { text: "Sociable", dim: "I" },
      { text: "Paciente", dim: "S" },
      { text: "Preciso", dim: "C" }
    ]},
    { words: [
      { text: "Decidido", dim: "D" },
      { text: "Entusiasta", dim: "I" },
      { text: "Sereno", dim: "S" },
      { text: "Analítico", dim: "C" }
    ]},
    { words: [
      { text: "Competitivo", dim: "D" },
      { text: "Comunicativo", dim: "I" },
      { text: "Colaborador", dim: "S" },
      { text: "Organizado", dim: "C" }
    ]},
    { words: [
      { text: "Directo", dim: "D" },
      { text: "Optimista", dim: "I" },
      { text: "Constante", dim: "S" },
      { text: "Cuidadoso", dim: "C" }
    ]},
    { words: [
      { text: "Audaz", dim: "D" },
      { text: "Persuasivo / Influyente", dim: "I" },
      { text: "Apacible", dim: "S" },
      { text: "Metódico", dim: "C" }
    ]},
    { words: [
      { text: "Competente", dim: "D" },
      { text: "Alegre", dim: "I" },
      { text: "Leal", dim: "S" },
      { text: "Exacto", dim: "C" }
    ]},
    { words: [
      { text: "Firme", dim: "D" },
      { text: "Animado", dim: "I" },
      { text: "Equilibrado", dim: "S" },
      { text: "Crítico", dim: "C" }
    ]},
    { words: [
      { text: "Resolutivo", dim: "D" },
      { text: "Espontáneo", dim: "I" },
      { text: "Considerado", dim: "S" },
      { text: "Minucioso", dim: "C" }
    ]},
    { words: [
      { text: "Exigente", dim: "D" },
      { text: "Carismático", dim: "I" },
      { text: "Paciente con otros", dim: "S" },
      { text: "Objetivo", dim: "C" }
    ]},
    { words: [
      { text: "Dominante", dim: "D" },
      { text: "Amigable", dim: "I" },
      { text: "Tolerante", dim: "S" },
      { text: "Riguroso", dim: "C" }
    ]},
    { words: [
      { text: "Arriesgado", dim: "D" },
      { text: "Expresivo", dim: "I" },
      { text: "Calmado", dim: "S" },
      { text: "Detallista", dim: "C" }
    ]},
    { words: [
      { text: "Orientado a resultados", dim: "D" },
      { text: "Orientado a personas", dim: "I" },
      { text: "Estable", dim: "S" },
      { text: "Orientado a normas", dim: "C" }
    ]},
    { words: [
      { text: "Autoritario", dim: "D" },
      { text: "Entusiasta social", dim: "I" },
      { text: "Cooperador", dim: "S" },
      { text: "Conservador", dim: "C" }
    ]},
    { words: [
      { text: "Competidor nato", dim: "D" },
      { text: "Conversador", dim: "I" },
      { text: "Serio", dim: "S" },
      { text: "Cauteloso", dim: "C" }
    ]},
    { words: [
      { text: "Decisivo", dim: "D" },
      { text: "Animador", dim: "I" },
      { text: "Tranquilo", dim: "S" },
      { text: "Controlado", dim: "C" }
    ]},
    { words: [
      { text: "Independiente", dim: "D" },
      { text: "Inspirador", dim: "I" },
      { text: "Comprensivo", dim: "S" },
      { text: "Disciplinado", dim: "C" }
    ]},
    { words: [
      { text: "Franco", dim: "D" },
      { text: "Entregado al grupo", dim: "I" },
      { text: "Paciente con tareas", dim: "S" },
      { text: "Ordenado", dim: "C" }
    ]},
    { words: [
      { text: "Seguro de sí mismo", dim: "D" },
      { text: "Optimista social", dim: "I" },
      { text: "Leal al equipo", dim: "S" },
      { text: "Exacto con datos", dim: "C" }
    ]},
    { words: [
      { text: "Competente bajo presión", dim: "D" },
      { text: "Persuasivo en público", dim: "I" },
      { text: "Constante en tareas", dim: "S" },
      { text: "Perfeccionista", dim: "C" }
    ]},
    { words: [
      { text: "Orientado a desafíos", dim: "D" },
      { text: "Comunicador nato", dim: "I" },
      { text: "Estable emocionalmente", dim: "S" },
      { text: "Respetuoso de reglas", dim: "C" }
    ]},
    { words: [
      { text: "Dispuesto a liderar", dim: "D" },
      { text: "Gusta de convivir", dim: "I" },
      { text: "Prefiere la armonía", dim: "S" },
      { text: "Analiza antes de actuar", dim: "C" }
    ]},
    { words: [
      { text: "Competitivo en metas", dim: "D" },
      { text: "Se integra fácilmente", dim: "I" },
      { text: "Mantiene la calma", dim: "S" },
      { text: "Exigente con calidad", dim: "C" }
    ]},
    { words: [
      { text: "Asume riesgos", dim: "D" },
      { text: "Disfruta convencer", dim: "I" },
      { text: "Paciente con personas", dim: "S" },
      { text: "Cumple procedimientos", dim: "C" }
    ]}
  ];

  // Estado
  let testAnswers = TEST_GROUPS.map(() => ({ most: null, least: null }));
  let currentGroupIndex = 0;
  let currentWorkerData = null;

  // Caché de resultados (para tabla y CSV)
  let resultadosCache = [];

  /******************** UTILIDADES GENERALES ********************/
  function showSection(section) {
    ["worker", "test", "results", "adminAccess", "admin"].forEach(s => {
      const el = document.getElementById("section-" + s);
      if (!el) return;
      if (s === section) el.classList.remove("hidden");
      else el.classList.add("hidden");
    });
  }

  function showAdminAccess() {
    const input = document.getElementById("adminPasswordInput");
    const err = document.getElementById("admin-access-error");
    if (input) input.value = "";
    if (err) err.classList.add("hidden");
    showSection("adminAccess");
  }

  function calculateAge(dateStr) {
    if (!dateStr) return "";
    const today = new Date();
    const birth = new Date(dateStr);
    let age = today.getFullYear() - birth.getFullYear();
    const m = today.getMonth() - birth.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
    return age;
  }

  function readLocal(key, defaultValue) {
    try {
      const raw = localStorage.getItem(key);
      if (!raw) return defaultValue;
      return JSON.parse(raw);
    } catch {
      return defaultValue;
    }
  }

  function writeLocal(key, value) {
    try { localStorage.setItem(key, JSON.stringify(value)); } catch {}
  }

  /******************** CONFIG INICIAL ********************/
  function ensureDefaultConfig() {
    let unidades = readLocal(STORAGE_KEYS.unidades, null);
    let categorias = readLocal(STORAGE_KEYS.categorias, null);

    if (!Array.isArray(unidades) || unidades.length === 0) {
      unidades = ["Unidad 1", "Unidad 2"];
      writeLocal(STORAGE_KEYS.unidades, unidades);
    }
    if (!Array.isArray(categorias) || categorias.length === 0) {
      categorias = ["Categoría A", "Categoría B"];
      writeLocal(STORAGE_KEYS.categorias, categorias);
    }
  }

  function populateWorkerSelects() {
    const unidades = readLocal(STORAGE_KEYS.unidades, []);
    const categorias = readLocal(STORAGE_KEYS.categorias, []);
    const unidadSelect = document.getElementById("unidad");
    const categoriaSelect = document.getElementById("categoria");

    if (!unidadSelect || !categoriaSelect) return;

    unidadSelect.innerHTML = '<option value="">Seleccione...</option>';
    categoriaSelect.innerHTML = '<option value="">Seleccione...</option>';

    unidades.forEach(u => {
      const opt = document.createElement("option");
      opt.value = u;
      opt.textContent = u;
      unidadSelect.appendChild(opt);
    });
    categorias.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      categoriaSelect.appendChild(opt);
    });
  }

  /******************** FORMULARIO TRABAJADOR ********************/
  const fechaNacimientoInput = document.getElementById("fechaNacimiento");
  if (fechaNacimientoInput) {
    fechaNacimientoInput.addEventListener("change", function () {
      const age = calculateAge(this.value);
      const edadEl = document.getElementById("edad");
      if (edadEl) edadEl.value = age !== "" ? age : "";
    });
  }

  function validateWorkerForm() {
    let valid = true;
    const unidad = document.getElementById("unidad").value.trim();
    const matricula = document.getElementById("matricula").value.trim();
    const nombre = document.getElementById("nombre").value.trim();
    const categoria = document.getElementById("categoria").value.trim();
    const puesto = document.getElementById("puesto").value.trim();
    const fechaNacimiento = document.getElementById("fechaNacimiento").value;
    const lugarNacimiento = document.getElementById("lugarNacimiento").value.trim();

    const fields = [
      { id: "unidad", value: unidad },
      { id: "matricula", value: matricula },
      { id: "nombre", value: nombre },
      { id: "categoria", value: categoria },
      { id: "puesto", value: puesto },
      { id: "fechaNacimiento", value: fechaNacimiento },
      { id: "lugarNacimiento", value: lugarNacimiento }
    ];
    fields.forEach(f => {
      const errorEl = document.getElementById(f.id + "-error");
      if (!f.value) {
        errorEl && errorEl.classList.remove("hidden");
        valid = false;
      } else {
        errorEl && errorEl.classList.add("hidden");
      }
    });
    if (!valid) return null;

    return {
      unidad,
      matricula,
      nombre,
      categoria,
      puesto,
      fechaNacimiento,
      edad: calculateAge(fechaNacimiento),
      lugarNacimiento
    };
  }

  function startTest() {
    const workerData = validateWorkerForm();
    if (!workerData) return;
    currentWorkerData = workerData;
    currentGroupIndex = 0;
    testAnswers = TEST_GROUPS.map(() => ({ most: null, least: null }));
    renderCurrentGroup();
    updateProgressUI();
    updateNavButtons();
    showSection("test");
  }

  /******************** TEST PDL ********************/
  function renderCurrentGroup() {
    const container = document.getElementById("test-group-container");
    if (!container) return;
    const group = TEST_GROUPS[currentGroupIndex];
    const answers = testAnswers[currentGroupIndex];

    let html = "";
    html += '<div class="table-like">';
    html += '<div class="table-header">';
    html += '<div>Palabra / adjetivo</div>';
    html += '<div style="text-align:center;">MÁS (+)</div>';
    html += '<div style="text-align:center;">MENOS (-)</div>';
    html += '</div>';

    group.words.forEach((w, idx) => {
      const mostChecked = answers.most === idx ? "checked" : "";
      const leastChecked = answers.least === idx ? "checked" : "";
      html += '<div class="table-row">';
      html += `<div class="table-row-label">${w.text}</div>`;
      html += '<div class="choice-cell">';
      html += `<input class="choice-radio choice-plus" type="radio" name="most" value="${idx}" ${mostChecked}>`;
      html += '</div>';
      html += '<div class="choice-cell">';
      html += `<input class="choice-radio choice-minus" type="radio" name="least" value="${idx}" ${leastChecked}>`;
      html += '</div>`;
      html += '</div>`;
    });

    html += '</div>';
    container.innerHTML = html;
    document.getElementById("test-error").classList.add("hidden");
    document.getElementById("block-label").textContent =
      "Bloque " + (currentGroupIndex + 1) + " de " + TEST_GROUPS.length;

    setupChoiceMutualExclusion();
  }

  function setupChoiceMutualExclusion() {
    const container = document.getElementById("test-group-container");
    const plusRadios = container.querySelectorAll(".choice-plus");
    const minusRadios = container.querySelectorAll(".choice-minus");

    plusRadios.forEach(r => {
      r.addEventListener("change", function() {
        if (!this.checked) return;
        const val = this.value;
        const sameMinus = container.querySelector('.choice-minus[value="' + val + '"]');
        if (sameMinus && sameMinus.checked) sameMinus.checked = false;
      });
    });
    minusRadios.forEach(r => {
      r.addEventListener("change", function() {
        if (!this.checked) return;
        const val = this.value;
        const samePlus = container.querySelector('.choice-plus[value="' + val + '"]');
        if (samePlus && samePlus.checked) samePlus.checked = false;
      });
    });
  }

  function updateProgressUI() {
    const progress = (currentGroupIndex / TEST_GROUPS.length) * 100;
    const bar = document.getElementById("progress-bar");
    const percent = document.getElementById("progress-percent");
    if (bar) bar.style.width = progress + "%";
    if (percent) percent.textContent = Math.round(progress) + "%";
  }

  function updateNavButtons() {
    const btnPrev = document.getElementById("btn-prev");
    const btnNext = document.getElementById("btn-next");
    if (!btnPrev || !btnNext) return;

    if (currentGroupIndex === 0) {
      btnPrev.disabled = true;
      btnPrev.classList.add("btn-disabled");
    } else {
      btnPrev.disabled = false;
      btnPrev.classList.remove("btn-disabled");
    }

    if (currentGroupIndex === TEST_GROUPS.length - 1) {
      btnNext.disabled = true;
      btnNext.classList.add("btn-disabled");
    } else {
      btnNext.disabled = false;
      btnNext.classList.remove("btn-disabled");
    }
  }

  function captureCurrentGroupSelection() {
    const mostRadios = document.querySelectorAll('input[name="most"]');
    const leastRadios = document.querySelectorAll('input[name="least"]');
    let most = null, least = null;

    mostRadios.forEach(r => { if (r.checked) most = parseInt(r.value, 10); });
    leastRadios.forEach(r => { if (r.checked) least = parseInt(r.value, 10); });

    if (most === null || least === null) {
      showTestError("Debe elegir una palabra como MÁS (+) y otra como MENOS (-) en este bloque.");
      return false;
    }
    if (most === least) {
      showTestError("La misma palabra no puede ser MÁS (+) y MENOS (-) en el mismo bloque.");
      return false;
    }
    testAnswers[currentGroupIndex] = { most, least };
    return true;
  }

  function showTestError(msg) {
    const el = document.getElementById("test-error");
    if (!el) return;
    el.textContent = msg;
    el.classList.remove("hidden");
  }

  function nextGroup() {
    if (!captureCurrentGroupSelection()) return;
    if (currentGroupIndex < TEST_GROUPS.length - 1) {
      currentGroupIndex++;
      renderCurrentGroup();
      updateProgressUI();
      updateNavButtons();
    }
  }

  function prevGroup() {
    if (currentGroupIndex > 0) {
      captureCurrentGroupSelection();
      currentGroupIndex--;
      renderCurrentGroup();
      updateProgressUI();
      updateNavButtons();
    }
  }

  function allGroupsAnswered() {
    return testAnswers.every(a => a.most !== null && a.least !== null);
  }

  async function finishTest() {
    if (!captureCurrentGroupSelection()) return;
    if (!allGroupsAnswered()) {
      showTestError("Debe completar los 24 bloques antes de finalizar el test.");
      return;
    }
    const scores = computeDISCFromAnswers();
    const profile = determineMainProfile(scores);
    const interpretation = interpretProfile(profile, scores);
    await saveResult(scores, profile);
    renderResultView(scores, profile, interpretation);
    showSection("results");
  }

  /******************** CÁLCULO DISC ********************/
  function computeDISCFromAnswers() {
    const mostCounts = { D: 0, I: 0, S: 0, C: 0 };
    const leastCounts = { D: 0, I: 0, S: 0, C: 0 };

    testAnswers.forEach((ans, groupIndex) => {
      const group = TEST_GROUPS[groupIndex];
      const mostDim = group.words[ans.most].dim;
      const leastDim = group.words[ans.least].dim;
      mostCounts[mostDim]++;
      leastCounts[leastDim]++;
    });

    return {
      D: mostCounts.D - leastCounts.D,
      I: mostCounts.I - leastCounts.I,
      S: mostCounts.S - leastCounts.S,
      C: mostCounts.C - leastCounts.C,
      most: mostCounts,
      least: leastCounts
    };
  }

  function determineMainProfile(scores) {
    const base = { D: scores.D, I: scores.I, S: scores.S, C: scores.C };
    let maxDim = "D";
    let maxVal = base.D;
    ["I", "S", "C"].forEach(dim => {
      if (base[dim] > maxVal) {
        maxVal = base[dim];
        maxDim = dim;
      }
    });
    return maxDim;
  }

  function interpretProfile(mainDim, scores) {
    const dimNames = {
      D: "Dominancia (D)",
      I: "Influencia (I)",
      S: "Estabilidad (S)",
      C: "Cumplimiento (C)"
    };

    let mainDesc = "";
    let details = "";

    if (mainDim === "D") {
      mainDesc =
        "El resultado sugiere un estilo predominante de Dominancia. " +
        "Las personas con este perfil suelen enfocarse en resultados concretos, retos y logros visibles. " +
        "Tienden a tomar decisiones rápidas, asumir riesgos calculados y sentirse cómodas en contextos de presión o cambio.";
      details =
        "<strong>Fortalezas habituales:</strong><br>" +
        "• Capacidad para dirigir y tomar decisiones sin paralizarse.<br>" +
        "• Orientación clara a objetivos y cumplimiento de metas exigentes.<br>" +
        "• Rapidez para abordar problemas y remover obstáculos.<br><br>" +
        "<strong>Riesgos o puntos a cuidar:</strong><br>" +
        "• Puede parecer impaciente o poco sensible ante el ritmo de otras personas.<br>" +
        "• Tendencia a priorizar el resultado por encima del proceso o la relación.<br>" +
        "• Puede subestimar detalles o procedimientos cuando los considera burocráticos.<br><br>" +
        "<strong>Entornos donde suele rendir mejor:</strong><br>" +
        "• Puestos con responsabilidad clara sobre resultados, toma de decisiones y solución de problemas.<br>" +
        "• Ambientes donde se valoren la iniciativa, la autonomía y la capacidad de respuesta rápida.";
    } else if (mainDim === "I") {
      mainDesc =
        "El resultado sugiere un estilo predominante de Influencia. " +
        "Las personas con este perfil se caracterizan por su orientación a las relaciones, la comunicación y la persuasión. " +
        "Tienden a generar ambientes cordiales, motivar a otros y construir redes de apoyo.";
      details =
        "<strong>Fortalezas habituales:</strong><br>" +
        "• Habilidad para establecer confianza y cercanía con diferentes personas.<br>" +
        "• Facilidad para comunicar ideas, motivar y generar compromiso en el equipo.<br>" +
        "• Capacidad para adaptarse socialmente a distintos contextos y perfiles.<br><br>" +
        "<strong>Riesgos o puntos a cuidar:</strong><br>" +
        "• Puede perder interés en tareas muy rutinarias o solitarias.<br>" +
        "• Tendencia a ser optimista y subestimar tiempos, detalles o riesgos.<br>" +
        "• Puede evitar confrontaciones necesarias para mantener la armonía del grupo.<br><br>" +
        "<strong>Entornos donde suele rendir mejor:</strong><br>" +
        "• Funciones que incluyan atención a usuarios, trabajo en equipo, docencia, coordinación o liderazgo participativo.<br>" +
        "• Espacios donde se valore la comunicación abierta y el intercambio de ideas.";
    } else if (mainDim === "S") {
      mainDesc =
        "El resultado sugiere un estilo predominante de Estabilidad. " +
        "Las personas con este perfil suelen ser constantes, pacientes y confiables. " +
        "Prefieren entornos predecibles, colaborativos y con ritmos de trabajo sostenidos.";
      details =
        "<strong>Fortalezas habituales:</strong><br>" +
        "• Perseverancia y consistencia en el seguimiento de tareas y procesos.<br>" +
        "• Disposición para apoyar a otras personas y mantener la armonía del equipo.<br>" +
        "• Capacidad para trabajar bajo metodologías estables y cumplir compromisos a largo plazo.<br><br>" +
        "<strong>Riesgos o puntos a cuidar:</strong><br>" +
        "• Puede mostrar resistencia ante cambios bruscos o decisiones apresuradas.<br>" +
        "• Tendencia a posponer conversaciones difíciles para evitar conflictos.<br>" +
        "• Puede sentirse saturado si no se le da tiempo suficiente para adaptarse a nuevas formas de trabajo.<br><br>" +
        "<strong>Entornos donde suele rendir mejor:</strong><br>" +
        "• Áreas donde se requiera continuidad, atención cuidadosa y soporte al equipo o a las personas usuarias.<br>" +
        "• Equipos con estructura clara, roles definidos y cambios planificados.";
    } else if (mainDim === "C") {
      mainDesc =
        "El resultado sugiere un estilo predominante de Cumplimiento. " +
        "Las personas con este perfil se orientan al detalle, la calidad y la observancia de normas o lineamientos. " +
        "Suelen analizar la información con cuidado antes de actuar y buscan minimizar errores.";
      details =
        "<strong>Fortalezas habituales:</strong><br>" +
        "• Alta precisión en tareas que requieren revisión cuidadosa de información o datos.<br>" +
        "• Respeto por los procedimientos, la evidencia y los estándares de calidad.<br>" +
        "• Capacidad para detectar inconsistencias, riesgos o fallas en procesos.<br><br>" +
        "<strong>Riesgos o puntos a cuidar:</strong><br>" +
        "• Puede detenerse demasiado tiempo en el análisis antes de tomar decisiones.<br>" +
        "• Tendencia a ser autocrítico o exigente con el propio desempeño y el de otras personas.<br>" +
        "• Puede percibirse como rígido cuando defiende normas o procedimientos técnicos.<br><br>" +
        "<strong>Entornos donde suele rendir mejor:</strong><br>" +
        "• Actividades que implican revisión, control de calidad, auditoría, análisis de información o cumplimiento normativo.<br>" +
        "• Puestos donde se valoren la exactitud, la documentación y la trazabilidad de los procesos.";
    } else {
      mainDesc =
        "El perfil muestra una combinación equilibrada de las dimensiones DISC, sin un rasgo claramente predominante. " +
        "Esto puede asociarse con flexibilidad y capacidad de adaptación a diferentes contextos laborales.";
      details =
        "En estos casos es útil revisar con más detalle los puntajes individuales (D, I, S, C) y el contexto de trabajo de la persona, " +
        "para identificar en qué situaciones utiliza más cada estilo y qué ajustes pueden favorecer su desempeño.";
    }

    return { title: "Perfil predominante: " + (dimNames[mainDim] || mainDim), mainDesc, details };
  }

  /******************** GUARDADO Y MOSTRADO DE RESULTADOS ********************/
  async function saveResult(scores, mainDim) {
    const existingLocal = readLocal(STORAGE_KEYS.resultados, []);
    const now = new Date();
    const fecha = now.toISOString().slice(0, 10) + " " + now.toTimeString().slice(0, 8);
    const fechaEpoch = now.getTime();
    const w = currentWorkerData;

    const record = {
      fecha,
      fechaEpoch,
      ...w,
      scores: { D: scores.D, I: scores.I, S: scores.S, C: scores.C },
      perfil: mainDim
    };

    // Guarda local
    existingLocal.push(record);
    writeLocal(STORAGE_KEYS.resultados, existingLocal);

    // Intenta guardar en Firestore, si está configurado
    if (db) {
      try {
        await addDoc(collection(db, "pdl_resultados"), record);
      } catch (err) {
        console.error("Error guardando en Firestore:", err);
        alert("El resultado se guardó localmente, pero hubo un problema con la base de datos en la nube.");
      }
    }

    await loadResults(); // refresca cache y tabla
  }

  function renderResultView(scores, mainDim, interp) {
    const w = currentWorkerData;
    const personalDiv = document.getElementById("result-personal");
    const scoresDiv = document.getElementById("result-scores");
    const interpDiv = document.getElementById("result-interpretation");

    personalDiv.innerHTML = `
      <h3>Datos del trabajador</h3>
      <div class="form-grid" style="margin-top:0.4rem;">
        <div><strong>Nombre:</strong> ${w.nombre}</div>
        <div><strong>Matrícula:</strong> ${w.matricula}</div>
        <div><strong>Unidad:</strong> ${w.unidad}</div>
        <div><strong>Categoría:</strong> ${w.categoria}</div>
        <div><strong>Puesto:</strong> ${w.puesto}</div>
        <div><strong>Edad:</strong> ${w.edad} años</div>
        <div><strong>Fecha de nacimiento:</strong> ${w.fechaNacimiento}</div>
        <div><strong>Lugar de nacimiento:</strong> ${w.lugarNacimiento}</div>
      </div>
    `;

    scoresDiv.innerHTML = `
      <h3>Puntajes por dimensión DISC</h3>
      <div class="form-grid" style="margin-top:0.4rem;">
        <div><strong>D – Dominancia:</strong> ${scores.D} (Más: ${scores.most.D}, Menos: ${scores.least.D})</div>
        <div><strong>I – Influencia:</strong> ${scores.I} (Más: ${scores.most.I}, Menos: ${scores.least.I})</div>
        <div><strong>S – Estabilidad:</strong> ${scores.S} (Más: ${scores.most.S}, Menos: ${scores.least.S})</div>
        <div><strong>C – Cumplimiento:</strong> ${scores.C} (Más: ${scores.most.C}, Menos: ${scores.least.C})</div>
      </div>
    `;

    interpDiv.innerHTML = `
      <h3>Interpretación del perfil</h3>
      <p><span class="badge">${interp.title}</span></p>
      <p>${interp.mainDesc}</p>
      <p class="text-muted">${interp.details}</p>
    `;
  }

  function resetForNewTest() {
    currentWorkerData = null;
    ["unidad","matricula","nombre","categoria","puesto",
     "fechaNacimiento","edad","lugarNacimiento"].forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      if (el.tagName === "SELECT") el.value = "";
      else el.value = "";
    });
    testAnswers = TEST_GROUPS.map(() => ({ most: null, least: null }));
    currentGroupIndex = 0;
    showSection("worker");
  }

  /******************** ADMIN: LOGIN Y TABS ********************/
  function tryAdminLogin() {
    const input = document.getElementById("adminPasswordInput").value;
    const errorEl = document.getElementById("admin-access-error");
    if (input === ADMIN_PASSWORD) {
      errorEl.classList.add("hidden");
      showSection("admin");
      refreshAdminTables();
      loadResults(); // carga resultados (Firestore + local)
    } else {
      errorEl.classList.remove("hidden");
    }
  }

  function setAdminTab(tabName) {
    document.getElementById("admin-unidades").classList.add("hidden");
    document.getElementById("admin-categorias").classList.add("hidden");
    document.getElementById("admin-resultados").classList.add("hidden");
    document.getElementById("tab-unidades").classList.remove("active");
    document.getElementById("tab-categorias").classList.remove("active");
    document.getElementById("tab-resultados").classList.remove("active");

    if (tabName === "unidades") {
      document.getElementById("admin-unidades").classList.remove("hidden");
      document.getElementById("tab-unidades").classList.add("active");
    } else if (tabName === "categorias") {
      document.getElementById("admin-categorias").classList.remove("hidden");
      document.getElementById("tab-categorias").classList.add("active");
    } else if (tabName === "resultados") {
      document.getElementById("admin-resultados").classList.remove("hidden");
      document.getElementById("tab-resultados").classList.add("active");
    }
  }

  function refreshAdminTables() {
    refreshUnidadesTable();
    refreshCategoriasTable();
    refreshResultadosTable();
  }

  /******************** ADMIN: UNIDADES ********************/
  function refreshUnidadesTable() {
    const unidades = readLocal(STORAGE_KEYS.unidades, []);
    const tbody = document.getElementById("tablaUnidades");
    if (!tbody) return;
    tbody.innerHTML = "";
    unidades.forEach((u, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${u}</td>
        <td><button class="btn-danger" type="button" onclick="deleteUnidad(${idx})">Borrar</button></td>
      `;
      tbody.appendChild(tr);
    });
    populateWorkerSelects();
  }

  function addUnidad() {
    const input = document.getElementById("nuevaUnidad");
    const val = input.value.trim();
    if (!val) return;
    const unidades = readLocal(STORAGE_KEYS.unidades, []);
    unidades.push(val);
    writeLocal(STORAGE_KEYS.unidades, unidades);
    input.value = "";
    refreshUnidadesTable();
  }

  function deleteUnidad(index) {
    const unidades = readLocal(STORAGE_KEYS.unidades, []);
    if (index >= 0 && index < unidades.length) {
      unidades.splice(index, 1);
      writeLocal(STORAGE_KEYS.unidades, unidades);
      refreshUnidadesTable();
    }
  }

  /******************** ADMIN: CATEGORÍAS ********************/
  function refreshCategoriasTable() {
    const categorias = readLocal(STORAGE_KEYS.categorias, []);
    const tbody = document.getElementById("tablaCategorias");
    if (!tbody) return;
    tbody.innerHTML = "";
    categorias.forEach((c, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${c}</td>
        <td><button class="btn-danger" type="button" onclick="deleteCategoria(${idx})">Borrar</button></td>
      `;
      tbody.appendChild(tr);
    });
    populateWorkerSelects();
  }

  function addCategoria() {
    const input = document.getElementById("nuevaCategoria");
    const val = input.value.trim();
    if (!val) return;
    const categorias = readLocal(STORAGE_KEYS.categorias, []);
    categorias.push(val);
    writeLocal(STORAGE_KEYS.categorias, categorias);
    input.value = "";
    refreshCategoriasTable();
  }

  function deleteCategoria(index) {
    const categorias = readLocal(STORAGE_KEYS.categorias, []);
    if (index >= 0 && index < categorias.length) {
      categorias.splice(index, 1);
      writeLocal(STORAGE_KEYS.categorias, categorias);
      refreshCategoriasTable();
    }
  }

  /******************** ADMIN: RESULTADOS & CSV ********************/
  async function loadResults() {
    // Prioridad: Firestore (si está disponible), luego localStorage
    let fromFirestore = [];
    if (db) {
      try {
        const qRef = query(collection(db, "pdl_resultados"), orderBy("fechaEpoch", "desc"));
        const snap = await getDocs(qRef);
        fromFirestore = snap.docs.map(d => d.data());
      } catch (err) {
        console.error("Error leyendo Firestore:", err);
      }
    }
    if (fromFirestore.length) {
      resultadosCache = fromFirestore;
    } else {
      resultadosCache = readLocal(STORAGE_KEYS.resultados, []);
    }
    refreshResultadosTable();
  }

  function refreshResultadosTable() {
    const tbody = document.getElementById("tablaResultados");
    if (!tbody) return;
    tbody.innerHTML = "";
    resultadosCache.forEach(r => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.fecha}</td>
        <td>${r.unidad}</td>
        <td>${r.matricula}</td>
        <td>${r.nombre}</td>
        <td>${r.categoria}</td>
        <td>${r.puesto}</td>
        <td>${r.edad}</td>
        <td>${r.lugarNacimiento}</td>
        <td>${r.scores.D}</td>
        <td>${r.scores.I}</td>
        <td>${r.scores.S}</td>
        <td>${r.scores.C}</td>
        <td>${r.perfil}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function downloadCSV() {
    const data = resultadosCache.length ? resultadosCache : readLocal(STORAGE_KEYS.resultados, []);
    if (!data.length) {
      alert("No hay resultados para descargar.");
      return;
    }
    const sep = ",";
    const header = [
      "Fecha","Unidad","Matricula","Nombre","Categoria","Puesto",
      "Edad","LugarNacimiento","D","I","S","C","Perfil"
    ];
    const lines = [header.join(sep)];
    data.forEach(r => {
      const row = [
        r.fecha,r.unidad,r.matricula,r.nombre,r.categoria,r.puesto,
        r.edad,r.lugarNacimiento,r.scores.D,r.scores.I,r.scores.S,r.scores.C,r.perfil
      ];
      const escaped = row.map(v => {
        const value = v != null ? String(v) : "";
        if (value.includes('"') || value.includes(",") || value.includes("\n")) {
          return '"' + value.replace(/"/g, '""') + '"';
        }
        return value;
      });
      lines.push(escaped.join(sep));
    });
    const csvContent = lines.join("\r\n");
    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "resultados_PDL.csv";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function clearAllResults() {
    if (!confirm("¿Está seguro de borrar los resultados almacenados localmente?")) return;
    writeLocal(STORAGE_KEYS.resultados, []);
    resultadosCache = [];
    refreshResultadosTable();
  }

  /******************** INICIALIZACIÓN ********************/
  function initPDLApp() {
    ensureDefaultConfig();
    populateWorkerSelects();
    resultadosCache = readLocal(STORAGE_KEYS.resultados, []);
    refreshResultadosTable();
    showSection("worker");
  }
  document.addEventListener("DOMContentLoaded", initPDLApp);

  /******************** EXPONER FUNCIONES AL HTML ********************/
  window.showSection = showSection;
  window.showAdminAccess = showAdminAccess;
  window.startTest = startTest;
  window.nextGroup = nextGroup;
  window.prevGroup = prevGroup;
  window.finishTest = finishTest;
  window.resetForNewTest = resetForNewTest;
  window.tryAdminLogin = tryAdminLogin;
  window.setAdminTab = setAdminTab;
  window.addUnidad = addUnidad;
  window.deleteUnidad = deleteUnidad;
  window.addCategoria = addCategoria;
  window.deleteCategoria = deleteCategoria;
  window.downloadCSV = downloadCSV;
  window.clearAllResults = clearAllResults;
</script>
</body>
</html>
