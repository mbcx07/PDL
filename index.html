 <!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Perfil de Dinámicas Laborales (PDL)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --imss:#006657; --imss2:#134E39; --soft:#e6f2ef;
      --gold:#BC955C; --bg:#f5f7f6; --text:#222; --muted:#777; --danger:#c62828;
      --shadow:0 2px 6px rgba(0,0,0,.08); --r:10px;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;}
    body{margin:0;background:var(--bg);color:var(--text);}
    header{background:#fff;box-shadow:var(--shadow);padding:.75rem 1.5rem;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:10;}
    header h1{margin:0;font-size:1.1rem;font-weight:800;color:var(--imss2);}
    header nav a{margin-left:1rem;text-decoration:none;font-size:.9rem;color:var(--imss);cursor:pointer;}
    header nav a:hover{text-decoration:underline;}
    main{max-width:1100px;margin:1.5rem auto 2.5rem;padding:0 1rem;}
    .card{background:#fff;border-radius:var(--r);box-shadow:var(--shadow);padding:1.3rem 1.5rem;margin-bottom:1.25rem;}
    h2{margin:0 0 .6rem;font-size:1.25rem;color:var(--imss2);}
    h3{margin:.9rem 0 .4rem;font-size:1.05rem;color:var(--imss2);}
    .subtitle{margin:.2rem 0 .9rem;color:var(--muted);font-size:.92rem;}
    .pill{display:inline-block;padding:.15rem .6rem;border-radius:999px;font-size:.75rem;background:var(--soft);color:var(--imss2);margin-left:.4rem;font-weight:700;}
    .badge{display:inline-block;padding:.16rem .55rem;border-radius:999px;background:var(--gold);color:#fff;font-size:.78rem;font-weight:800;}

    .hidden{display:none!important;}
    .text-muted{color:var(--muted);font-size:.84rem;}
    .error{color:var(--danger);font-size:.82rem;margin-top:.25rem;}

    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:.8rem 1rem;}
    label{display:block;font-weight:700;font-size:.8rem;margin-bottom:.2rem;}
    input,select,textarea{width:100%;padding:.48rem .58rem;border-radius:6px;border:1px solid #cfd4d1;font-size:.92rem;background:#fff;}
    input:focus,select:focus,textarea:focus{outline:2px solid var(--soft);border-color:var(--imss);}
    textarea{resize:vertical;min-height:90px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}

    .btn-row{margin-top:1rem;display:flex;flex-wrap:wrap;gap:.6rem;}
    button{border:none;border-radius:8px;padding:.5rem .95rem;font-size:.92rem;cursor:pointer;}
    .btn-primary{background:var(--imss);color:#fff;}
    .btn-secondary{background:#e0e4e2;color:#333;}
    .btn-danger{background:var(--danger);color:#fff;}
    .btn-success{background:var(--imss2);color:#fff;}
    .btn-link{background:transparent;color:var(--imss);padding-left:0;}
    .btn-disabled{background:#cfd4d1!important;color:#888!important;cursor:default!important;opacity:.75;}

    /* Test UI */
    .block-header{display:flex;justify-content:space-between;align-items:center;gap:.5rem;flex-wrap:wrap;color:var(--muted);font-size:.88rem;margin-bottom:.55rem;}
    .progress-wrap{display:flex;align-items:center;gap:.45rem;min-width:180px;}
    .bar{background:#dde3df;border-radius:999px;height:7px;flex:1;overflow:hidden;}
    .bar>div{height:100%;width:0%;background:var(--imss);transition:width .2s ease;}
    .pct{min-width:38px;text-align:right;font-size:.82rem;}
    .test-title{text-align:center;font-weight:900;font-size:1.12rem;margin:.55rem 0 .25rem;}
    .test-sub{text-align:center;color:var(--muted);font-size:.88rem;margin:0 0 .9rem;}

    .table-like{border:1px solid #e0e4e2;border-radius:12px;overflow:hidden;}
    .t-head,.t-row{display:grid;grid-template-columns:minmax(0,1.6fr) 90px 90px;align-items:center;padding:.6rem .85rem;}
    .t-head{background:var(--soft);color:var(--imss2);font-weight:800;font-size:.82rem;}
    .t-row{border-top:1px solid #edf1ee;font-size:.94rem;background:#fff;}
    .t-row:nth-child(even){background:#fafcfb;}
    .cell-center{display:flex;justify-content:center;}

    .radio{
      appearance:none;-webkit-appearance:none;width:22px;height:22px;border-radius:50%;
      border:2px solid #cfd4d1;background:#fff;cursor:pointer;position:relative;
    }
    .radio::after{content:"";position:absolute;inset:4px;border-radius:50%;background:transparent;}
    .radio.plus:checked{border-color:var(--imss);background:var(--imss);}
    .radio.plus:checked::after{background:#fff;}
    .radio.minus:checked{border-color:var(--danger);background:var(--danger);}
    .radio.minus:checked::after{background:#fff;}

    .footer{margin-top:1rem;display:flex;justify-content:space-between;align-items:center;gap:.6rem;flex-wrap:wrap;}

    /* Admin */
    .tabs{display:flex;flex-wrap:wrap;gap:.35rem;margin-bottom:.7rem;}
    .tabs button{font-size:.84rem;padding:.4rem .75rem;}
    .tabs button.active{background:var(--imss);color:#fff;}
    table{width:100%;border-collapse:collapse;font-size:.82rem;}
    th,td{border:1px solid #dde2df;padding:.35rem .45rem;vertical-align:top;}
    th{background:var(--soft);color:var(--imss2);font-weight:900;}
    tbody tr:nth-child(even){background:#fafcfb;}
    .scroll{max-height:380px;overflow:auto;border-radius:10px;border:1px solid #dde2df;}

    /* Modal */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:100;}
    .modal{background:#fff;border-radius:12px;box-shadow:0 10px 28px rgba(0,0,0,.28);padding:1.1rem 1.2rem;max-width:430px;width:100%;}
    .modal h3{margin:0 0 .35rem;}
    .modal .actions{display:flex;justify-content:flex-end;gap:.5rem;margin-top:.9rem;}

    /* Charts */
    .charts{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem;margin-top:.8rem;}
    .chart-card{background:#fafcfb;border:1px solid #e0e4e2;border-radius:12px;padding:.75rem .85rem;}
    .chart-title{font-weight:900;color:var(--imss2);font-size:.9rem;margin-bottom:.35rem;}
    .warn{border:1px solid #f0d3b2;background:#fff7ee;color:#7a4a12;border-radius:10px;padding:.65rem .75rem;margin:.6rem 0;}
    .ok{border:1px solid #cfe7df;background:#f4fffb;color:#0f5132;border-radius:10px;padding:.65rem .75rem;margin:.6rem 0;}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
    @media (max-width:680px){ .t-head,.t-row{grid-template-columns:minmax(0,1.5fr) 76px 76px;padding-inline:.6rem;} }
  </style>
</head>
<body>
<header>
  <h1>Perfil de Dinámicas Laborales (PDL)</h1>
  <nav>
    <a onclick="showSection('worker')">Inicio</a>
    <a onclick="showSection('worker')">Aplicar test</a>
    <a onclick="requestAdminAccess()">Administrador</a>
  </nav>
</header>

<main>
  <!-- Worker -->
  <section id="section-worker" class="card">
    <h2>Datos del trabajador <span class="pill">Paso 1 de 3</span></h2>
    <p class="subtitle">Capture los datos antes de iniciar el <strong>Test PDL</strong>.</p>

    <div class="form-grid">
      <div>
        <label for="unidad">Unidad *</label>
        <select id="unidad"></select>
        <div id="unidad-error" class="error hidden">Seleccione una unidad.</div>
      </div>
      <div>
        <label for="matricula">Matrícula *</label>
        <input id="matricula" type="text" />
        <div id="matricula-error" class="error hidden">Capture la matrícula.</div>
      </div>
      <div>
        <label for="nombre">Nombre completo *</label>
        <input id="nombre" type="text" />
        <div id="nombre-error" class="error hidden">Capture el nombre completo.</div>
      </div>
      <div>
        <label for="categoria">Categoría *</label>
        <select id="categoria"></select>
        <div id="categoria-error" class="error hidden">Seleccione una categoría.</div>
      </div>
      <div>
        <label for="puesto">Puesto que desempeña en el servicio *</label>
        <input id="puesto" type="text" />
        <div id="puesto-error" class="error hidden">Capture el puesto.</div>
      </div>
      <div>
        <label for="fechaNacimiento">Fecha de nacimiento *</label>
        <input id="fechaNacimiento" type="date" />
        <div id="fechaNacimiento-error" class="error hidden">Capture la fecha de nacimiento.</div>
      </div>
      <div>
        <label for="edad">Edad (años)</label>
        <input id="edad" type="text" readonly />
      </div>
      <div>
        <label for="lugarNacimiento">Lugar de nacimiento *</label>
        <input id="lugarNacimiento" type="text" />
        <div id="lugarNacimiento-error" class="error hidden">Capture el lugar de nacimiento.</div>
      </div>
    </div>

    <div class="btn-row">
      <button class="btn-primary" type="button" onclick="startTest()">Iniciar test PDL</button>
      <button class="btn-link" type="button" onclick="requestAdminAccess()">Acceso administrador</button>
    </div>

    <p class="text-muted">
      Importante: para que los resultados queden 100% alineados al manual, en Administrador se cargan las <strong>Normas</strong>.
      (Yo ya lo dejé listo para que solo pegues el bloque cuando te lo entregue).
    </p>
  </section>

  <!-- Test -->
  <section id="section-test" class="card hidden">
    <div class="block-header">
      <div id="block-label">Bloque 1 de 24</div>
      <div class="progress-wrap">
        <div class="bar"><div id="bar-fill"></div></div>
        <div id="bar-pct" class="pct">0%</div>
      </div>
    </div>

    <div class="test-title">Seleccione la palabra que MÁS (+) y MENOS (-) lo describe</div>
    <div class="test-sub">En cada bloque seleccione una como <strong>MÁS</strong> y otra como <strong>MENOS</strong>.</div>

    <div id="group"></div>
    <div id="test-error" class="error hidden" style="margin-top:.55rem;"></div>

    <div class="footer">
      <div class="text-muted">Debe elegir una opción en ambas columnas para continuar.</div>
      <div class="btn-row" style="margin:0;">
        <button id="btn-prev" class="btn-secondary" type="button" onclick="prevGroup()">Anterior</button>
        <button id="btn-next" class="btn-primary" type="button" onclick="nextGroup()">Siguiente</button>
        <button id="btn-finish" class="btn-success" type="button" onclick="finishTest()">Finalizar test</button>
      </div>
    </div>
  </section>

  <!-- Results -->
  <section id="section-results" class="card hidden">
    <h2>Resultados del PDL <span class="pill">Paso 3 de 3</span></h2>
    <div id="validity"></div>
    <div id="res-personal"></div>
    <div id="res-raw"></div>
    <div id="res-g"></div>

    <h3>Gráficas (G 0–100)</h3>
    <p class="text-muted">Gráfica <strong>M</strong> (Motivación), <strong>L</strong> (Bajo presión) y <strong>T</strong> (Conducta diaria = M − L).</p>

    <div class="charts">
      <div class="chart-card">
        <div class="chart-title">Gráfica M – Motivación</div>
        <svg id="svgM" viewBox="0 0 260 235" width="100%" height="235"></svg>
      </div>
      <div class="chart-card">
        <div class="chart-title">Gráfica L – Bajo presión</div>
        <svg id="svgL" viewBox="0 0 260 235" width="100%" height="235"></svg>
      </div>
      <div class="chart-card">
        <div class="chart-title">Gráfica T – Conducta diaria</div>
        <svg id="svgT" viewBox="0 0 260 235" width="100%" height="235"></svg>
      </div>
    </div>

    <div id="analysis"></div>
    <div id="training"></div>

    <div class="btn-row">
      <button class="btn-primary" type="button" onclick="resetForNewTest()">Aplicar a otro trabajador</button>
      <button class="btn-secondary" type="button" onclick="requestAdminAccess()">Ir a administrador</button>
    </div>
  </section>

  <!-- Admin -->
  <section id="section-admin" class="card hidden">
    <h2>Panel de administración</h2>
    <p class="subtitle">Unidades, categorías, normas y resultados (confidencial).</p>

    <div class="tabs">
      <button id="tab-u" class="btn-secondary active" type="button" onclick="setTab('u')">Unidades</button>
      <button id="tab-c" class="btn-secondary" type="button" onclick="setTab('c')">Categorías</button>
      <button id="tab-n" class="btn-secondary" type="button" onclick="setTab('n')">Normas</button>
      <button id="tab-r" class="btn-secondary" type="button" onclick="setTab('r')">Resultados</button>
    </div>

    <div id="panel-u">
      <h3>Unidades</h3>
      <div class="btn-row" style="margin-top:0;">
        <input id="newUnit" type="text" placeholder="Nombre de unidad" style="max-width:360px;" />
        <button class="btn-primary" type="button" onclick="addUnit()">Agregar</button>
      </div>
      <div class="scroll" style="margin-top:.6rem;">
        <table>
          <thead><tr><th>Unidad</th><th style="width:90px;">Acciones</th></tr></thead>
          <tbody id="tbUnits"></tbody>
        </table>
      </div>
    </div>

    <div id="panel-c" class="hidden">
      <h3>Categorías</h3>
      <div class="btn-row" style="margin-top:0;">
        <input id="newCat" type="text" placeholder="Nombre de categoría" style="max-width:360px;" />
        <button class="btn-primary" type="button" onclick="addCat()">Agregar</button>
      </div>
      <div class="scroll" style="margin-top:.6rem;">
        <table>
          <thead><tr><th>Categoría</th><th style="width:90px;">Acciones</th></tr></thead>
          <tbody id="tbCats"></tbody>
        </table>
      </div>
    </div>

    <div id="panel-n" class="hidden">
      <h3>Normas (A y múltiplos) – pegar desde el manual</h3>
      <div class="warn">
        Aquí solo se pega un bloque de texto. No ocupas saber programar.
        Yo te voy a preparar ese bloque cuando extraigamos la tabla exacta del manual.
      </div>
      <label>Normas (JSON)</label>
      <textarea id="norms" spellcheck="false" class="mono"></textarea>
      <div class="btn-row">
        <button class="btn-primary" type="button" onclick="saveNorms()">Guardar normas</button>
        <button class="btn-secondary" type="button" onclick="loadNorms()">Recargar</button>
        <button class="btn-secondary" type="button" onclick="resetNorms()">Restaurar plantilla</button>
      </div>
      <p class="text-muted">Si las normas no están cargadas, la escala G se muestra aproximada solo para visualizar.</p>
    </div>

    <div id="panel-r" class="hidden">
      <h3>Resultados</h3>
      <div class="btn-row" style="margin-top:0;">
        <button class="btn-success" type="button" onclick="downloadCSV()">Descargar CSV</button>
        <button class="btn-secondary" type="button" onclick="reloadResults()">Recargar</button>
      </div>
      <div class="scroll" style="margin-top:.6rem;">
        <table>
          <thead>
            <tr>
              <th>Fecha</th><th>Unidad</th><th>Matrícula</th><th>Nombre</th><th>Categoría</th>
              <th>M D</th><th>M I</th><th>M S</th><th>M C</th>
              <th>L D</th><th>L I</th><th>L S</th><th>L C</th>
              <th>T D</th><th>T I</th><th>T S</th><th>T C</th>
              <th>ΣT</th><th>Validez</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tbRes"></tbody>
        </table>
      </div>
      <p class="text-muted" style="margin-top:.55rem;">Eliminar borra local y, si existe, también en Firestore.</p>
    </div>

    <div class="btn-row">
      <button class="btn-secondary" type="button" onclick="showSection('worker')">Volver</button>
    </div>
  </section>

  <!-- Modal admin -->
  <div id="overlay" class="overlay hidden">
    <div class="modal">
      <h3>Acceso a administrador</h3>
      <p class="text-muted">Contraseña para ver resultados confidenciales.</p>
      <label>Contraseña</label>
      <input id="adminPass" type="password" />
      <div id="passErr" class="error hidden">Contraseña incorrecta.</div>
      <div class="actions">
        <button class="btn-secondary" type="button" onclick="closeLogin()">Cancelar</button>
        <button class="btn-primary" type="button" onclick="login()">Ingresar</button>
      </div>
    </div>
  </div>
<script>
/* ================= CONFIGURACIÓN GENERAL ================= */
const ADMIN_PASSWORD = "PDL2025";

const KEYS = {
  units: "PDL_units",
  cats: "PDL_categories",
  results: "PDL_results",
  norms: "PDL_norms"
};

/* ================= UTILIDADES ================= */
const $ = id => document.getElementById(id);
const read = (k, d) => JSON.parse(localStorage.getItem(k) || JSON.stringify(d));
const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));

function showSection(id){
  ["worker","test","results","admin"].forEach(s=>{
    const el = $("section-"+s);
    if(el) el.classList.toggle("hidden", s!==id);
  });
}

/* ================= DATOS BASE ================= */
// 24 bloques × 4 palabras (equivalentes DISC, NO texto propietario)
const BLOCKS = [
  [["Decidido","D"],["Sociable","I"],["Paciente","S"],["Preciso","C"]],
  [["Competitivo","D"],["Entusiasta","I"],["Constante","S"],["Cuidadoso","C"]],
  [["Directo","D"],["Expresivo","I"],["Colaborador","S"],["Analítico","C"]],
  [["Firme","D"],["Persuasivo","I"],["Leal","S"],["Metódico","C"]],
  [["Audaz","D"],["Optimista","I"],["Sereno","S"],["Exacto","C"]],
  [["Resuelto","D"],["Inspirador","I"],["Apoyador","S"],["Ordenado","C"]],
  [["Dominante","D"],["Comunicativo","I"],["Tolerante","S"],["Disciplinado","C"]],
  [["Iniciador","D"],["Motivador","I"],["Confiable","S"],["Formal","C"]],
  [["Independiente","D"],["Amable","I"],["Estable","S"],["Precavido","C"]],
  [["Rápido","D"],["Popular","I"],["Persistente","S"],["Riguroso","C"]],
  [["Seguro","D"],["Influyente","I"],["Empático","S"],["Estructurado","C"]],
  [["Determinado","D"],["Convincente","I"],["Constante","S"],["Controlado","C"]],
  [["Arriesgado","D"],["Animado","I"],["Paciente","S"],["Minucioso","C"]],
  [["Competidor","D"],["Expansivo","I"],["Servicial","S"],["Exacto","C"]],
  [["Autoritario","D"],["Alegre","I"],["Conservador","S"],["Cuidadoso","C"]],
  [["Práctico","D"],["Conversador","I"],["Reservado","S"],["Perfeccionista","C"]],
  [["Enérgico","D"],["Optimista","I"],["Tranquilo","S"],["Sistemático","C"]],
  [["Decisor","D"],["Inspirador","I"],["Leal","S"],["Formal","C"]],
  [["Orientado a resultados","D"],["Relacionador","I"],["Estable","S"],["Normativo","C"]],
  [["Valiente","D"],["Espontáneo","I"],["Comprensivo","S"],["Detallista","C"]],
  [["Competente","D"],["Asertivo","I"],["Persistente","S"],["Meticuloso","C"]],
  [["Ejecutor","D"],["Social","I"],["Paciente","S"],["Exacto","C"]],
  [["Firme","D"],["Comunicador","I"],["Solidario","S"],["Cuidadoso","C"]],
  [["Decisivo","D"],["Motivador","I"],["Constante","S"],["Analítico","C"]],
];

/* ================= ESTADO ================= */
let idx = 0;
let answers = Array(BLOCKS.length).fill(null);

/* ================= INICIALIZACIÓN ================= */
(function init(){
  ensureBase();
  loadSelects();
})();

function ensureBase(){
  if(!read(KEYS.units,null) || read(KEYS.units,[]).length===0)
    save(KEYS.units,["Unidad 1"]);
  if(!read(KEYS.cats,null) || read(KEYS.cats,[]).length===0)
    save(KEYS.cats,["Categoría A"]);
  if(!read(KEYS.results,null))
    save(KEYS.results,[]);
}

/* ================= CARÁTULA ================= */
$("fechaNacimiento").addEventListener("change",()=>{
  const f=new Date($("fechaNacimiento").value);
  if(!isNaN(f)){
    const diff=Date.now()-f.getTime();
    $("edad").value=Math.abs(new Date(diff).getUTCFullYear()-1970);
  }
});

function loadSelects(){
  const u=$("unidad"), c=$("categoria");
  u.innerHTML=""; c.innerHTML="";
  read(KEYS.units,[]).forEach(v=>u.add(new Option(v,v)));
  read(KEYS.cats,[]).forEach(v=>c.add(new Option(v,v)));
}

function startTest(){
  let ok=true;
  ["unidad","matricula","nombre","categoria","puesto","fechaNacimiento","lugarNacimiento"]
  .forEach(id=>{
    if(!$(id).value){ ok=false; $(id+"-error")?.classList.remove("hidden"); }
    else $(id+"-error")?.classList.add("hidden");
  });
  if(!ok) return;
  idx=0;
  answers=Array(BLOCKS.length).fill(null);
  renderGroup();
  showSection("test");
}

/* ================= TEST ================= */
function renderGroup(){
  $("block-label").textContent=`Bloque ${idx+1} de ${BLOCKS.length}`;
  const pct=Math.round((idx/BLOCKS.length)*100);
  $("bar-fill").style.width=pct+"%";
  $("bar-pct").textContent=pct+"%";

  const g=BLOCKS[idx];
  let html=`<div class="table-like">
    <div class="t-head"><div>Palabra</div><div class="cell-center">MÁS</div><div class="cell-center">MENOS</div></div>`;
  g.forEach((w,i)=>{
    html+=`
    <div class="t-row">
      <div>${w[0]}</div>
      <div class="cell-center">
        <input type="radio" class="radio plus" name="p${idx}" onclick="pick(${i},'M')">
      </div>
      <div class="cell-center">
        <input type="radio" class="radio minus" name="m${idx}" onclick="pick(${i},'L')">
      </div>
    </div>`;
  });
  html+="</div>";
  $("group").innerHTML=html;

  if(answers[idx]){
    document.querySelectorAll(`input[name=p${idx}]`)[answers[idx].M].checked=true;
    document.querySelectorAll(`input[name=m${idx}]`)[answers[idx].L].checked=true;
  }

  $("btn-prev").classList.toggle("hidden",idx===0);
  $("btn-next").classList.toggle("hidden",idx===BLOCKS.length-1);
  $("btn-finish").classList.toggle("hidden",idx!==BLOCKS.length-1);
}

window.pick=function(i,t){
  answers[idx]=answers[idx]||{};
  answers[idx][t]=i;
  if(answers[idx].M===answers[idx].L){
    $("test-error").textContent="No puede elegir la misma palabra como MÁS y MENOS.";
    $("test-error").classList.remove("hidden");
    answers[idx][t]=null;
    renderGroup();
  }else $("test-error").classList.add("hidden");
};

window.nextGroup=function(){
  if(!answers[idx]||answers[idx].M==null||answers[idx].L==null){
    $("test-error").textContent="Seleccione una opción en ambas columnas.";
    $("test-error").classList.remove("hidden"); return;
  }
  idx++; renderGroup();
};

window.prevGroup=function(){ idx--; renderGroup(); };

/* ================= CÁLCULO M / L / T ================= */
function computeRaw(){
  const M={D:0,I:0,S:0,C:0}, L={D:0,I:0,S:0,C:0};
  answers.forEach((a,i)=>{
    const g=BLOCKS[i];
    M[g[a.M][1]]++;
    L[g[a.L][1]]++;
  });
  const T={D:M.D-L.D,I:M.I-L.I,S:M.S-L.S,C:M.C-L.C};
  return {M,L,T};
}

window.finishTest=function(){
  const raw=computeRaw();
  const sumT=raw.T.D+raw.T.I+raw.T.S+raw.T.C;
  const valid = sumT>=-3 && sumT<=3;

  showSection("results");
  $("validity").innerHTML = valid
    ? `<div class="ok"><strong>Prueba válida.</strong> ΣT=${sumT}</div>`
    : `<div class="warn"><strong>Prueba inválida.</strong> ΣT=${sumT}</div>`;

  $("res-raw").innerHTML=`
    <h3>Resultados crudos</h3>
    <p class="mono">M: D ${raw.M.D}, I ${raw.M.I}, S ${raw.M.S}, C ${raw.M.C}</p>
    <p class="mono">L: D ${raw.L.D}, I ${raw.L.I}, S ${raw.L.S}, C ${raw.L.C}</p>
    <p class="mono">T: D ${raw.T.D}, I ${raw.T.I}, S ${raw.T.S}, C ${raw.T.C}</p>`;

  saveResult(raw,valid);
};

/* ================= GUARDAR ================= */
function saveResult(raw,valid){
  const arr=read(KEYS.results,[]);
  arr.push({
    date:new Date().toISOString(),
    unidad:$("unidad").value,
    matricula:$("matricula").value,
    nombre:$("nombre").value,
    categoria:$("categoria").value,
    M:raw.M,L:raw.L,T:raw.T,sumT:raw.T.D+raw.T.I+raw.T.S+raw.T.C,valid
  });
  save(KEYS.results,arr);
}

/* ================= ADMIN LOGIN ================= */
window.requestAdminAccess=function(){ $("overlay").classList.remove("hidden"); };
window.closeLogin=function(){ $("overlay").classList.add("hidden"); };
window.login=function(){
  if($("adminPass").value===ADMIN_PASSWORD){
    $("overlay").classList.add("hidden");
    showSection("admin");
    loadAdmin();
  }else $("passErr").classList.remove("hidden");
};

</script>
<!-- ================= FIN PARTE 2/4 ================= -->
  <script>
/* ================== EXPONER FUNCIONES AL HTML ==================
   (Esto SOLO funciona si en Parte 2 cambiaste <script type="module"> por <script>)
*/
window.showSection = showSection;
window.startTest = startTest;

/* ================== ADMIN: CRUD UNIDADES / CATEGORÍAS ================== */
function loadAdmin(){
  // refresca selects por si se agregaron
  loadSelects();
  renderUnits();
  renderCats();
  renderResults();
  loadNorms();
}

function renderUnits(){
  const tb = $("tbUnits");
  tb.innerHTML = "";
  const units = read(KEYS.units, []);
  units.forEach((u,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${escapeHtml(u)}</td>
      <td><button class="btn-danger" type="button" onclick="delUnit(${i})">Borrar</button></td>`;
    tb.appendChild(tr);
  });
}

function renderCats(){
  const tb = $("tbCats");
  tb.innerHTML = "";
  const cats = read(KEYS.cats, []);
  cats.forEach((c,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${escapeHtml(c)}</td>
      <td><button class="btn-danger" type="button" onclick="delCat(${i})">Borrar</button></td>`;
    tb.appendChild(tr);
  });
}

window.addUnit = function(){
  const val = $("newUnit").value.trim();
  if(!val) return;
  const arr = read(KEYS.units, []);
  arr.push(val);
  save(KEYS.units, arr);
  $("newUnit").value="";
  renderUnits(); loadSelects();
};

window.delUnit = function(i){
  const arr = read(KEYS.units, []);
  arr.splice(i,1);
  save(KEYS.units, arr);
  renderUnits(); loadSelects();
};

window.addCat = function(){
  const val = $("newCat").value.trim();
  if(!val) return;
  const arr = read(KEYS.cats, []);
  arr.push(val);
  save(KEYS.cats, arr);
  $("newCat").value="";
  renderCats(); loadSelects();
};

window.delCat = function(i){
  const arr = read(KEYS.cats, []);
  arr.splice(i,1);
  save(KEYS.cats, arr);
  renderCats(); loadSelects();
};

/* ================== ADMIN: TABS ================== */
window.setTab = function(t){
  ["u","c","n","r"].forEach(x=>{
    $("panel-"+x).classList.toggle("hidden", x!==t);
    $("tab-"+x).classList.toggle("active", x===t);
  });
  if(t==="r") renderResults();
  if(t==="n") loadNorms();
};

/* ================== RESULTADOS: LISTA + ELIMINAR ================== */
function renderResults(){
  const tb = $("tbRes");
  tb.innerHTML = "";
  const res = read(KEYS.results, []);
  res.slice().reverse().forEach((r,revIdx)=>{
    const realIdx = res.length - 1 - revIdx;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(r.date||"")}</td>
      <td>${escapeHtml(r.unidad||"")}</td>
      <td>${escapeHtml(r.matricula||"")}</td>
      <td>${escapeHtml(r.nombre||"")}</td>
      <td>${escapeHtml(r.categoria||"")}</td>

      <td>${r.M?.D??""}</td><td>${r.M?.I??""}</td><td>${r.M?.S??""}</td><td>${r.M?.C??""}</td>
      <td>${r.L?.D??""}</td><td>${r.L?.I??""}</td><td>${r.L?.S??""}</td><td>${r.L?.C??""}</td>
      <td>${r.T?.D??""}</td><td>${r.T?.I??""}</td><td>${r.T?.S??""}</td><td>${r.T?.C??""}</td>

      <td>${r.sumT??""}</td>
      <td>${r.valid ? "Válida" : "Inválida"}</td>
      <td><button class="btn-danger" type="button" onclick="deleteResult(${realIdx})">Eliminar</button></td>
    `;
    tb.appendChild(tr);
  });
}

window.deleteResult = function(i){
  if(!confirm("¿Eliminar este resultado?")) return;
  const res = read(KEYS.results, []);
  res.splice(i,1);
  save(KEYS.results, res);
  renderResults();
};

window.reloadResults = function(){ renderResults(); };

/* ================== EXPORTAR CSV (UTF-8 BOM) ================== */
window.downloadCSV = function(){
  const data = read(KEYS.results, []);
  if(!data.length){ alert("No hay resultados."); return; }

  const header = [
    "Fecha","Unidad","Matricula","Nombre","Categoria","Puesto","Edad","LugarNacimiento",
    "M_D","M_I","M_S","M_C",
    "L_D","L_I","L_S","L_C",
    "T_D","T_I","T_S","T_C",
    "sumT","Validez"
  ];

  const lines = [header.join(",")];

  data.forEach(r=>{
    const row = [
      r.date||"", r.unidad||"", r.matricula||"", r.nombre||"", r.categoria||"",
      r.puesto||"", r.edad||"", r.lugarNacimiento||"",
      r.M?.D??"", r.M?.I??"", r.M?.S??"", r.M?.C??"",
      r.L?.D??"", r.L?.I??"", r.L?.S??"", r.L?.C??"",
      r.T?.D??"", r.T?.I??"", r.T?.S??"", r.T?.C??"",
      r.sumT??"", r.valid ? "Válida":"Inválida"
    ];

    const esc = row.map(v=>{
      const s = String(v??"");
      if(/[",\n\r]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
      return s;
    });
    lines.push(esc.join(","));
  });

  const csv = lines.join("\r\n");
  const blob = new Blob(["\ufeff"+csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "resultados_PDL.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
};

/* ================== NORMAS (PLANTILLA POR AHORA) ==================
   En la Parte 4/4 te dejo:
   - conversión a G real (manual)
   - y el pegado simple (sin que tú armes JSON)
*/
const DEFAULT_NORMS = {
  version: 1,
  A: { M:{D:0,I:0,S:0,C:0}, L:{D:0,I:0,S:0,C:0}, T:{D:0,I:0,S:0,C:0} },
  mult: { M:{D:1,I:1,S:1,C:1}, L:{D:1,I:1,S:1,C:1}, T:{D:1,I:1,S:1,C:1} }
};

window.loadNorms = function(){
  const n = read(KEYS.norms, DEFAULT_NORMS);
  $("norms").value = JSON.stringify(n,null,2);
};

window.resetNorms = function(){
  if(!confirm("¿Restaurar plantilla de normas?")) return;
  save(KEYS.norms, DEFAULT_NORMS);
  loadNorms();
};

window.saveNorms = function(){
  try{
    const obj = JSON.parse($("norms").value);
    save(KEYS.norms, obj);
    alert("Normas guardadas.");
  }catch(e){
    alert("El texto de normas no es válido. No se guardó.");
  }
};

/* ================== GRÁFICAS ROMBO (placeholder) ==================
   En Parte 4/4 conecto la conversión a G real y lo dibujo con M/L/T.
*/
function drawDiamond(svgId, values, fill, stroke){
  const svg = document.getElementById(svgId);
  if(!svg) return;
  svg.innerHTML = "";

  const cx=130, cy=110, r=80;
  const dims=["D","I","S","C"];

  function pt(dim, f){
    if(dim==="D") return {x:cx, y:cy-r*f};
    if(dim==="I") return {x:cx+r*f, y:cy};
    if(dim==="S") return {x:cx, y:cy+r*f};
    return {x:cx-r*f, y:cy}; // C
  }

  // rejilla
  [0.25,0.5,0.75,1].forEach(lvl=>{
    const p = dims.map(d=>pt(d,lvl));
    const d = `M ${p[0].x} ${p[0].y} L ${p[1].x} ${p[1].y} L ${p[2].x} ${p[2].y} L ${p[3].x} ${p[3].y} Z`;
    const path = document.createElementNS("http://www.w3.org/2000/svg","path");
    path.setAttribute("d", d);
    path.setAttribute("fill","none");
    path.setAttribute("stroke","#dde3df");
    svg.appendChild(path);
  });

  // ejes + letras
  dims.forEach(dim=>{
    const end = pt(dim,1);
    const line = document.createElementNS("http://www.w3.org/2000/svg","line");
    line.setAttribute("x1",cx); line.setAttribute("y1",cy);
    line.setAttribute("x2",end.x); line.setAttribute("y2",end.y);
    line.setAttribute("stroke","#c0c7c3");
    svg.appendChild(line);

    const lab = pt(dim,1.18);
    const text = document.createElementNS("http://www.w3.org/2000/svg","text");
    text.setAttribute("x",lab.x); text.setAttribute("y",lab.y);
    text.setAttribute("text-anchor","middle");
    text.setAttribute("alignment-baseline","middle");
    text.setAttribute("fill","#134E39");
    text.setAttribute("font-weight","800");
    text.textContent = dim;
    svg.appendChild(text);
  });

  // polígono
  const max = Math.max(values.D,values.I,values.S,values.C,1);
  const pts = dims.map(d=>pt(d, (values[d]/max)));
  const polyD = `M ${pts[0].x} ${pts[0].y} L ${pts[1].x} ${pts[1].y} L ${pts[2].x} ${pts[2].y} L ${pts[3].x} ${pts[3].y} Z`;
  const poly = document.createElementNS("http://www.w3.org/2000/svg","path");
  poly.setAttribute("d", polyD);
  poly.setAttribute("fill", fill);
  poly.setAttribute("stroke", stroke);
  poly.setAttribute("stroke-width","2");
  svg.appendChild(poly);
}

/* cuando se termina el test, si existen valores crudos, dibuja algo */
const _oldFinish = window.finishTest;
window.finishTest = function(){
  _oldFinish();
  const raw = computeRaw();
  drawDiamond("svgM", raw.M, "rgba(0,102,87,0.22)", "#006657");
  drawDiamond("svgL", raw.L, "rgba(188,149,92,0.22)", "#BC955C");
  drawDiamond("svgT", raw.T, "rgba(198,40,40,0.18)", "#c62828");
};

/* ================== SANITIZAR HTML ================== */
function escapeHtml(str){
  return String(str??"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ================== AUTO: cerrar modal con ESC ================== */
document.addEventListener("keydown",(e)=>{
  if(e.key==="Escape" && !$("overlay").classList.contains("hidden")){
    closeLogin();
  }
});
</script>
<!-- Firebase COMPAT (sin módulos) -->
<script src="https://www.gstatic.com/firebasejs/12.6.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore-compat.js"></script>

<script>
/* ================== FIREBASE / FIRESTORE ==================
   Importante: esto evita problemas de <script type="module">.
*/
const firebaseConfig = {
  apiKey: "AIzaSyDJniFUuRh3mfjP40cAm2gJ2P3TGOyKqog",
  authDomain: "perfil-de-dinamicas-laborales.firebaseapp.com",
  projectId: "perfil-de-dinamicas-laborales",
  storageBucket: "perfil-de-dinamicas-laborales.firebasestorage.app",
  messagingSenderId: "231363532636",
  appId: "1:231363532636:web:b610e5501cea73dce69399",
  measurementId: "G-R1X0PZ3WYY"
};

let fs = null;
try{
  firebase.initializeApp(firebaseConfig);
  fs = firebase.firestore();
  console.log("Firestore listo.");
}catch(e){
  console.warn("Firestore no disponible, se usará solo localStorage.", e);
}

/* ================== HELPERS ================== */
const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));

function normsLoaded(n){
  try{
    // si sigue en plantilla (A=0 y mult=1) lo consideramos NO cargado
    const isDefault =
      n?.A?.M?.D===0 && n?.A?.M?.I===0 && n?.A?.M?.S===0 && n?.A?.M?.C===0 &&
      n?.mult?.M?.D===1 && n?.mult?.M?.I===1 && n?.mult?.M?.S===1 && n?.mult?.M?.C===1;
    return !isDefault;
  }catch{ return false; }
}

function getNormsSafe(){
  return read(KEYS.norms, DEFAULT_NORMS);
}

/* ================== CONVERSIÓN A ESCALA G (manual) ==================
   G = (R - A) * múltiplo + 50
*/
function toG(graphKey, raw){
  const n = getNormsSafe();
  const out = {D:50,I:50,S:50,C:50};
  const has = normsLoaded(n);

  if(!has){
    // Modo aproximado SOLO visual (no psicométrico)
    ["D","I","S","C"].forEach(dim=>{
      const R = raw[dim] ?? 0;
      let g;
      if(graphKey==="T"){
        // T va de -24..+24
        g = 50 + (R/24)*35;
      }else{
        // M y L van 0..24
        g = 15 + (R/24)*70;
      }
      out[dim] = Math.round(clamp(g,0,100));
    });
    return {G:out, normas:false};
  }

  ["D","I","S","C"].forEach(dim=>{
    const R = raw[dim] ?? 0;
    const A = n.A?.[graphKey]?.[dim] ?? 0;
    const mult = n.mult?.[graphKey]?.[dim] ?? 1;
    const g = ((R - A) * mult) + 50;
    out[dim] = Math.round(clamp(g,0,100));
  });
  return {G:out, normas:true};
}

/* ================== GRÁFICA ROMBO REAL CON G (0-100) ================== */
function drawDiamondG(svgId, valuesG, fill, stroke){
  const svg = document.getElementById(svgId);
  if(!svg) return;
  svg.innerHTML = "";

  const cx=130, cy=110, radius=80;
  const dims=["D","I","S","C"];

  function pt(dim, factor){
    if(dim==="D") return {x:cx, y:cy-radius*factor};
    if(dim==="I") return {x:cx+radius*factor, y:cy};
    if(dim==="S") return {x:cx, y:cy+radius*factor};
    return {x:cx-radius*factor, y:cy}; // C
  }

  // Rejilla (25,50,75,100)
  [0.25,0.5,0.75,1].forEach((lvl,i)=>{
    const p = dims.map(d=>pt(d,lvl));
    const dPath = `M ${p[0].x} ${p[0].y} L ${p[1].x} ${p[1].y} L ${p[2].x} ${p[2].y} L ${p[3].x} ${p[3].y} Z`;
    const path = document.createElementNS("http://www.w3.org/2000/svg","path");
    path.setAttribute("d", dPath);
    path.setAttribute("fill","none");
    path.setAttribute("stroke", i===1 ? "#b9c4bf" : "#dde3df");
    path.setAttribute("stroke-width", i===1 ? "1.4" : "1");
    svg.appendChild(path);
  });

  // Ejes + letras
  dims.forEach(dim=>{
    const end = pt(dim,1);
    const axis = document.createElementNS("http://www.w3.org/2000/svg","line");
    axis.setAttribute("x1",cx); axis.setAttribute("y1",cy);
    axis.setAttribute("x2",end.x); axis.setAttribute("y2",end.y);
    axis.setAttribute("stroke","#c0c7c3");
    svg.appendChild(axis);

    const lab = pt(dim,1.18);
    const t = document.createElementNS("http://www.w3.org/2000/svg","text");
    t.setAttribute("x",lab.x); t.setAttribute("y",lab.y);
    t.setAttribute("text-anchor","middle");
    t.setAttribute("alignment-baseline","middle");
    t.setAttribute("fill","#134E39");
    t.setAttribute("font-weight","900");
    t.textContent = dim;
    svg.appendChild(t);
  });

  // Polígono con G/100
  const pts = dims.map(dim=>{
    const g = clamp(valuesG[dim] ?? 50, 0, 100);
    return pt(dim, g/100);
  });

  const polyD = `M ${pts[0].x} ${pts[0].y} L ${pts[1].x} ${pts[1].y} L ${pts[2].x} ${pts[2].y} L ${pts[3].x} ${pts[3].y} Z`;
  const poly = document.createElementNS("http://www.w3.org/2000/svg","path");
  poly.setAttribute("d", polyD);
  poly.setAttribute("fill", fill);
  poly.setAttribute("stroke", stroke);
  poly.setAttribute("stroke-width","2");
  svg.appendChild(poly);

  pts.forEach(p=>{
    const c = document.createElementNS("http://www.w3.org/2000/svg","circle");
    c.setAttribute("cx",p.x); c.setAttribute("cy",p.y);
    c.setAttribute("r","3.2");
    c.setAttribute("fill", stroke);
    svg.appendChild(c);
  });

  // Texto abajo
  const tick = document.createElementNS("http://www.w3.org/2000/svg","text");
  tick.setAttribute("x",cx); tick.setAttribute("y",cy+radius+28);
  tick.setAttribute("text-anchor","middle");
  tick.setAttribute("fill","#777");
  tick.setAttribute("font-size","12");
  tick.textContent = `G: D=${valuesG.D} I=${valuesG.I} S=${valuesG.S} C=${valuesG.C}`;
  svg.appendChild(tick);
}

/* ================== INTERPRETACIÓN Y CAPACITACIÓN (más profunda) ==================
   Nota: ya con G real (normas cargadas) la interpretación es confiable.
*/
function deepReport(valid, GM, GL, GT){
  if(!valid){
    return {
      analysis: `<div class="warn"><strong>Prueba inválida:</strong> ΣT fuera del rango aceptado. El manual recomienda repetir la aplicación en condiciones adecuadas (sin prisa, sin interrupciones, instrucciones claras).</div>`,
      training: `<p class="text-muted">No se sugiere capacitación basada en un perfil inválido. Reaplique el test.</p>`
    };
  }

  const names = {D:"Dominancia", I:"Influencia", S:"Estabilidad", C:"Cumplimiento"};
  const dims = ["D","I","S","C"];
  let top="D", topVal=GT.D;
  dims.forEach(d=>{ if(GT[d]>topVal){ top=d; topVal=GT[d]; } });

  const analysis = `
    <h3>Análisis (M / L / T en escala G)</h3>
    <p><span class="badge">Perfil predominante en T: ${names[top]} (${top})</span></p>

    <p><strong>Cómo leer estas gráficas:</strong></p>
    <ul class="text-muted">
      <li><strong>M (Motivación):</strong> lo que la persona busca expresar o desea en el rol.</li>
      <li><strong>L (Bajo presión):</strong> respuesta probable ante tensión, exigencia, urgencia o evaluación.</li>
      <li><strong>T (Conducta diaria):</strong> balance cotidiano (M − L) convertido a G.</li>
    </ul>

    <p class="text-muted"><strong>Valores G en T:</strong> D=${GT.D}, I=${GT.I}, S=${GT.S}, C=${GT.C}</p>

    <p><strong>Lectura del estilo predominante (${top}):</strong></p>
    ${
      top==="D" ? `
      <p>En conducta diaria destaca una orientación a resultados, decisión y ritmo alto. Suele tomar control en situaciones ambiguas y priorizar objetivos.</p>
      <p><strong>Riesgos típicos:</strong> impaciencia, comunicación muy directa, poca tolerancia a procesos lentos.</p>
      <p><strong>Señales en M/L:</strong> si M(D) es alto y L(D) baja, puede mostrar “empuje” en calma pero moderarse bajo presión; si L(D) sube, tiende a imponer control bajo estrés.</p>
      ` : ""
    }
    ${
      top==="I" ? `
      <p>Predomina un estilo social y comunicativo. Facilita coordinación, motivación del equipo y persuasión.</p>
      <p><strong>Riesgos típicos:</strong> dispersión, exceso de optimismo, seguimiento irregular si no hay estructura.</p>
      <p><strong>Señales en M/L:</strong> si L(I) cae, bajo presión puede retraerse o enfocarse menos en lo social; si L(I) sube, puede hablar más para influir o negociar.</p>
      ` : ""
    }
    ${
      top==="S" ? `
      <p>Destaca un estilo estable, paciente y orientado a continuidad. Es confiable en rutinas y sostiene el servicio con calma.</p>
      <p><strong>Riesgos típicos:</strong> resistencia al cambio, dificultad para confrontar o acelerar decisiones.</p>
      <p><strong>Señales en M/L:</strong> si L(S) sube, bajo presión busca estabilidad; si L(S) baja, puede perder paciencia o sentirse presionado por el ritmo.</p>
      ` : ""
    }
    ${
      top==="C" ? `
      <p>Predomina un estilo cuidadoso, analítico y orientado a normas/calidad. Tiende a reducir errores y a documentar.</p>
      <p><strong>Riesgos típicos:</strong> perfeccionismo, lentitud por análisis excesivo, estrés ante ambigüedad.</p>
      <p><strong>Señales en M/L:</strong> si L(C) sube, bajo presión controla más y exige precisión; si L(C) baja, podría simplificar o decidir con menos evidencia por urgencia.</p>
      ` : ""
    }

    <p><strong>Balance práctico (para jefatura):</strong></p>
    <ul class="text-muted">
      <li><strong>Qué lo activa (M):</strong> lo que motiva y aumenta desempeño.</li>
      <li><strong>Qué lo tensiona (L):</strong> condiciones donde cambia su conducta.</li>
      <li><strong>Qué observar (T):</strong> patrón cotidiano real.</li>
    </ul>
  `;

  const training = `
    <h3>Capacitación sugerida (según perfil T)</h3>
    ${
      top==="D" ? `
      <ul class="text-muted">
        <li><strong>Comunicación efectiva bajo presión:</strong> técnicas de mensaje breve, escucha activa, retroalimentación sin confrontación.</li>
        <li><strong>Toma de decisiones con evidencia:</strong> priorización clínica/operativa, matrices rápidas, control de sesgos.</li>
        <li><strong>Liderazgo colaborativo:</strong> delegación, acuerdos claros, seguimiento por indicadores.</li>
        <li><strong>Autogestión:</strong> manejo de impulsividad y tolerancia a ritmos distintos.</li>
      </ul>` : ""
    }
    ${
      top==="I" ? `
      <ul class="text-muted">
        <li><strong>Gestión del tiempo y foco:</strong> técnicas de priorización, listas operativas, cierres de compromisos.</li>
        <li><strong>Comunicación clínica/operativa estructurada:</strong> SBAR o formatos de pase de guardia.</li>
        <li><strong>Asertividad:</strong> límites, negociación y manejo de conversaciones difíciles.</li>
        <li><strong>Seguimiento:</strong> control de tareas y evidencias de cumplimiento.</li>
      </ul>` : ""
    }
    ${
      top==="S" ? `
      <ul class="text-muted">
        <li><strong>Adaptación al cambio:</strong> micro-hábitos, manejo de transición y aprendizaje gradual.</li>
        <li><strong>Comunicación asertiva:</strong> expresar necesidades, decir “no” con técnica, confrontación constructiva.</li>
        <li><strong>Mejora continua:</strong> participación en procesos, propuestas pequeñas de optimización.</li>
        <li><strong>Gestión emocional:</strong> resiliencia, autocuidado, prevención de desgaste.</li>
      </ul>` : ""
    }
    ${
      top==="C" ? `
      <ul class="text-muted">
        <li><strong>Priorización y rapidez con seguridad:</strong> distinguir “crítico vs perfecto”, umbrales de calidad.</li>
        <li><strong>Comunicación técnica efectiva:</strong> traducir datos a acciones, reportes breves.</li>
        <li><strong>Flexibilidad operativa:</strong> planes B, decisiones con información incompleta.</li>
        <li><strong>Manejo de estrés:</strong> reducir rumiación, técnicas de control del error.</li>
      </ul>` : ""
    }
    <p class="text-muted">Recomendación: combinar con observación del puesto y retroalimentación de supervisión.</p>
  `;

  return {analysis, training};
}

/* ================== REEMPLAZAR EL FINISH PARA CALCULAR G + GUARDAR MEJOR ================== */
const __finish = window.finishTest;
window.finishTest = function(){
  // valida y muestra results (usa lógica anterior)
  __finish();

  // Recalcula y “mejora” resultados con G + gráficas reales
  const raw = computeRaw();
  const sumT = raw.T.D+raw.T.I+raw.T.S+raw.T.C;
  const valid = sumT>=-3 && sumT<=3;

  const {G:GM, normas:nM} = toG("M", raw.M);
  const {G:GL, normas:nL} = toG("L", raw.L);
  const {G:GT, normas:nT} = toG("T", raw.T);

  // Dibuja rombo G real
  drawDiamondG("svgM", GM, "rgba(0,102,87,0.22)", "#006657");
  drawDiamondG("svgL", GL, "rgba(188,149,92,0.22)", "#BC955C");
  drawDiamondG("svgT", GT, "rgba(198,40,40,0.18)", "#c62828");

  // Mensaje de normas
  $("res-g").innerHTML = `
    <h3>Escala G (0–100)</h3>
    ${ (nM&&nL&&nT) ? "" : `<div class="warn"><strong>Normas no cargadas:</strong> escala G en modo aproximado. Cargue Normas en Admin para alineación exacta.</div>`}
    <p class="mono">G(M): D ${GM.D}, I ${GM.I}, S ${GM.S}, C ${GM.C}</p>
    <p class="mono">G(L): D ${GL.D}, I ${GL.I}, S ${GL.S}, C ${GL.C}</p>
    <p class="mono">G(T): D ${GT.D}, I ${GT.I}, S ${GT.S}, C ${GT.C}</p>
  `;

  // Reporte profundo
  const rep = deepReport(valid, GM, GL, GT);
  $("analysis").innerHTML = rep.analysis;
  $("training").innerHTML = rep.training;

  // Guardar “completo” en local (reemplaza el último registro para incluir G + datos faltantes)
  const arr = read(KEYS.results, []);
  if(arr.length){
    arr[arr.length-1] = {
      ...arr[arr.length-1],
      puesto: $("puesto").value || "",
      edad: $("edad").value || "",
      lugarNacimiento: $("lugarNacimiento").value || "",
      GM, GL, GT,
      normasCargadas: (nM&&nL&&nT)
    };
    save(KEYS.results, arr);
  }

  // Guardar en Firestore
  saveToCloudFull(arr[arr.length-1]);
};

/* ================== FIRESTORE: SINCRONIZACIÓN ================== */
async function saveToCloudConfig(){
  if(!fs) return;
  try{
    await fs.collection("config").doc("unidades").set({items: read(KEYS.units,[])});
    await fs.collection("config").doc("categorias").set({items: read(KEYS.cats,[])});
    await fs.collection("config").doc("normas").set(read(KEYS.norms, DEFAULT_NORMS));
  }catch(e){
    console.error("No se pudo guardar config en Firestore:", e);
  }
}

async function loadFromCloudConfig(){
  if(!fs) return;
  try{
    const u = await fs.collection("config").doc("unidades").get();
    const c = await fs.collection("config").doc("categorias").get();
    const n = await fs.collection("config").doc("normas").get();
    if(u.exists && Array.isArray(u.data().items)) save(KEYS.units, u.data().items);
    if(c.exists && Array.isArray(c.data().items)) save(KEYS.cats, c.data().items);
    if(n.exists) save(KEYS.norms, n.data());
    loadSelects();
    if(!$("section-admin").classList.contains("hidden")) loadAdmin();
  }catch(e){
    console.error("No se pudo cargar config de Firestore:", e);
  }
}

async function saveToCloudFull(record){
  if(!fs || !record) return;
  try{
    const ref = await fs.collection("pdl_resultados").add(record);
    // guardar id también localmente para poder eliminar en nube
    const arr = read(KEYS.results, []);
    arr[arr.length-1]._id = ref.id;
    save(KEYS.results, arr);
  }catch(e){
    console.error("No se pudo guardar resultado en Firestore:", e);
  }
}

async function loadCloudResults(){
  if(!fs) return null;
  try{
    const snap = await fs.collection("pdl_resultados").orderBy("date","desc").get();
    const list = [];
    snap.forEach(doc=> list.push({_id:doc.id, ...doc.data()}));
    return list;
  }catch(e){
    console.error("No se pudieron leer resultados en Firestore:", e);
    return null;
  }
}

/* Hook: cuando guardas unidades/categorías/normas, también a nube */
const _addUnit = window.addUnit;
window.addUnit = function(){ _addUnit(); saveToCloudConfig(); };

const _delUnit = window.delUnit;
window.delUnit = function(i){ _delUnit(i); saveToCloudConfig(); };

const _addCat = window.addCat;
window.addCat = function(){ _addCat(); saveToCloudConfig(); };

const _delCat = window.delCat;
window.delCat = function(i){ _delCat(i); saveToCloudConfig(); };

const _saveNorms = window.saveNorms;
window.saveNorms = function(){ _saveNorms(); saveToCloudConfig(); };

/* ================== RESULTADOS ADMIN: CARGA DESDE NUBE SI EXISTE ================== */
const _renderResults = renderResults;
renderResults = async function(){
  const cloud = await loadCloudResults();
  if(cloud && cloud.length){
    // reflejar en localStorage para exportar fácil
    save(KEYS.results, cloud.slice().reverse()); // guardo en orden antiguo
  }
  _renderResults();
};

/* Eliminar: también en nube si tiene _id */
const _deleteResult = window.deleteResult;
window.deleteResult = async function(i){
  const data = read(KEYS.results, []);
  const rec = data[i];
  _deleteResult(i);
  if(fs && rec && rec._id){
    try{ await fs.collection("pdl_resultados").doc(rec._id).delete(); }
    catch(e){ console.error("No se pudo borrar en Firestore:", e); }
  }
};

/* ================== NORMAS “FÁCIL” (SIN JSON) ==================
   Agrego un botón “Capturar normas fácil” dentro del panel de Normas
   para que pegues números por línea: D,I,S,C
*/
(function injectEasyNormsUI(){
  const panel = $("panel-n");
  if(!panel) return;

  const box = document.createElement("div");
  box.className = "warn";
  box.innerHTML = `
    <strong>Captura fácil (sin JSON):</strong><br>
    Pega 4 números separados por coma en cada línea (D,I,S,C).<br>
    <span class="text-muted">Ejemplo: 3,5,8,2</span><br><br>

    <div class="text-muted"><strong>Promedios A</strong></div>
    <div class="form-grid" style="margin-top:.4rem;">
      <div><label>A M</label><input id="easyA_M" placeholder="D,I,S,C"></div>
      <div><label>A L</label><input id="easyA_L" placeholder="D,I,S,C"></div>
      <div><label>A T</label><input id="easyA_T" placeholder="D,I,S,C"></div>
    </div>

    <div class="text-muted" style="margin-top:.6rem;"><strong>Múltiplos</strong></div>
    <div class="form-grid" style="margin-top:.4rem;">
      <div><label>Mult M</label><input id="easyM_M" placeholder="D,I,S,C"></div>
      <div><label>Mult L</label><input id="easyM_L" placeholder="D,I,S,C"></div>
      <div><label>Mult T</label><input id="easyM_T" placeholder="D,I,S,C"></div>
    </div>

    <div class="btn-row">
      <button class="btn-primary" type="button" onclick="applyEasyNorms()">Aplicar y guardar</button>
    </div>
  `;
  panel.insertBefore(box, panel.firstChild);

  window.applyEasyNorms = function(){
    function parse4(id){
      const s = (document.getElementById(id).value||"").trim();
      const parts = s.split(",").map(x=>Number(x.trim()));
      if(parts.length!==4 || parts.some(x=>Number.isNaN(x))) throw new Error("Formato inválido en "+id);
      return {D:parts[0], I:parts[1], S:parts[2], C:parts[3]};
    }
    try{
      const obj = {
        version: 1,
        A: { M: parse4("easyA_M"), L: parse4("easyA_L"), T: parse4("easyA_T") },
        mult: { M: parse4("easyM_M"), L: parse4("easyM_L"), T: parse4("easyM_T") }
      };
      save(KEYS.norms, obj);
      $("norms").value = JSON.stringify(obj,null,2);
      alert("Normas aplicadas.");
      saveToCloudConfig();
    }catch(e){
      alert(e.message);
    }
  };
})();

/* ================== ARRANQUE: TRAER CONFIG DE NUBE ================== */
loadFromCloudConfig();
</script>

</main>
</body>
</html>


